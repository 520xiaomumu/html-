<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebOS - 网页版操作系统</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: background-image 0.7s ease;
        }
        .window {
            transition: opacity 0.2s, transform 0.2s;
        }
        .window.minimized {
            transform: scale(0.8) translateY(100px);
            opacity: 0;
            pointer-events: none;
        }
        .taskbar-blur {
            backdrop-filter: blur(20px) saturate(180%);
        }
        .start-menu-animation {
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp {
            from { transform: translate(-50%, 20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="h-screen w-screen bg-cover bg-center select-none" style="background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&q=80&w=1964');">

    <!-- 桌面图标 -->
    <div class="absolute top-6 left-6 grid grid-flow-row gap-6 z-0" id="desktop-icons">
        <!-- 动态生成 -->
    </div>

    <!-- 窗口容器 -->
    <div id="window-container" class="relative w-full h-full pointer-events-none z-10">
        <!-- 窗口将在此动态生成 -->
    </div>

    <!-- 开始菜单 -->
    <div id="start-menu" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/5 hidden" onclick="toggleStartMenu()">
        <div class="absolute bottom-16 left-1/2 -translate-x-1/2 w-[600px] h-[650px] bg-slate-900/90 backdrop-blur-3xl rounded-2xl border border-white/10 shadow-2xl p-8 flex flex-col start-menu-animation" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-white text-lg font-semibold">已固定的应用</h2>
                <button class="text-xs text-white/50 bg-white/10 px-3 py-1.5 rounded-lg hover:bg-white/20 transition-colors">所有应用 &gt;</button>
            </div>
            
            <div id="pinned-apps" class="grid grid-cols-6 gap-6 mb-12">
                <!-- 动态生成 -->
            </div>

            <div class="mt-auto flex items-center justify-between p-4 bg-black/40 rounded-xl border border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-white border border-white/20 shadow-lg">
                        <i data-lucide="user"></i>
                    </div>
                    <div>
                        <p class="text-white text-sm font-semibold leading-none">访客用户</p>
                        <p class="text-white/40 text-[10px] mt-1 uppercase tracking-wider">系统管理员</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button class="text-white/60 hover:text-white transition-colors" title="搜索"><i data-lucide="search" class="w-5 h-5"></i></button>
                    <button class="text-white/60 hover:text-white transition-colors" title="重启系统" onclick="location.reload()"><i data-lucide="monitor" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务栏 -->
    <div class="fixed bottom-0 left-0 right-0 h-12 bg-slate-900/80 taskbar-blur flex items-center px-4 z-[100] border-t border-white/10">
        <div class="flex-1 flex items-center">
            <button onclick="toggleStartMenu()" class="group h-10 w-10 flex items-center justify-center rounded-lg transition-all duration-300 hover:bg-white/10" id="start-btn">
                <div class="grid grid-cols-2 gap-0.5 group-hover:scale-110 transition-transform">
                    <div class="w-1.5 h-1.5 bg-blue-500 rounded-[2px]"></div>
                    <div class="w-1.5 h-1.5 bg-blue-400 rounded-[2px]"></div>
                    <div class="w-1.5 h-1.5 bg-blue-400 rounded-[2px]"></div>
                    <div class="w-1.5 h-1.5 bg-blue-300 rounded-[2px]"></div>
                </div>
            </button>
            <div class="ml-3 relative hidden sm:block">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-white/40 w-3.5 h-3.5"></i>
                <div class="bg-white/10 hover:bg-white/15 transition-colors rounded-full pl-9 pr-4 py-1.5 text-[11px] text-white/80 w-44 border border-white/5 cursor-text">
                    输入内容以搜索...
                </div>
            </div>
        </div>

        <div class="flex items-center gap-1" id="taskbar-apps">
            <!-- 动态生成 -->
        </div>

        <div class="flex-1 flex items-center justify-end gap-4 text-white/90">
            <div class="hidden lg:flex items-center gap-3 opacity-70">
                 <i data-lucide="wifi" class="w-3.5 h-3.5"></i>
                 <i data-lucide="volume-2" class="w-3.5 h-3.5"></i>
                 <i data-lucide="battery" class="w-3.5 h-3.5 rotate-90"></i>
            </div>
            <div class="flex flex-col items-end cursor-pointer hover:bg-white/10 px-2 py-0.5 rounded-md transition-colors leading-tight" id="tray-clock">
                <span class="text-[11px] font-bold" id="clock-time">00:00</span>
                <span class="text-[9px] opacity-60 font-medium" id="clock-date">2025/1/1</span>
            </div>
            <div class="h-full w-px bg-white/10 mx-1"></div>
            <div class="w-1.5 h-10 hover:bg-white/15 rounded-sm transition-colors cursor-default" title="显示桌面" onclick="minimizeAll()"></div>
        </div>
    </div>

    <script>
        // --- 核心配置 ---
        const APPS = {
            EXPLORER: { name: '资源管理器', icon: 'folder', color: 'text-blue-500', initialSize: { w: 700, h: 450 } },
            NOTEPAD: { name: '记事本', icon: 'file-text', color: 'text-blue-400', initialSize: { w: 500, h: 500 } },
            CALC: { name: '计算器', icon: 'calculator', color: 'text-orange-500', initialSize: { w: 320, h: 480 } },
            TERMINAL: { name: '终端', icon: 'terminal', color: 'text-emerald-500', initialSize: { w: 600, h: 400 } },
            EDGE: { name: '浏览器', icon: 'globe', color: 'text-blue-600', initialSize: { w: 850, h: 550 } },
            SETTINGS: { name: '设置', icon: 'settings', color: 'text-slate-500', initialSize: { w: 600, h: 600 } }
        };

        const WALLPAPERS = [
            'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?auto=format&fit=crop&q=80&w=2070',
            'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&q=80&w=1964',
            'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?auto=format&fit=crop&q=80&w=2070',
            'https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&q=80&w=2029',
            'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&q=80&w=2070'
        ];

        let state = {
            openWindows: {}, // { id: { app, isMaximized, isMinimized, zIndex, pos, size } }
            activeWindow: null,
            zIndexCounter: 10,
            isStartOpen: false
        };

        // --- 初始化 ---
        function init() {
            renderDesktop();
            renderStartMenu();
            updateClock();
            setInterval(updateClock, 1000);
            lucide.createIcons();
        }

        // --- 时钟更新 ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-date').textContent = now.toLocaleDateString('zh-CN');
        }

        // --- 桌面渲染 ---
        function renderDesktop() {
            const desktop = document.getElementById('desktop-icons');
            const icons = [
                { id: 'EXPLORER', label: '此电脑', icon: 'folder', color: 'text-blue-400' },
                { id: 'EDGE', label: '浏览器', icon: 'globe', color: 'text-blue-600' },
                { id: 'NOTEPAD', label: '说明文档.txt', icon: 'file-text', color: 'text-white' },
                { id: 'SETTINGS', label: '系统设置', icon: 'settings', color: 'text-slate-300' }
            ];

            desktop.innerHTML = icons.map(i => `
                <div class="w-20 p-2 flex flex-col items-center gap-1.5 rounded-lg hover:bg-white/10 cursor-default transition-all group active:scale-95" ondblclick="openApp('${i.id}')">
                    <div class="p-1 transition-transform group-hover:scale-110 drop-shadow-md ${i.color}">
                        <i data-lucide="${i.icon}" class="w-9 h-9"></i>
                    </div>
                    <span class="text-[10px] text-white text-center font-semibold drop-shadow-[0_1.2px_1.2px_rgba(0,0,0,0.8)] px-1 truncate w-full">
                        ${i.label}
                    </span>
                </div>
            `).join('');
        }

        function renderStartMenu() {
            const container = document.getElementById('pinned-apps');
            container.innerHTML = Object.entries(APPS).map(([id, app]) => `
                <button onclick="openApp('${id}')" class="flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-white/10 transition-all group active:scale-90">
                    <div class="transform transition-transform group-hover:scale-110 drop-shadow-md ${app.color}">
                        <i data-lucide="${app.icon}" class="w-7 h-7"></i>
                    </div>
                    <span class="text-[11px] text-white/90 font-medium">${app.name}</span>
                </button>
            `).join('');
        }

        // --- 窗口管理逻辑 ---
        function openApp(appId) {
            if (state.openWindows[appId]) {
                if (state.openWindows[appId].isMinimized) {
                    state.openWindows[appId].isMinimized = false;
                    document.getElementById(`win-${appId}`).classList.remove('minimized');
                }
                focusWindow(appId);
            } else {
                const config = APPS[appId];
                state.openWindows[appId] = {
                    appId,
                    isMaximized: false,
                    isMinimized: false,
                    zIndex: ++state.zIndexCounter,
                    pos: { x: 100 + (Object.keys(state.openWindows).length * 30), y: 50 + (Object.keys(state.openWindows).length * 30) },
                    size: { w: config.initialSize.w, h: config.initialSize.h }
                };
                createWindowElement(appId);
                focusWindow(appId);
            }
            updateTaskbar();
            toggleStartMenu(false);
        }

        function createWindowElement(appId) {
            const winData = state.openWindows[appId];
            const appConfig = APPS[appId];
            const container = document.getElementById('window-container');

            const win = document.createElement('div');
            win.id = `win-${appId}`;
            win.className = `window fixed pointer-events-auto flex flex-col overflow-hidden bg-white/80 dark:bg-slate-900/80 backdrop-blur-2xl rounded-xl border border-white/20 shadow-2xl`;
            win.style.left = winData.pos.x + 'px';
            win.style.top = winData.pos.y + 'px';
            win.style.width = winData.size.w + 'px';
            win.style.height = winData.size.h + 'px';
            win.style.zIndex = winData.zIndex;
            win.onmousedown = () => focusWindow(appId);

            win.innerHTML = `
                <div class="h-10 flex items-center justify-between px-3 select-none cursor-default bg-white/30 dark:bg-slate-800/30 border-b border-white/10 win-titlebar" 
                     onmousedown="startDrag(event, '${appId}')" ondblclick="toggleMaximize('${appId}')">
                    <div class="flex items-center gap-2">
                        <i data-lucide="${appConfig.icon}" class="w-4 h-4 ${appConfig.color}"></i>
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200">${appConfig.name}</span>
                    </div>
                    <div class="flex items-center gap-1 pointer-events-auto">
                        <button onclick="minimizeWindow('${appId}')" class="p-2 hover:bg-slate-200/50 dark:hover:bg-slate-700/50 rounded transition-colors"><i data-lucide="minus" class="w-3.5 h-3.5"></i></button>
                        <button onclick="toggleMaximize('${appId}')" class="p-2 hover:bg-slate-200/50 dark:hover:bg-slate-700/50 rounded transition-colors"><i data-lucide="square" class="w-3 h-3"></i></button>
                        <button onclick="closeWindow('${appId}')" class="p-2 hover:bg-red-500 hover:text-white rounded transition-colors"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto bg-transparent relative" id="content-${appId}">
                    ${getAppContent(appId)}
                </div>
            `;

            container.appendChild(win);
            lucide.createIcons();
            if (appId === 'TERMINAL') initTerminal(appId);
            if (appId === 'CALC') initCalculator(appId);
        }

        function focusWindow(appId) {
            if (state.activeWindow === appId) return;
            state.activeWindow = appId;
            state.zIndexCounter++;
            state.openWindows[appId].zIndex = state.zIndexCounter;
            
            const win = document.getElementById(`win-${appId}`);
            if (win) {
                win.style.zIndex = state.zIndexCounter;
                // 移除其他窗口的活跃状态边框
                document.querySelectorAll('.window').forEach(w => w.classList.remove('ring-1', 'ring-blue-500/50', 'scale-[1.002]'));
                win.classList.add('ring-1', 'ring-blue-500/50', 'scale-[1.002]');
            }
            updateTaskbar();
        }

        function closeWindow(appId) {
            const win = document.getElementById(`win-${appId}`);
            if (win) win.remove();
            delete state.openWindows[appId];
            if (state.activeWindow === appId) state.activeWindow = null;
            updateTaskbar();
        }

        function minimizeWindow(appId) {
            const win = document.getElementById(`win-${appId}`);
            win.classList.add('minimized');
            state.openWindows[appId].isMinimized = true;
            state.activeWindow = null;
            updateTaskbar();
        }

        function toggleMaximize(appId) {
            const win = document.getElementById(`win-${appId}`);
            const winData = state.openWindows[appId];
            if (winData.isMaximized) {
                win.style.width = winData.size.w + 'px';
                win.style.height = winData.size.h + 'px';
                win.style.top = winData.pos.y + 'px';
                win.style.left = winData.pos.x + 'px';
                win.classList.remove('rounded-none');
                win.classList.add('rounded-xl');
            } else {
                win.style.width = '100%';
                win.style.height = 'calc(100% - 48px)';
                win.style.top = '0';
                win.style.left = '0';
                win.classList.remove('rounded-xl');
                win.classList.add('rounded-none');
            }
            winData.isMaximized = !winData.isMaximized;
        }

        function minimizeAll() {
            Object.keys(state.openWindows).forEach(id => minimizeWindow(id));
        }

        // --- 拖动逻辑 ---
        let dragInfo = null;
        function startDrag(e, appId) {
            if (state.openWindows[appId].isMaximized) return;
            const win = document.getElementById(`win-${appId}`);
            dragInfo = {
                appId,
                startX: e.clientX - win.offsetLeft,
                startY: e.clientY - win.offsetTop
            };
            window.addEventListener('mousemove', handleDrag);
            window.addEventListener('mouseup', stopDrag);
        }

        function handleDrag(e) {
            if (!dragInfo) return;
            const win = document.getElementById(`win-${dragInfo.appId}`);
            const newX = e.clientX - dragInfo.startX;
            const newY = e.clientY - dragInfo.startY;
            win.style.left = newX + 'px';
            win.style.top = newY + 'px';
            state.openWindows[dragInfo.appId].pos = { x: newX, y: newY };
        }

        function stopDrag() {
            dragInfo = null;
            window.removeEventListener('mousemove', handleDrag);
            window.removeEventListener('mouseup', stopDrag);
        }

        // --- 应用 UI 获取 ---
        function getAppContent(appId) {
            switch(appId) {
                case 'EXPLORER':
                    return `<div class="p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 text-slate-800 dark:text-slate-200">
                        ${['文档', '下载', '音乐', '图片', '视频', '本地磁盘 (C:)'].map(f => `
                            <div class="flex flex-col items-center gap-2 p-4 rounded-lg hover:bg-white/20 dark:hover:bg-slate-800/40 cursor-pointer transition-all hover:scale-105 border border-transparent hover:border-white/10">
                                <i data-lucide="folder" class="w-12 h-12 text-blue-500 fill-blue-500/20"></i>
                                <span class="text-xs font-medium text-center truncate w-full">${f}</span>
                            </div>
                        `).join('')}
                    </div>`;
                case 'NOTEPAD':
                    return `<textarea class="w-full h-full p-6 bg-transparent outline-none resize-none text-slate-800 dark:text-slate-200 font-mono text-sm leading-relaxed" spellcheck="false">欢迎使用 WebOS 记事本。\n\n在这里记录您的想法。在这个预览版本中，笔记存储在内存中。\n\n系统核心特性：\n- 可拖动窗口系统\n- 多任务状态栏\n- 实时系统时钟\n- 流畅设计界面</textarea>`;
                case 'CALC':
                    return `<div id="calc-${appId}" class="p-4 flex flex-col h-full gap-4">
                        <div class="bg-white/10 dark:bg-slate-800/30 p-4 rounded-lg text-right border border-white/5">
                            <div class="text-xs text-slate-500 h-4 calc-eqn"></div>
                            <div class="text-3xl font-semibold dark:text-white truncate calc-display">0</div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 flex-1 calc-btns">
                            <!-- 按钮将由 JS 挂载事件 -->
                        </div>
                    </div>`;
                case 'TERMINAL':
                    return `<div class="h-full bg-slate-950 text-emerald-400 font-mono p-4 overflow-auto text-sm selection:bg-emerald-400/30 terminal-body">
                        <div class="terminal-history">WebOS 内核版本 1.0.0 (x64)\n输入 "help" 查看可用命令。</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-emerald-500 font-bold">user@web-os:~$</span>
                            <input class="bg-transparent outline-none border-none flex-1 text-white terminal-input" />
                        </div>
                    </div>`;
                case 'EDGE':
                    return `<div class="flex flex-col h-full bg-white">
                        <div class="bg-slate-100 p-2 flex items-center gap-2 border-b">
                            <div class="flex items-center gap-1.5 ml-2">
                                <div class="w-2.5 h-2.5 rounded-full bg-red-400"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-yellow-400"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-green-400"></div>
                            </div>
                            <div class="flex-1 max-w-2xl bg-white rounded-full border px-4 py-1 text-xs text-slate-600 flex items-center gap-2 shadow-sm">
                                <i data-lucide="globe" class="w-3 h-3 text-blue-500"></i>
                                <span>https://www.google.com</span>
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center text-slate-400 bg-slate-50">
                            <div class="p-8 rounded-full bg-blue-50 mb-4 animate-pulse">
                                <i data-lucide="globe" class="w-12 h-12 text-blue-500"></i>
                            </div>
                            <p class="text-sm font-medium text-slate-600">安全浏览器</p>
                            <p class="text-xs max-w-xs text-center mt-2 px-4">在此预览环境中，外部浏览受到限制，但内部功能模块运行正常。</p>
                        </div>
                    </div>`;
                case 'SETTINGS':
                    return `<div class="p-8 flex flex-col gap-8 text-slate-800 dark:text-slate-200">
                        <section>
                            <div class="flex items-center gap-2 mb-4">
                                <i data-lucide="layout" class="text-blue-500 w-5 h-5"></i>
                                <h3 class="text-lg font-semibold">个性化设置</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                ${WALLPAPERS.map((wp, i) => `
                                    <div onclick="setWallpaper('${wp}')" class="aspect-video rounded-xl overflow-hidden border-4 border-white/20 hover:border-blue-500 cursor-pointer transition-all hover:scale-105 shadow-lg">
                                        <img src="${wp}" class="w-full h-full object-cover">
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                        <div class="h-px bg-slate-200 dark:bg-slate-700"></div>
                        <section>
                            <div class="flex items-center gap-2 mb-4"><i data-lucide="monitor" class="text-purple-500 w-5 h-5"></i><h3 class="text-lg font-semibold">系统信息</h3></div>
                            <div class="space-y-2">
                                <div class="flex justify-between p-3 bg-slate-100/50 dark:bg-slate-800/50 rounded-lg"><span>版本</span><span>WebOS 2025 Stable</span></div>
                                <div class="flex justify-between p-3 bg-slate-100/50 dark:bg-slate-800/50 rounded-lg"><span>内核</span><span>Vanilla JS v1.0</span></div>
                            </div>
                        </section>
                    </div>`;
                default: return '';
            }
        }

        // --- 任务栏更新 ---
        function updateTaskbar() {
            const container = document.getElementById('taskbar-apps');
            container.innerHTML = Object.entries(APPS).map(([id, app]) => {
                const isOpen = state.openWindows[id];
                const isActive = state.activeWindow === id;
                if (!isOpen) return '';
                return `
                    <button onclick="openApp('${id}')" 
                            class="relative w-10 h-10 flex items-center justify-center rounded-lg group transition-all duration-200 ${isActive ? 'bg-white/15 shadow-inner' : 'hover:bg-white/10'}">
                        <div class="transform transition-transform group-hover:scale-110 group-active:scale-90 ${app.color}">
                            <i data-lucide="${app.icon}" class="w-5 h-5"></i>
                        </div>
                        <div class="absolute bottom-0.5 left-1/2 -translate-x-1/2 h-[3px] rounded-full bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,0.6)] transition-all ${isActive ? 'w-4' : 'w-1'}"></div>
                    </button>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- UI 操作 ---
        function toggleStartMenu(force) {
            const menu = document.getElementById('start-menu');
            state.isStartOpen = force !== undefined ? force : !state.isStartOpen;
            if (state.isStartOpen) menu.classList.remove('hidden');
            else menu.classList.add('hidden');
        }

        function setWallpaper(url) {
            document.body.style.backgroundImage = `url('${url}')`;
        }

        // --- 应用专用逻辑: 计算器 ---
        function initCalculator(id) {
            const container = document.querySelector(`#calc-${id} .calc-btns`);
            const display = document.querySelector(`#calc-${id} .calc-display`);
            const eqn = document.querySelector(`#calc-${id} .calc-eqn`);
            const buttons = [
                'C', '/', '*', '-',
                '7', '8', '9', '+',
                '4', '5', '6', '=',
                '1', '2', '3', '0', '.'
            ];

            let val = '0', prev = null, op = null, reset = false;

            const btnClass = "h-12 flex items-center justify-center rounded-lg bg-white/20 dark:bg-slate-800/40 hover:bg-white/40 dark:hover:bg-slate-700/60 transition-all font-medium border border-white/10 active:scale-95";

            container.innerHTML = buttons.map(b => {
                let cls = btnClass;
                if (b === 'C') cls += " text-red-500";
                if (b === '=') cls += " row-span-3 h-full bg-blue-600 text-white hover:bg-blue-700 font-bold";
                if (b === '0') cls += " col-span-2";
                return `<button class="${cls}" data-val="${b}">${b}</button>`;
            }).join('');

            container.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => {
                    const b = btn.dataset.val;
                    if (!isNaN(b) || b === '.') {
                        if (reset) { val = b; reset = false; }
                        else val = val === '0' ? b : val + b;
                    } else if (b === 'C') {
                        val = '0'; prev = null; op = null; eqn.textContent = '';
                    } else if (b === '=') {
                        if (op && prev !== null) {
                            val = String(evalCalc(prev, parseFloat(val), op));
                            prev = null; op = null; eqn.textContent = ''; reset = true;
                        }
                    } else {
                        prev = parseFloat(val); op = b; eqn.textContent = `${prev} ${op}`; reset = true;
                    }
                    display.textContent = val;
                };
            });

            function evalCalc(a, b, o) {
                if (o === '+') return a + b;
                if (o === '-') return a - b;
                if (o === '*') return a * b;
                if (o === '/') return b !== 0 ? a / b : '错误';
                return b;
            }
        }

        // --- 应用专用逻辑: 终端 ---
        function initTerminal(id) {
            const input = document.querySelector(`#win-${id} .terminal-input`);
            const history = document.querySelector(`#win-${id} .terminal-history`);
            
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    const cmd = input.value.trim().toLowerCase();
                    let res = '';
                    if (cmd === 'help') res = '可用命令: help, date, clear, whoami, ls, neofetch';
                    else if (cmd === 'date') res = new Date().toLocaleString('zh-CN');
                    else if (cmd === 'clear') { history.textContent = ''; input.value = ''; return; }
                    else if (cmd === 'whoami') res = 'guest@web-os';
                    else if (cmd === 'ls') res = '文档  下载  音乐  图片  视频';
                    else if (cmd === 'neofetch') res = '系统: WebOS JS-Kernel\n环境: 浏览器';
                    else res = `命令未找到: ${cmd}`;

                    history.textContent += `\nuser@web-os:~$ ${input.value}\n${res}`;
                    input.value = '';
                    history.parentElement.scrollTop = history.parentElement.scrollHeight;
                }
            };
        }

        window.onload = init;
    </script>
</body>
</html>