<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²’å­ç”Ÿå‘½ (Particle Life) - æ—¶é—´æ§åˆ¶ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }
        canvas {
            display: block;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
        .glass-panel {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .slider-thumb {
            -webkit-appearance: none; appearance: none;
            height: 4px; background: #444; outline: none; opacity: 0.8;
            transition: opacity .2s; border-radius: 2px;
        }
        .slider-thumb:hover { opacity: 1; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 14px; height: 14px; background: #4ade80;
            cursor: pointer; border-radius: 50%; border: 2px solid #222;
        }
        .slider-thumb.red::-webkit-slider-thumb { background: #ff5555; }
        .slider-thumb.green::-webkit-slider-thumb { background: #55ff55; }
        .slider-thumb.blue::-webkit-slider-thumb { background: #5555ff; }
        .slider-thumb.yellow::-webkit-slider-thumb { background: #ffff55; }
        .slider-thumb.time::-webkit-slider-thumb { background: #f472b6; width: 16px; height: 16px; }
        
        .matrix-cell input { transform: scale(0.85); background: #111; border-color: #333; }
        .matrix-cell input:focus { border-color: #4ade80; }
    </style>
</head>
<body class="flex h-screen w-screen">

    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="glass-panel w-80 h-full flex flex-col p-5 overflow-y-auto shrink-0 z-10 shadow-2xl border-r border-gray-800">
        <h1 class="text-2xl font-bold mb-1 text-white flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#22c55e]"></span>
            ç²’å­ç”Ÿå‘½ <span class="text-xs font-normal text-gray-500 mt-1">v2.0</span>
        </h1>
        <p class="text-xs text-gray-400 mb-6">ç‰©ç†å¼•æ“ 1:1 å¤åˆ» + æ—¶é—´æ§åˆ¶</p>

        <!-- å…¨å±€æ§åˆ¶ -->
        <div class="mb-6 space-y-3">
            <button id="btn-randomize" class="w-full py-2.5 px-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-lg font-bold shadow-lg shadow-indigo-900/20 transition-all active:scale-95 text-sm tracking-wide">
                ğŸ² éšæœºç”Ÿæˆè§„åˆ™
            </button>
            <div class="flex gap-2">
                <button id="btn-reset" class="flex-1 py-1.5 px-3 bg-gray-700 hover:bg-gray-600 rounded text-xs transition border border-gray-600">é‡ç½®ç”»å¸ƒ</button>
                <button id="btn-pause" class="flex-1 py-1.5 px-3 bg-gray-700 hover:bg-gray-600 rounded text-xs transition border border-gray-600">æš‚åœ/ç»§ç»­</button>
            </div>
        </div>

        <hr class="border-gray-800 mb-6">
        
        <!-- æ—¶é—´æ§åˆ¶ (æ–°å¢) -->
        <div class="mb-6 bg-gray-800/50 p-3 rounded-lg border border-gray-700/50">
            <h3 class="text-xs font-bold text-pink-400 mb-3 uppercase tracking-wider flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                æ—¶é—´é€Ÿç‡ (Time Scale)
            </h3>
            <div class="flex flex-col gap-1">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-[10px] text-gray-500">æ…¢æ”¾</span>
                    <span id="val-time" class="text-xl font-mono text-pink-400 font-bold">1.0x</span>
                    <span class="text-[10px] text-gray-500">å¿«è¿›</span>
                </div>
                <!-- Logarithmic slider feel implementation in JS -->
                <input type="range" id="param-time" min="1" max="50" value="10" class="slider-thumb time w-full">
                <div class="flex justify-between text-[10px] text-gray-600 mt-1">
                    <span>0.1x</span>
                    <span>1.0x</span>
                    <span>5.0x</span>
                </div>
            </div>
            <p class="text-[10px] text-gray-500 mt-2 leading-tight">
                * è°ƒèŠ‚é€Ÿç‡ä¸ä¼šæ”¹å˜ç²’å­è¿åŠ¨è½¨è¿¹ï¼Œä»…æ”¹å˜è§‚æµ‹é€Ÿåº¦ã€‚æ…¢æ”¾æ—¶åŒ…å«çº¿æ€§æ’å€¼ä»¥ä¿è¯ä¸æ»‘ã€‚
            </p>
        </div>

        <hr class="border-gray-800 mb-6">

        <!-- ç²’å­æ•°é‡ -->
        <div class="mb-6">
            <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">ç²’å­æ•°é‡</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between group">
                    <label class="text-xs text-red-400 font-medium group-hover:text-red-300 transition">çº¢è‰²</label>
                    <input type="range" id="count-red" min="0" max="1000" value="200" class="slider-thumb red w-28">
                    <span id="val-red" class="text-xs w-8 text-right font-mono text-gray-400">200</span>
                </div>
                <div class="flex items-center justify-between group">
                    <label class="text-xs text-green-400 font-medium group-hover:text-green-300 transition">ç»¿è‰²</label>
                    <input type="range" id="count-green" min="0" max="1000" value="200" class="slider-thumb green w-28">
                    <span id="val-green" class="text-xs w-8 text-right font-mono text-gray-400">200</span>
                </div>
                <div class="flex items-center justify-between group">
                    <label class="text-xs text-blue-400 font-medium group-hover:text-blue-300 transition">è“è‰²</label>
                    <input type="range" id="count-blue" min="0" max="1000" value="200" class="slider-thumb blue w-28">
                    <span id="val-blue" class="text-xs w-8 text-right font-mono text-gray-400">200</span>
                </div>
                <div class="flex items-center justify-between group">
                    <label class="text-xs text-yellow-400 font-medium group-hover:text-yellow-300 transition">é»„è‰²</label>
                    <input type="range" id="count-yellow" min="0" max="1000" value="200" class="slider-thumb yellow w-28">
                    <span id="val-yellow" class="text-xs w-8 text-right font-mono text-gray-400">200</span>
                </div>
            </div>
        </div>

        <!-- äº¤äº’è§„åˆ™çŸ©é˜µ -->
        <div class="mb-6">
            <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider flex justify-between items-center">
                <span>äº¤äº’åŠ› G</span>
                <span class="text-[10px] text-gray-600 normal-case">è¡Œ:å—åŠ› / åˆ—:æ–½åŠ›</span>
            </h3>
            
            <div class="grid grid-cols-5 gap-1 mb-1 text-center text-[10px] font-bold opacity-80">
                <div></div>
                <div class="text-red-500">çº¢</div>
                <div class="text-green-500">ç»¿</div>
                <div class="text-blue-500">è“</div>
                <div class="text-yellow-500">é»„</div>
            </div>

            <div id="rules-matrix" class="grid grid-cols-5 gap-1 text-xs items-center"></div>
        </div>

        <!-- ç‰©ç†å‚æ•° -->
        <div class="mt-auto">
            <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">ç‰©ç†ç¯å¢ƒ</h3>
            <div class="flex flex-col">
                <div class="flex justify-between mb-1">
                    <label class="text-xs text-gray-500">äº¤äº’åŠå¾„</label>
                    <span id="val-range" class="text-xs font-mono text-gray-400">80</span>
                </div>
                <input type="range" id="param-range" min="10" max="200" value="80" class="slider-thumb w-full">
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆç”»å¸ƒ -->
    <div class="flex-1 relative bg-black cursor-crosshair overflow-hidden">
        <canvas id="gameCanvas" class="absolute inset-0 block touch-none"></canvas>
        
        <!-- HUD -->
        <div class="absolute top-4 right-6 text-right pointer-events-none select-none space-y-1">
            <div class="text-xs text-gray-500 font-mono tracking-wider">FPS: <span id="fps-counter" class="text-white font-bold">60</span></div>
            <div class="text-xs text-gray-500 font-mono tracking-wider">Part: <span id="total-particles" class="text-white">0</span></div>
            <div class="text-[10px] text-gray-600 font-mono mt-2 opacity-50">LEFT CLICK: REPEL PULSE</div>
        </div>
    </div>

    <script>
        /**
         * ç²’å­ç”Ÿå‘½ (Particle Life) 2.0 - æ—¶é—´æ§åˆ¶ç‰ˆ
         * æ ¸å¿ƒæ”¹è¿›: ä½¿ç”¨ Accumulator æ¨¡å¼åˆ†ç¦»ç‰©ç†æ›´æ–°ä¸æ¸²æŸ“
         */

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); 

        // ç³»ç»ŸçŠ¶æ€
        let width, height;
        let particles = [];
        let ruleMatrix = []; 
        const colors = ['#FF4444', '#44FF44', '#4444FF', '#FFFF44']; 
        
        // å‚æ•°
        let atomCounts = [200, 200, 200, 200];
        let cutOff = 80;
        let isPaused = false;
        
        // æ—¶é—´æ§åˆ¶æ ¸å¿ƒå˜é‡
        let timeScale = 1.0; 
        let physicsAccumulator = 0;
        const PHYSICS_STEP = 1.0; // ç‰©ç†ä¸–ç•Œçš„æ ‡å‡†æ—¶é—´æ­¥é•¿ï¼Œæ°¸è¿œä¸å˜
        
        // æ€§èƒ½ç›‘æ§
        let lastTime = 0;
        let frames = 0;
        const fpsElem = document.getElementById('fps-counter');
        const countElem = document.getElementById('total-particles');

        function resize() {
            width = canvas.width = canvas.parentElement.clientWidth;
            height = canvas.height = canvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // ç²’å­å·¥å‚ï¼šå¢åŠ  prevX/prevY ç”¨äºæ’å€¼
        const createParticle = (x, y, c) => {
            return { 
                x: x, y: y, 
                vx: 0, vy: 0, 
                color: c,
                // æ’å€¼ä¸“ç”¨ï¼šè®°å½•ä¸Šä¸€å¸§ç‰©ç†çŠ¶æ€
                prevX: x, prevY: y 
            };
        };

        function initParticles() {
            particles = [];
            for (let c = 0; c < 4; c++) {
                for (let i = 0; i < atomCounts[c]; i++) {
                    particles.push(createParticle(
                        Math.random() * width,
                        Math.random() * height,
                        c
                    ));
                }
            }
            updateTotalCount();
        }

        function updateTotalCount() {
            countElem.innerText = particles.length;
        }

        // ç‰©ç†æ›´æ–°ï¼šè¿™æ˜¯æ¨¡æ‹Ÿçš„â€œçœŸç†â€ï¼Œæ— è®ºæ—¶é—´å¿«æ…¢ï¼Œè¿™ä¸ªå‡½æ•°çš„é€»è¾‘å’Œæ­¥é•¿éƒ½ä¸å˜
        function updatePhysics() {
            for (let i = 0; i < particles.length; i++) {
                let a = particles[i];
                
                // é‡è¦ï¼šåœ¨æ›´æ–°ä½ç½®å‰ï¼Œè®°å½•å½“å‰ä½ç½®ä¸ºâ€œæ—§ä½ç½®â€ï¼Œä¾›æ¸²æŸ“æ’å€¼ä½¿ç”¨
                a.prevX = a.x;
                a.prevY = a.y;
                
                let fx = 0;
                let fy = 0;

                for (let j = 0; j < particles.length; j++) {
                    if (i === j) continue;
                    let b = particles[j];

                    let dx = a.x - b.x;
                    let dy = a.y - b.y;
                    
                    // ç¯å½¢ä¸–ç•Œæœ€çŸ­è·ç¦»é€»è¾‘ (å¯é€‰ï¼Œè¿™é‡Œä¸ºäº†ä¸¥æ ¼å¤åˆ»è§†é¢‘ä¿æŒéç¯å½¢ï¼Œä½†å¤„ç†è¾¹ç•Œåå¼¹)
                    // å¦‚æœéœ€è¦ç¯å½¢ï¼Œdx åº”ä¸ºï¼šif(dx > width/2) dx -= width;
                    
                    let d2 = dx * dx + dy * dy;

                    if (d2 > 0 && d2 < cutOff * cutOff) {
                        let d = Math.sqrt(d2);
                        let g = ruleMatrix[a.color][b.color];
                        if (d < 1) d = 1; // é˜²æ­¢é™¤é›¶
                        let F = g * 1 / d;
                        fx += (F * dx);
                        fy += (F * dy);
                    }
                }

                // æ ¸å¿ƒåŠ¨åŠ›å­¦
                a.vx = (a.vx + fx) * 0.5;
                a.vy = (a.vy + fy) * 0.5;

                a.x += a.vx;
                a.y += a.vy;

                // è¾¹ç•Œåå¼¹
                if (a.x <= 0) { a.x = 0; a.vx *= -1; }
                if (a.x >= width) { a.x = width; a.vx *= -1; }
                if (a.y <= 0) { a.y = 0; a.vy *= -1; }
                if (a.y >= height) { a.y = height; a.vy *= -1; }
            }
        }

        // ç»˜åˆ¶ï¼šä½¿ç”¨æ’å€¼ (alpha 0~1)
        function draw(alpha) {
            // æ¸…é™¤èƒŒæ™¯ (ä½¿ç”¨ç¨å¾®é€æ˜çš„é»‘è‰²äº§ç”Ÿæ‹–å°¾æ•ˆæœ? ä¸ï¼Œæ¸…æ™°ç‰ˆç”¨çº¯é»‘)
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, width, height);

            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                ctx.fillStyle = colors[p.color];
                
                // çº¿æ€§æ’å€¼è®¡ç®—æ¸²æŸ“ä½ç½®
                // renderX = oldX + (newX - oldX) * alpha
                // è¿™ç¡®ä¿äº†å³ä½¿ç‰©ç†æ›´æ–°æ¯ç§’åªæœ‰10æ¬¡ï¼Œæ¸²æŸ“ä¾ç„¶æ˜¯60fpså¹³æ»‘çš„
                let renderX = p.prevX + (p.x - p.prevX) * alpha;
                let renderY = p.prevY + (p.y - p.prevY) * alpha;
                
                // ç»˜åˆ¶å°æ–¹å—
                ctx.fillRect(renderX, renderY, 3, 3); 
            }
        }

        // ä¸»å¾ªç¯ (Game Loop)
        function loop(timestamp) {
            if (!lastTime) lastTime = timestamp;
            let frameTime = timestamp - lastTime;
            lastTime = timestamp;
            
            // é˜²æ­¢æµè§ˆå™¨åå°æŒ‚èµ·å¯¼è‡´çš„ä¸€å¸§æ—¶é—´è¿‡é•¿
            if (frameTime > 250) frameTime = 250;

            if (!isPaused) {
                // å°†æ¯«ç§’è½¬ä¸ºæ ‡å‡†å¸§å•ä½ (å‡è®¾60fpsä¸ºåŸºå‡†ï¼Œ16.6ms = 1.0 unit)
                // è¿™é‡Œæˆ‘ä»¬ç®€åŒ–ï¼šç´¯åŠ å™¨ç›´æ¥åŠ  timeScale
                // ä½†ä¸ºäº†è®© timeScale=1.0 å¯¹åº” 60FPS ä¸‹çš„ 1 æ¬¡æ›´æ–°ï¼Œæˆ‘ä»¬éœ€è¦å½’ä¸€åŒ–
                
                // é€»è¾‘ï¼šæ¯ä¸€å¸§æˆ‘ä»¬åº”è¯¥æ¨è¿›çš„æ—¶é—´é‡ = timeScale
                // ç‰©ç†å¼•æ“æ¯èµ°ä¸€æ­¥æ¶ˆè€— 1.0 çš„æ—¶é—´é‡
                
                // å¦‚æœ timeScale = 0.1ï¼Œæˆ‘ä»¬éœ€è¦ 10 å¸§æ‰èƒ½å‡‘å¤Ÿ 1.0 çš„ç‰©ç†æ­¥é•¿ -> æ…¢æ”¾
                // å¦‚æœ timeScale = 2.0ï¼Œæˆ‘ä»¬ä¸€å¸§å°±å‡‘å¤Ÿ 2.0 -> å¾ªç¯è·‘ 2 æ¬¡ç‰©ç† -> å¿«è¿›
                
                physicsAccumulator += timeScale;

                // èºæ—‹æ­»é”ä¿æŠ¤ (é˜²æ­¢ accumulator æ— é™å¤§å¯¼è‡´å¡æ­»)
                let maxSteps = 10; 
                while (physicsAccumulator >= PHYSICS_STEP && maxSteps > 0) {
                    updatePhysics();
                    physicsAccumulator -= PHYSICS_STEP;
                    maxSteps--;
                }
            }

            // è®¡ç®—æ’å€¼ç³»æ•° alpha
            // alpha = å‰©ä½™çš„ç´¯åŠ æ—¶é—´ / ç‰©ç†æ­¥é•¿
            // ä¾‹å¦‚ï¼šaccumulator å‰© 0.5ï¼Œæ­¥é•¿ 1.0ï¼Œè¯´æ˜æˆ‘ä»¬åœ¨ä¸¤å¸§ä¸­é—´ 50% çš„ä½ç½®
            let alpha = physicsAccumulator / PHYSICS_STEP;
            // å¦‚æœæš‚åœï¼Œç›´æ¥ç”»å½“å‰ä½ç½®ï¼Œä¸æ’å€¼ï¼ˆæˆ–è€… alpha=1ï¼‰
            if(isPaused) alpha = 1.0;

            draw(alpha);

            // FPS è®¡ç®—
            frames++;
            if (frames % 20 === 0) { // å‡å°‘ DOM æ“ä½œé¢‘ç‡
                fpsElem.innerText = Math.round(1000 / frameTime);
            }

            requestAnimationFrame(loop);
        }

        // --- UI æ§åˆ¶é€»è¾‘ ---

        const matrixContainer = document.getElementById('rules-matrix');
        
        function initUI() {
            matrixContainer.innerHTML = '';
            const labels = ['çº¢', 'ç»¿', 'è“', 'é»„'];
            const textColors = ['text-red-500', 'text-green-500', 'text-blue-500', 'text-yellow-500'];

            for (let i = 0; i < 4; i++) {
                const label = document.createElement('div');
                label.className = `font-bold text-right pr-2 ${textColors[i]}`;
                label.innerText = labels[i];
                matrixContainer.appendChild(label);

                for (let j = 0; j < 4; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell flex justify-center';
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = 0;
                    input.className = 'w-full h-7 bg-[#111] text-white text-center text-[10px] border border-gray-700 rounded focus:border-green-500 outline-none transition-colors';
                    
                    input.addEventListener('change', (e) => {
                        updateRule(i, j, parseFloat(e.target.value));
                    });

                    // ä¿å­˜å¼•ç”¨ä»¥ä¾¿æ›´æ–°
                    input.id = `rule-${i}-${j}`;
                    cell.appendChild(input);
                    matrixContainer.appendChild(cell);
                }
            }
        }

        function initRules() {
            ruleMatrix = [];
            for(let i=0; i<4; i++) ruleMatrix[i] = new Array(4).fill(0);
        }

        function updateRule(r, c, val) {
            ruleMatrix[r][c] = val / 10; 
        }

        function updateUIInputs() {
            for(let i=0; i<4; i++){
                for(let j=0; j<4; j++){
                    let val = Math.round(ruleMatrix[i][j] * 10);
                    const input = document.getElementById(`rule-${i}-${j}`);
                    if(input) input.value = val;
                }
            }
        }

        function randomizeRules() {
            for(let i=0; i<4; i++){
                for(let j=0; j<4; j++){
                    let val = (Math.random() * 2 - 1);
                    ruleMatrix[i][j] = val;
                }
            }
            updateUIInputs();
            initParticles();
        }

        function bindSliders() {
            // ç²’å­æ•°é‡
            ['red', 'green', 'blue', 'yellow'].forEach((color, idx) => {
                const slider = document.getElementById(`count-${color}`);
                const display = document.getElementById(`val-${color}`);
                slider.addEventListener('input', (e) => {
                    const val = parseInt(e.target.value);
                    display.innerText = val;
                    atomCounts[idx] = val;
                    initParticles();
                });
            });

            // èŒƒå›´
            const rangeSlider = document.getElementById('param-range');
            const rangeDisplay = document.getElementById('val-range');
            rangeSlider.addEventListener('input', (e) => {
                cutOff = parseInt(e.target.value);
                rangeDisplay.innerText = cutOff;
            });

            // æ—¶é—´é€Ÿç‡ (æ˜ å°„é€»è¾‘ï¼š1-10 -> 0.1-1.0, 10-50 -> 1.0-5.0)
            const timeSlider = document.getElementById('param-time');
            const timeDisplay = document.getElementById('val-time');
            
            const updateTimeScale = () => {
                let val = parseInt(timeSlider.value);
                // ç®€å•çš„åˆ†æ®µæ˜ å°„ï¼Œè®©æ»‘å—ä¸­é—´(10)å¯¹åº”1.0x
                if (val <= 10) {
                    timeScale = val / 10; // 0.1 ~ 1.0
                } else {
                    timeScale = 1.0 + (val - 10) * 0.1; // 1.1 ~ 5.0
                }
                timeDisplay.innerText = timeScale.toFixed(1) + "x";
            };
            
            timeSlider.addEventListener('input', updateTimeScale);
            updateTimeScale(); // åˆå§‹åŒ–
        }

        document.getElementById('btn-randomize').addEventListener('click', randomizeRules);
        document.getElementById('btn-reset').addEventListener('click', () => initParticles());
        document.getElementById('btn-pause').addEventListener('click', () => { isPaused = !isPaused; });

        // é¼ æ ‡æ’æ–¥
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            particles.forEach(p => {
                const dx = p.x - mouseX;
                const dy = p.y - mouseY;
                const d = Math.sqrt(dx*dx + dy*dy);
                if (d < 300) {
                    const force = 200 / (d + 1);
                    p.vx += force * dx / d;
                    p.vy += force * dy / d;
                }
            });
        });

        // å¯åŠ¨
        initUI();
        initRules();
        bindSliders();
        randomizeRules();
        requestAnimationFrame(loop);
        
    </script>
</body>
</html>