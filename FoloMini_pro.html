<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folo Mini - 本地版</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: {
                            850: '#1f1f22',
                            950: '#09090b', 
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts & Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.5); }
        
        /* Typography adjustments */
        .prose h1 { font-size: 1.5em; font-weight: 700; margin: 1em 0 0.5em; line-height: 1.3; }
        .prose h2 { font-size: 1.25em; font-weight: 600; margin: 1em 0 0.5em; line-height: 1.3; }
        .prose h3 { font-size: 1.1em; font-weight: 600; margin: 1em 0 0.5em; }
        .prose p { margin-bottom: 1em; line-height: 1.7; font-size: 1.05rem; }
        .prose ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 1em; }
        .prose img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1em 0; display: block; }
        .prose blockquote { border-left: 4px solid #e5e7eb; padding-left: 1em; color: #6b7280; font-style: italic; margin: 1em 0; background: rgba(0,0,0,0.02); border-radius: 0 4px 4px 0; }
        .prose pre { background: #f3f4f6; padding: 1em; border-radius: 0.5rem; overflow-x: auto; font-size: 0.9em; }
        .dark .prose pre { background: #27272a; }
        .dark .prose blockquote { border-color: #3f3f46; color: #a1a1aa; background: rgba(255,255,255,0.02); }
        
        /* Details Summary Customization */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; padding: 10px 16px; border-radius: 8px; color: white; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: fadeIn 0.3s ease; max-width: 300px; }
        .toast.error { background-color: #ef4444; }
        .toast.success { background-color: #22c55e; }
    </style>
    
    <!-- DATA SEED BLOCK: This is where data lives in the downloaded file -->
    <script id="app-data" type="application/json">null</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Constants & Config ---
        const INITIAL_FEEDS = [
            { id: '1', title: '少数派', url: 'https://sspai.com/feed' },
            { id: '2', title: '36氪', url: 'https://36kr.com/feed' },
            { id: '3', title: 'V2EX', url: 'https://www.v2ex.com/index.xml' },
        ];
        
        const DEFAULT_RSSHUB_NODES = [
            'https://eren.zeabur.app', 
            'https://rsshub.app', 
            'https://rsshub.feedlib.xyz'
        ];

        const DEFAULT_PROFILES = [
            {
                id: 'default-deepseek',
                name: 'DeepSeek (默认)',
                provider: 'openai',
                baseUrl: 'https://api.deepseek.com',
                apiKey: '',
                model: 'deepseek-chat'
            },
            {
                id: 'default-google',
                name: 'Google Gemini',
                provider: 'google',
                baseUrl: 'https://generativelanguage.googleapis.com',
                apiKey: '',
                model: 'gemini-1.5-flash'
            }
        ];

        // --- Icons ---
        const Icon = ({ path, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{path}</svg>
        );
        const Icons = {
            Plus: (p) => <Icon path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} {...p} />,
            Trash: (p) => <Icon path={<><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} {...p} />,
            Menu: (p) => <Icon path={<><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>} {...p} />,
            X: (p) => <Icon path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} {...p} />,
            Rss: (p) => <Icon path={<><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></>} {...p} />,
            Sparkles: (p) => <Icon path={<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1-1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>} {...p} />,
            ExternalLink: (p) => <Icon path={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></>} {...p} />,
            Left: (p) => <Icon path={<path d="m15 18-6-6 6-6"/>} {...p} />,
            Settings: (p) => <Icon path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} {...p} />,
            Moon: (p) => <Icon path={<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>} {...p} />,
            Sun: (p) => <Icon path={<><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>} {...p} />,
            Loader: (p) => <Icon path={<path d="M21 12a9 9 0 1 1-6.219-8.56"/>} className={cn("animate-spin", p.className)} {...p} />,
            Refresh: (p) => <Icon path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} {...p} />,
            Save: (p) => <Icon path={<><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></>} {...p} />,
            Layers: (p) => <Icon path={<><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>} {...p} />,
            Star: (p) => <Icon path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>} {...p} />,
            Download: (p) => <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} {...p} />,
            Link: (p) => <Icon path={<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>} {...p} />,
            Activity: (p) => <Icon path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>} {...p} />,
            CheckCircle: (p) => <Icon path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} {...p} />,
            Edit: (p) => <Icon path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>} {...p} />,
            Brain: (p) => <Icon path={<><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></>} {...p} />,
            ChevronDown: (p) => <Icon path={<path d="m6 9 6 6 6-6"/>} {...p} />,
            Database: (p) => <Icon path={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} {...p} />,
            Key: (p) => <Icon path={<><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></>} {...p} />,
            Tv: (p) => <Icon path={<><rect width="20" height="15" x="2" y="7" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></>} {...p} />,
            Youtube: (p) => <Icon path={<><path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17"/><path d="m10 15 5-3-5-3z"/></>} {...p} />,
            Eye: (p) => <Icon path={<><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>} {...p} />,
            Mic: (p) => <Icon path={<><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></>} {...p} />,
            Video: (p) => <Icon path={<><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></>} {...p} />,
            MessageSquare: (p) => <Icon path={<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>} {...p} />,
            ScrollText: (p) => <Icon path={<><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/></>} {...p} />,
            Search: (p) => <Icon path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} {...p} />,
            Hash: (p) => <Icon path={<><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></>} {...p} />,
            Copy: (p) => <Icon path={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>} {...p} />,
            Check: (p) => <Icon path={<polyline points="20 6 9 17 4 12"/>} {...p} />,
            AlertTriangle: (p) => <Icon path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} {...p} />,
            Wand: (p) => <Icon path={<><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></>} {...p} />,
            Server: (p) => <Icon path={<><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></>} {...p} />,
            PlayCircle: (p) => <Icon path={<><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></>} {...p} />,
            Film: (p) => <Icon path={<><rect width="20" height="20" x="2" y="2" rx="2.18" ry="2.18"/><line x1="7" x2="7" y1="2" y2="22"/><line x1="17" x2="17" y1="2" y2="22"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="2" x2="7" y1="7" y2="7"/><line x1="2" x2="7" y1="17" y2="17"/><line x1="17" x2="22" y1="17" y2="17"/><line x1="17" x2="22" y1="7" y2="7"/></>} {...p} />,
            Upload: (p) => <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} {...p} />
        };

        const GENERATOR_PLATFORMS = {
            bilibili: { id: 'bilibili', name: 'Bilibili', icon: 'Tv', placeholder: '例如: 401742377 或 space.bilibili.com/...', colors: { main: 'orange-500', bgLight: 'bg-orange-50', text: 'text-orange-600', ring: 'ring-orange-500' }, requiresAuth: true, options: [
                { id: 'video', label: '用户投稿', path: '/bilibili/user/video/', desc: 'UP 主发布的视频', icon: 'Tv' },
                { id: 'dynamic', label: '用户动态', path: '/bilibili/user/dynamic/', desc: '转发与图文动态', icon: 'Activity' },
                { id: 'fav', label: '收藏夹', path: '/bilibili/user/fav/', desc: '默认收藏夹内容', icon: 'Star' },
                { id: 'coin', label: '投币视频', path: '/bilibili/user/coin/', desc: '最近投币的视频', icon: 'Database' },
            ]},
            youtube: { id: 'youtube', name: 'YouTube', icon: 'Youtube', placeholder: '例如: @LofiGirl 或 youtube.com/@...', colors: { main: 'red-600', bgLight: 'bg-red-50', text: 'text-red-600', ring: 'ring-red-500' }, requiresAuth: true, options: [
                { id: 'video', label: '频道视频', desc: '频道最新发布的视频', icon: 'Video' },
                { id: 'community', label: '社区动态', desc: '社区帖子 (Community Tab)', icon: 'MessageSquare' }
            ]},
            weibo: { id: 'weibo', name: '微博', icon: 'Eye', placeholder: '例如: weibo.com/u/123456', colors: { main: 'rose-500', bgLight: 'bg-rose-50', text: 'text-rose-600', ring: 'ring-rose-500' }, requiresAuth: true, options: [
                { id: 'timeline', label: '博主动态', path: '/weibo/user/', desc: '用户的全部微博动态', icon: 'ScrollText' },
                { id: 'keyword', label: '关键词搜索', path: '/weibo/keyword/', desc: '实时热搜关键词', icon: 'Search' }
            ]},
            xiaoyuzhou: { id: 'xiaoyuzhou', name: '小宇宙', icon: 'Mic', placeholder: '例如: xiaoyuzhoufm.com/podcast/...', colors: { main: 'indigo-500', bgLight: 'bg-indigo-50', text: 'text-indigo-600', ring: 'ring-indigo-500' }, requiresAuth: false, options: [
                { id: 'podcast', label: '播客更新', path: '/xiaoyuzhou/podcast/', desc: '订阅该播客的最新单集', icon: 'Mic' }
            ]},
            jike: { id: 'jike', name: '即刻', icon: 'Activity', placeholder: '例如: okjike.com/users/...', colors: { main: 'yellow-400', bgLight: 'bg-yellow-50', text: 'text-yellow-600', ring: 'ring-yellow-400' }, requiresAuth: false, options: [
                { id: 'user', label: '用户动态', path: '/jike/user/', desc: '指定用户的即刻动态', icon: 'Activity' },
                { id: 'topic', label: '圈子/话题', path: '/jike/topic/', desc: '指定圈子的精选/全部动态', icon: 'Hash' }
            ]}
        };

        // --- Helpers ---
        const cn = (...classes) => classes.filter(Boolean).join(' ');
        
        // --- RSS Parsers ---
        const parseXMLRSS = (xmlText) => {
             const parser = new DOMParser();
             const xmlDoc = parser.parseFromString(xmlText, "text/xml");
             const isAtom = xmlDoc.querySelector("feed");
             
             const feedTitle = xmlDoc.querySelector(isAtom ? "feed > title" : "channel > title")?.textContent || "";
             const items = Array.from(xmlDoc.querySelectorAll(isAtom ? "entry" : "item"));

             return items.map(item => {
                 const title = item.querySelector("title")?.textContent || "";
                 let link = "";
                 if (isAtom) {
                     link = item.querySelector("link[rel='alternate']")?.getAttribute("href") || item.querySelector("link")?.getAttribute("href");
                 } else {
                     link = item.querySelector("link")?.textContent;
                 }
                 const pubDate = item.querySelector("pubDate, published, updated")?.textContent || new Date().toISOString();
                 let description = "";
                 const contentEncoded = item.getElementsByTagNameNS("http://purl.org/rss/1.0/modules/content/", "encoded")[0];
                 if (contentEncoded) {
                     description = contentEncoded.textContent;
                 } else {
                     description = item.querySelector("encoded")?.textContent || item.querySelector("description, summary, content")?.textContent || "";
                 }
                 const guid = item.querySelector("guid, id")?.textContent || link;

                 // Enclosure parsing
                 const enclosure = item.querySelector("enclosure");
                 let mediaUrl = enclosure?.getAttribute("url");
                 let mediaType = enclosure?.getAttribute("type");

                 return { title, link, feedTitle, id: guid, isoDate: pubDate, description, content: description, mediaUrl, mediaType };
             });
        }

        const fetchRSS = async (url) => {
            // Strategy 1: RSS2JSON
            try {
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
                const data = await res.json();
                if (data.status === 'ok') {
                    return data.items.map(item => ({
                        ...item,
                        feedTitle: data.feed.title,
                        id: item.guid || item.link,
                        isoDate: item.pubDate,
                        description: item.description || item.content || '',
                        mediaUrl: item.enclosure?.link,
                        mediaType: item.enclosure?.type
                    }));
                }
            } catch (e) {}

            // Strategy 2: AllOrigins
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxyUrl);
                const data = await res.json();
                if (data.contents) {
                     const items = parseXMLRSS(data.contents);
                     if (items.length > 0) return items;
                }
            } catch(e) {}

            // Strategy 3: CorsProxy
            try {
                const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                if (res.ok) {
                    const text = await res.text();
                    const items = parseXMLRSS(text);
                    if (items.length > 0) return items;
                }
            } catch(e) {}

            return [];
        };

        const parseOPML = (text) => {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml");
                const outlines = xmlDoc.querySelectorAll("outline[xmlUrl]");
                const newFeeds = [];
                outlines.forEach(outline => {
                    const url = outline.getAttribute("xmlUrl");
                    const title = outline.getAttribute("text") || outline.getAttribute("title") || "New Feed";
                    if (url) newFeeds.push({ 
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        url, 
                        title, 
                        createdAt: new Date().toISOString() 
                    });
                });
                return newFeeds;
            } catch (e) {
                console.error("OPML Parse Error", e);
                return [];
            }
        };

        const generateOPML = (feeds) => {
            const header = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="1.0">
<head>
    <title>Folo Mini Feeds Export</title>
</head>
<body>`;
            const footer = `
</body>
</opml>`;
            const body = feeds.map(f => `    <outline text="${(f.title || '').replace(/"/g, '&quot;')}" title="${(f.title || '').replace(/"/g, '&quot;')}" type="rss" xmlUrl="${(f.url || '').replace(/"/g, '&quot;')}" />`).join('\n');
            return header + '\n' + body + footer;
        };

        // --- AI API Logic (Streaming) ---
        // Streaming Function
        const streamSummary = async (text, config, onReasoning, onUpdate, onComplete, onError) => {
            if (!config.apiKey) {
                onError("配置中缺失 API Key，请在设置中添加。");
                return;
            }
            const cleanText = text.replace(/<[^>]+>/g, '').substring(0, 8000);
            const contextPrompt = `请用通俗易懂的中文，为用户总结这篇文章的核心观点。\n\n文章内容:\n${cleanText}`;

            try {
                let url, body, headers, parseChunk;
                // Remove trailing slash safely
                let baseUrl = (config.baseUrl || '').replace(/\/+$/, '');

                if (config.provider === 'google') {
                    baseUrl = baseUrl || 'https://generativelanguage.googleapis.com';
                    const model = config.model || 'gemini-1.5-flash';
                    // Use alt=sse for easier parsing
                    url = `${baseUrl}/v1beta/models/${model}:streamGenerateContent?key=${config.apiKey}&alt=sse`;
                    headers = { 'Content-Type': 'application/json' };
                    body = JSON.stringify({ contents: [{ parts: [{ text: contextPrompt }] }] });
                    
                    parseChunk = (line) => {
                        if (line.startsWith('data: ')) {
                            try {
                                const json = JSON.parse(line.substring(6));
                                const content = json.candidates?.[0]?.content?.parts?.[0]?.text;
                                if (content) onUpdate(content);
                            } catch (e) { }
                        }
                    };

                } else {
                    // OpenAI Compatible
                    baseUrl = baseUrl || 'https://api.deepseek.com';
                    const aiModel = config.model || "deepseek-chat";
                    url = `${baseUrl}/chat/completions`;
                    headers = { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${config.apiKey}` 
                    };
                    body = JSON.stringify({
                        model: aiModel,
                        messages: [
                            { role: "system", content: "你是一个专业的文章摘要助手。请用通俗易懂的中文，为用户总结这篇文章的核心观点。使用无序列表列出3-5个重点。保持客观，不要使用第一人称。" },
                            { role: "user", content: contextPrompt }
                        ],
                        stream: true 
                    });

                    parseChunk = (line) => {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.substring(6));
                                const delta = json.choices?.[0]?.delta;
                                
                                if (delta) {
                                    // Handle Reasoning
                                    if (delta.reasoning_content) {
                                        onReasoning(delta.reasoning_content);
                                    } 
                                    // Handle Content
                                    else if (delta.content) {
                                        onUpdate(delta.content);
                                    }
                                }
                            } catch (e) { }
                        }
                    };
                }

                // 404 AUTO-FIX LOGIC (Same as checkConnection)
                let response = await fetch(url, { method: 'POST', headers, body });
                
                if (response.status === 404 && config.provider !== 'google' && !url.includes('/v1/')) {
                    // Try inserting /v1
                    const v1Url = `${baseUrl}/v1/chat/completions`;
                    const resV1 = await fetch(v1Url, { method: 'POST', headers, body });
                    if (resV1.status !== 404) {
                        response = resV1; // Use the successful v1 response
                    }
                }

                if (!response.ok) {
                    let errMsg = `HTTP ${response.status}`;
                    if (response.status === 401) errMsg = "401 无效 Key";
                    if (response.status === 403) errMsg = "403 余额不足/无权限";
                    if (response.status === 404) errMsg = "404 找不到模型 (请检查Base URL或模型ID)";
                    if (response.status === 429) errMsg = "429 请求过快";
                    throw new Error(errMsg);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed) parseChunk(trimmed);
                    }
                }
                
                onComplete();

            } catch (e) {
                console.error(e);
                onError(`流式生成失败: ${e.message}`);
            }
        };

        const callGoogle = async (apiKey, baseUrl, model, text) => {
            const url = `${baseUrl}/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
            });
            if (!res.ok) throw new Error(`Google API Error: ${res.status}`);
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        };

        const callOpenAI = async (apiKey, baseUrl, model, text) => {
            // URL Normalization for Testing
            let cleanBase = (baseUrl || '').replace(/\/+$/, '');
            let url = `${cleanBase}/chat/completions`;
            
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };
            const body = JSON.stringify({
                model: model,
                messages: [{ role: "user", content: text }],
                stream: false,
                max_tokens: 50
            });

            let res = await fetch(url, { method: 'POST', headers, body });
            
            // Retry logic
            if (res.status === 404 && !url.includes('/v1/')) {
                url = `${cleanBase}/v1/chat/completions`;
                res = await fetch(url, { method: 'POST', headers, body });
            }

            if (!res.ok) {
                try {
                    const err = await res.json();
                    if (err.error && err.error.message) throw new Error(`${res.status} ${err.error.message}`);
                } catch(e) { if(e.message.includes(res.status)) throw e; }
                throw new Error(`API Error: ${res.status}`);
            }
            const data = await res.json();
            return data.choices?.[0]?.message?.content;
        };

        // --- UI Components ---
        const Toast = ({ toasts, removeToast }) => (
            <div className="toast-container">
                {toasts.map(t => (
                    <div key={t.id} className={`toast ${t.type === 'error' ? 'error' : 'success'}`} onClick={() => removeToast(t.id)}>
                        {t.msg}
                    </div>
                ))}
            </div>
        );

        const BackupModal = ({ open, onClose, onConfirm, stats, darkMode }) => {
            const [options, setOptions] = useState({ feeds: true, favorites: true, settings: true, nodes: true });
            
            if (!open) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
                    <div className={cn("w-full max-w-sm rounded-xl shadow-2xl p-6 transition-all scale-100", darkMode ? "bg-zinc-900 border border-zinc-800 text-zinc-100" : "bg-white text-zinc-900")}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold flex items-center gap-2"><Icons.Download className="w-5 h-5" /> 备份与导出</h3>
                            <button onClick={onClose}><Icons.X className="w-5 h-5" /></button>
                        </div>
                        <p className="text-sm text-zinc-500 mb-4">
                            此操作将生成一个包含当前数据的独立 HTML 文件。您可以勾选需要保存的内容：
                        </p>
                        
                        <div className="space-y-3 mb-6">
                            <label className="flex items-center justify-between p-3 rounded border cursor-pointer hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors border-zinc-200 dark:border-zinc-800">
                                <div className="flex items-center gap-3">
                                    <Icons.Rss className="w-4 h-4 text-orange-500" />
                                    <div className="text-sm font-medium">订阅源</div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-xs text-zinc-400">{stats.feedsCount} 个</span>
                                    <input type="checkbox" checked={options.feeds} onChange={e => setOptions({...options, feeds: e.target.checked})} className="w-4 h-4 accent-purple-600" />
                                </div>
                            </label>

                            <label className="flex items-center justify-between p-3 rounded border cursor-pointer hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors border-zinc-200 dark:border-zinc-800">
                                <div className="flex items-center gap-3">
                                    <Icons.Star className="w-4 h-4 text-yellow-500" />
                                    <div className="text-sm font-medium">收藏文章</div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-xs text-zinc-400">{stats.favoritesCount} 篇</span>
                                    <input type="checkbox" checked={options.favorites} onChange={e => setOptions({...options, favorites: e.target.checked})} className="w-4 h-4 accent-purple-600" />
                                </div>
                            </label>
                            
                            <label className="flex items-center justify-between p-3 rounded border cursor-pointer hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors border-zinc-200 dark:border-zinc-800">
                                <div className="flex items-center gap-3">
                                    <Icons.Server className="w-4 h-4 text-blue-500" />
                                    <div className="text-sm font-medium">RSSHub 节点</div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-xs text-zinc-400">{stats.nodesCount} 个</span>
                                    <input type="checkbox" checked={options.nodes} onChange={e => setOptions({...options, nodes: e.target.checked})} className="w-4 h-4 accent-blue-600" />
                                </div>
                            </label>

                            <label className={cn("flex items-center justify-between p-3 rounded border cursor-pointer transition-colors border-zinc-200 dark:border-zinc-800", options.settings ? "bg-red-50/50 dark:bg-red-900/10" : "hover:bg-zinc-50 dark:hover:bg-zinc-800")}>
                                <div className="flex items-center gap-3">
                                    <Icons.Key className="w-4 h-4 text-red-500" />
                                    <div className="flex flex-col">
                                        <div className="text-sm font-medium">AI 配置与密钥</div>
                                        {options.settings && <span className="text-[10px] text-red-500">包含敏感 API Key，请谨慎分享</span>}
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-xs text-zinc-400">{stats.profilesCount} 组</span>
                                    <input type="checkbox" checked={options.settings} onChange={e => setOptions({...options, settings: e.target.checked})} className="w-4 h-4 accent-red-600" />
                                </div>
                            </label>
                        </div>

                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-sm text-zinc-500 hover:text-zinc-700">取消</button>
                            <button onClick={() => onConfirm(options)} className="px-4 py-2 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded-lg flex items-center gap-2 shadow-lg shadow-purple-500/20">
                                <Icons.Download className="w-4 h-4" /> 确认下载
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const OPMLModal = ({ open, onClose, onImport, onExport, darkMode }) => {
            const fileInputRef = useRef(null);

            if (!open) return null;

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const feeds = parseOPML(text);
                    if (feeds.length > 0) {
                        onImport(feeds);
                        onClose();
                    } else {
                        alert("OPML 解析失败或文件为空");
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
                    <div className={cn("w-full max-w-sm rounded-xl shadow-2xl p-6 transition-all scale-100", darkMode ? "bg-zinc-900 border border-zinc-800 text-zinc-100" : "bg-white text-zinc-900")}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold flex items-center gap-2"><Icons.Rss className="w-5 h-5" /> 导入/导出 OPML</h3>
                            <button onClick={onClose}><Icons.X className="w-5 h-5" /></button>
                        </div>
                        <p className="text-sm text-zinc-500 mb-6">
                            管理您的订阅列表。支持标准的 OPML 格式，兼容 Feedly、Inoreader 等。
                        </p>
                        
                        <div className="space-y-3">
                            <button onClick={() => fileInputRef.current.click()} className="w-full p-3 rounded-lg border border-dashed border-zinc-300 dark:border-zinc-700 hover:border-purple-500 dark:hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/10 flex items-center justify-center gap-2 transition-all group">
                                <Icons.Upload className="w-5 h-5 text-zinc-400 group-hover:text-purple-600" />
                                <span className="text-sm font-medium text-zinc-600 dark:text-zinc-400 group-hover:text-purple-700 dark:group-hover:text-purple-400">导入 OPML 文件</span>
                            </button>
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".opml,.xml" className="hidden" />

                            <button onClick={onExport} className="w-full p-3 rounded-lg border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-800 flex items-center justify-center gap-2 transition-all">
                                <Icons.Download className="w-5 h-5 text-zinc-400" />
                                <span className="text-sm font-medium text-zinc-600 dark:text-zinc-400">导出当前订阅</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ open, onClose, profiles, activeProfileId, onSaveProfiles, onSetActiveProfile, darkMode, addToast }) => {
            const activeProfile = profiles.find(p => p.id === activeProfileId) || profiles[0];
            const [localActiveProfile, setLocalActiveProfile] = useState(activeProfile);
            const [availableModels, setAvailableModels] = useState([]);
            const [isChecking, setIsChecking] = useState(false);
            const [isTestingModel, setIsTestingModel] = useState(false);
            const [isRenaming, setIsRenaming] = useState(false);
            const [renameValue, setRenameValue] = useState("");

            useEffect(() => { 
                if (open) {
                    const current = profiles.find(p => p.id === activeProfileId) || profiles[0];
                    setLocalActiveProfile(current);
                    setAvailableModels([]);
                    setIsRenaming(false);
                }
            }, [open, profiles, activeProfileId]);
            
            if (!open) return null;

            const updateField = (field, value) => {
                setLocalActiveProfile(prev => {
                    const updated = { ...prev, [field]: value };
                    if (field === 'provider') {
                        updated.baseUrl = value === 'google' 
                            ? 'https://generativelanguage.googleapis.com' 
                            : 'https://api.deepseek.com';
                        updated.model = '';
                        setAvailableModels([]);
                    }
                    return updated;
                });
            };

            const handleProfileSwitch = (e) => {
                const newId = e.target.value;
                // Save current changes to the old profile before switching? 
                // Simple approach: Trigger parent save for current, then switch.
                onSaveProfiles(profiles.map(p => p.id === localActiveProfile.id ? localActiveProfile : p));
                onSetActiveProfile(newId);
            };

            const handleAddProfile = () => {
                const newId = `custom-${Date.now()}`;
                const newProfile = {
                    id: newId,
                    name: '新配置 ' + (profiles.length + 1),
                    provider: 'openai',
                    baseUrl: 'https://api.deepseek.com',
                    apiKey: '',
                    model: 'deepseek-chat'
                };
                // Save current work then add new
                const updatedList = profiles.map(p => p.id === localActiveProfile.id ? localActiveProfile : p);
                onSaveProfiles([...updatedList, newProfile]);
                onSetActiveProfile(newId);
            };

            const handleDeleteProfile = () => {
                if (profiles.length <= 1) {
                    addToast("至少保留一个配置", "error");
                    return;
                }
                if (confirm(`确定删除配置 "${localActiveProfile.name}" 吗?`)) {
                    const newList = profiles.filter(p => p.id !== localActiveProfile.id);
                    onSaveProfiles(newList);
                    onSetActiveProfile(newList[0].id);
                }
            };

            const startRename = () => {
                setRenameValue(localActiveProfile.name);
                setIsRenaming(true);
            };

            const finishRename = () => {
                if (renameValue.trim()) {
                    updateField('name', renameValue.trim());
                }
                setIsRenaming(false);
            };

            const saveAll = () => {
                // Update the current profile in the main list
                const updatedList = profiles.map(p => p.id === localActiveProfile.id ? localActiveProfile : p);
                onSaveProfiles(updatedList);
                addToast("设置已保存");
                onClose();
            };

            const checkConnection = async () => {
                if (!localActiveProfile.apiKey) {
                    addToast("请先填写 API Key", "error");
                    return;
                }
                setIsChecking(true);
                
                try {
                    if (localActiveProfile.provider === 'google') {
                        const baseUrl = (localActiveProfile.baseUrl || 'https://generativelanguage.googleapis.com').replace(/\/$/, '');
                        const res = await fetch(`${baseUrl}/v1beta/models?key=${localActiveProfile.apiKey}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.models) {
                                const ids = data.models
                                    .filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent"))
                                    .map(m => m.name.replace('models/', ''))
                                    .sort();
                                setAvailableModels(ids);
                                addToast(`成功！筛选出 ${ids.length} 个对话模型。`);
                                if (!localActiveProfile.model) updateField('model', ids[0]);
                            }
                        } else {
                            throw new Error(`HTTP ${res.status}`);
                        }
                    } else {
                        // FIX: Ensure no double slashes and handle /v1 logic robustly
                        let baseUrl = (localActiveProfile.baseUrl || 'https://api.deepseek.com').replace(/\/+$/, '');
                        
                        // Try 1: Direct path
                        let res = await fetch(`${baseUrl}/models`, { headers: { 'Authorization': `Bearer ${localActiveProfile.apiKey}` } });

                        // Try 2: Add /v1 if failed
                        if (res.status === 404 && !baseUrl.includes('/v1')) {
                             const v1Url = `${baseUrl}/v1/models`;
                             const resV1 = await fetch(v1Url, { headers: { 'Authorization': `Bearer ${localActiveProfile.apiKey}` } });
                             if (resV1.ok || resV1.status !== 404) res = resV1;
                        }

                        if (res.ok) {
                            const data = await res.json();
                            if (data.data && Array.isArray(data.data)) {
                                const ids = data.data
                                    .map(m => m.id)
                                    .filter(id => !id.includes('embedding') && !id.includes('tts') && !id.includes('audio') && !id.includes('whisper'))
                                    .sort();
                                setAvailableModels(ids);
                                addToast(`成功！发现 ${ids.length} 个模型。`);
                                if (!localActiveProfile.model && ids.length > 0) updateField('model', ids[0]);
                            } else {
                                addToast("连接成功，但未找到模型列表", "error");
                            }
                        } else {
                            throw new Error(`HTTP ${res.status}`);
                        }
                    }
                } catch (e) {
                    addToast(`连接失败: ${e.message}`, "error");
                } finally {
                    setIsChecking(false);
                }
            };

            const testCurrentModel = async () => {
                if (!localActiveProfile.apiKey || !localActiveProfile.model) {
                    addToast("请先填写 Key 并选择模型", "error");
                    return;
                }
                setIsTestingModel(true);
                const baseUrl = (localActiveProfile.baseUrl || (localActiveProfile.provider === 'google' ? 'https://generativelanguage.googleapis.com' : 'https://api.deepseek.com')).replace(/\/$/, '');
                
                try {
                    const testPrompt = "Hi";
                    let res;
                    if (localActiveProfile.provider === 'google') {
                        res = await callGoogle(localActiveProfile.apiKey, baseUrl, localActiveProfile.model, testPrompt);
                    } else {
                        res = await callOpenAI(localActiveProfile.apiKey, baseUrl, localActiveProfile.model, testPrompt);
                    }
                    if (res) addToast(`测试通过！模型回复正常。`);
                    else throw new Error("无回复");
                } catch (e) {
                    addToast(`测试失败: ${e.message}`, "error");
                } finally {
                    setIsTestingModel(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
                    <div className={cn("w-full max-w-md rounded-xl shadow-2xl p-6 transition-all scale-100 flex flex-col max-h-[90vh]", darkMode ? "bg-zinc-900 border border-zinc-800 text-zinc-100" : "bg-white text-zinc-900")}>
                        <div className="flex justify-between items-center mb-4 shrink-0">
                            <h3 className="text-lg font-bold flex items-center gap-2"><Icons.Settings className="w-5 h-5" /> AI 配置</h3>
                            <button onClick={onClose}><Icons.X className="w-5 h-5" /></button>
                        </div>
                        
                        <div className="space-y-4 overflow-y-auto flex-1 custom-scrollbar pr-1">
                            {/* Profile Selector */}
                            <div className={cn("p-3 rounded-lg border space-y-2", darkMode ? "bg-zinc-950 border-zinc-800" : "bg-zinc-50 border-zinc-200")}>
                                <div className="flex justify-between items-center">
                                    <label className="text-xs font-bold text-zinc-500 uppercase tracking-wider">配置方案</label>
                                    <div className="flex gap-1">
                                        {isRenaming ? (
                                            <div className="flex items-center gap-1">
                                                <input 
                                                    value={renameValue}
                                                    onChange={e => setRenameValue(e.target.value)}
                                                    onBlur={finishRename}
                                                    onKeyDown={e => e.key === 'Enter' && finishRename()}
                                                    autoFocus
                                                    className={cn("w-24 text-xs px-1 py-0.5 rounded border outline-none", darkMode ? "bg-zinc-900 border-zinc-700" : "bg-white border-zinc-300")}
                                                />
                                                <button onClick={finishRename} className="text-green-500"><Icons.CheckCircle className="w-3 h-3"/></button>
                                            </div>
                                        ) : (
                                            <button onClick={startRename} title="重命名当前方案" className="text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 p-1"><Icons.Edit className="w-3 h-3"/></button>
                                        )}
                                        <button onClick={handleDeleteProfile} title="删除当前方案" className="text-zinc-400 hover:text-red-500 p-1"><Icons.Trash className="w-3 h-3"/></button>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <select 
                                        value={activeProfileId} 
                                        onChange={handleProfileSwitch}
                                        className={cn("flex-1 px-3 py-2 rounded text-sm border outline-none cursor-pointer font-medium", darkMode ? "bg-zinc-900 border-zinc-700" : "bg-white border-zinc-300")}
                                    >
                                        {profiles.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                    </select>
                                    <button onClick={handleAddProfile} className="px-3 py-2 bg-zinc-200 dark:bg-zinc-800 hover:bg-zinc-300 dark:hover:bg-zinc-700 rounded text-zinc-600 dark:text-zinc-300"><Icons.Plus className="w-4 h-4" /></button>
                                </div>
                            </div>

                            <hr className={cn("border-t", darkMode ? "border-zinc-800" : "border-zinc-200")} />

                            <div>
                                <label className="block text-xs font-medium text-zinc-500 mb-1">服务商类型</label>
                                <select 
                                    value={localActiveProfile.provider} 
                                    onChange={e => updateField('provider', e.target.value)}
                                    className={cn("w-full px-3 py-2 rounded-lg text-sm border outline-none cursor-pointer", darkMode ? "bg-zinc-950 border-zinc-800 focus:border-purple-500" : "bg-zinc-50 border-zinc-200 focus:border-purple-500")}
                                >
                                    <option value="openai">OpenAI 兼容 (DeepSeek/ChatGPT/自定义)</option>
                                    <option value="google">Google Gemini (官方)</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-xs font-medium text-zinc-500 mb-1">API Base URL</label>
                                <input type="text" value={localActiveProfile.baseUrl} onChange={e => updateField('baseUrl', e.target.value)} className={cn("w-full px-3 py-2 rounded-lg text-sm border outline-none", darkMode ? "bg-zinc-950 border-zinc-800 focus:border-purple-500" : "bg-zinc-50 border-zinc-200 focus:border-purple-500")} />
                            </div>

                            <div>
                                <label className="block text-xs font-medium text-zinc-500 mb-1">API Key</label>
                                <input type="password" value={localActiveProfile.apiKey} onChange={e => updateField('apiKey', e.target.value)} className={cn("w-full px-3 py-2 rounded-lg text-sm border outline-none", darkMode ? "bg-zinc-950 border-zinc-800 focus:border-purple-500" : "bg-zinc-50 border-zinc-200 focus:border-purple-500")} placeholder="sk-..." />
                            </div>
                            
                            <div className="flex justify-end">
                                <button 
                                    onClick={checkConnection}
                                    disabled={isChecking}
                                    className={cn("flex items-center gap-1 text-xs px-2 py-1 rounded transition-colors", 
                                        isChecking ? "opacity-50 cursor-wait" : "hover:bg-zinc-100 dark:hover:bg-zinc-800 text-purple-600 dark:text-purple-400"
                                    )}
                                >
                                    {isChecking ? <Icons.Loader className="w-3 h-3" /> : <Icons.Activity className="w-3 h-3" />}
                                    {isChecking ? "正在筛选..." : "检测连接 & 获取模型"}
                                </button>
                            </div>

                            <div>
                                <label className="block text-xs font-medium text-zinc-500 mb-1">模型名称 (Model ID)</label>
                                <div className="space-y-2">
                                    {availableModels.length > 0 ? (
                                        <div className="flex gap-2">
                                            <select 
                                                onChange={e => updateField('model', e.target.value)}
                                                className={cn("flex-1 px-2 py-2 rounded text-sm border outline-none cursor-pointer", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-300")}
                                                value={availableModels.includes(localActiveProfile.model) ? localActiveProfile.model : ""}
                                            >
                                                <option value="" disabled>-- 请选择模型 --</option>
                                                {availableModels.map(m => (
                                                    <option key={m} value={m}>{m}</option>
                                                ))}
                                            </select>
                                            <button 
                                                onClick={testCurrentModel}
                                                disabled={isTestingModel || !localActiveProfile.model}
                                                className={cn("px-3 py-1.5 rounded text-xs border transition-all flex items-center gap-1", 
                                                    isTestingModel ? "opacity-50" : "hover:border-green-500 hover:text-green-600 dark:hover:text-green-400",
                                                    darkMode ? "border-zinc-700 bg-zinc-900" : "border-zinc-300 bg-white"
                                                )}
                                            >
                                                {isTestingModel ? <Icons.Loader className="w-3 h-3"/> : <Icons.CheckCircle className="w-3 h-3"/>}
                                                测试
                                            </button>
                                        </div>
                                    ) : (
                                        <input 
                                            type="text" 
                                            value={localActiveProfile.model || ''} 
                                            onChange={e => updateField('model', e.target.value)}
                                            className={cn("w-full px-3 py-2 rounded-lg text-sm border outline-none", darkMode ? "bg-zinc-950 border-zinc-800 focus:border-purple-500" : "bg-zinc-50 border-zinc-200 focus:border-purple-500")} 
                                            placeholder="如 deepseek-chat" 
                                        />
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="mt-6 flex justify-end gap-2 shrink-0">
                            <button onClick={onClose} className="px-4 py-2 text-sm text-zinc-500 hover:text-zinc-700">取消</button>
                            <button onClick={saveAll} className="px-4 py-2 text-sm bg-purple-600 text-white rounded-lg flex items-center gap-2 hover:bg-purple-700 shadow-lg shadow-purple-500/20"><Icons.Save className="w-4 h-4" /> 保存当前配置</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- RSS Generator Modal Component ---
        const RSSGeneratorModal = ({ open, onClose, onAddFeed, darkMode, addToast, savedNodes, setSavedNodes }) => {
            const [platform, setPlatform] = useState('bilibili');
            const [uid, setUid] = useState('');
            const [selectedType, setSelectedType] = useState('video');
            const [baseUrl, setBaseUrl] = useState('https://eren.zeabur.app');
            const [dropdownOpen, setDropdownOpen] = useState(false);

            useEffect(() => {
                if(GENERATOR_PLATFORMS[platform]) {
                    setSelectedType(GENERATOR_PLATFORMS[platform].options[0].id);
                    setUid('');
                }
            }, [platform]);

            if (!open) return null;

            const handleInputChange = (e) => {
                const value = e.target.value;
                setUid(value);
            };

            const getSmartUid = () => {
                let cleanUid = uid;
                if (platform === 'bilibili') {
                     const match = uid.match(/(?:space\.bilibili\.com|bilibili\.com\/space)\/(\d+)/);
                     if (match) cleanUid = match[1];
                } else if (platform === 'youtube') {
                    const handleMatch = uid.match(/@([\w.-]+)/);
                    if (handleMatch) cleanUid = `@${handleMatch[1]}`;
                } else if (platform === 'weibo') {
                    const match = uid.match(/weibo\.com\/u\/(\d+)/);
                    if (match) cleanUid = match[1];
                }
                return cleanUid;
            }

            const getResultUrl = () => {
                if (!uid) return '';
                const p = GENERATOR_PLATFORMS[platform];
                const cleanBase = baseUrl.replace(/\/$/, '');
                let path = '';
                const cleanUid = getSmartUid();

                if (platform === 'youtube') {
                    if (selectedType === 'community') path = `/youtube/community/${cleanUid}`;
                    else path = cleanUid.startsWith('UC') ? `/youtube/channel/${cleanUid}` : `/youtube/user/${cleanUid}`;
                } else if (platform === 'weibo' && selectedType === 'keyword') {
                    path = `/weibo/keyword/${encodeURIComponent(cleanUid)}`;
                } else {
                    const opt = p.options.find(o => o.id === selectedType);
                    if (opt && opt.path) path = `${opt.path}${cleanUid}`;
                }
                
                return path ? `${cleanBase}${path}` : '';
            };

            const resultUrl = getResultUrl();
            const currentPlatform = GENERATOR_PLATFORMS[platform];
            const PlatformIcon = Icons[currentPlatform.icon];
            const showAuthWarning = ['bilibili', 'youtube', 'weibo'].includes(platform);

            const handleAddNode = () => {
                if (baseUrl && !savedNodes.includes(baseUrl)) {
                    setSavedNodes([...savedNodes, baseUrl]);
                    addToast("节点已保存");
                }
            };

            const handleAddToFolo = () => {
                if (resultUrl) {
                    onAddFeed(resultUrl);
                    onClose();
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
                    <div className={cn("w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]", darkMode ? "bg-zinc-900 border border-zinc-800 text-zinc-100" : "bg-white text-zinc-900")}>
                        <div className="p-4 border-b border-gray-200 dark:border-zinc-800 flex justify-between items-center bg-gray-50 dark:bg-zinc-950">
                            <div className="flex items-center gap-3">
                                <div className={cn("p-2 rounded-full text-white shadow-sm", `bg-${currentPlatform.colors.main.split('-')[0]}-${currentPlatform.colors.main.split('-')[1]}`)}>
                                    <PlatformIcon className="w-5 h-5" />
                                </div>
                                <h2 className="text-lg font-bold">RSS 订阅源生成器</h2>
                            </div>
                            <button onClick={onClose}><Icons.X className="w-5 h-5" /></button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                            <div className="mb-6 flex flex-col sm:flex-row items-center gap-2">
                                <label className="text-sm font-medium text-gray-500 whitespace-nowrap">RSSHub 节点:</label>
                                <div className="relative flex-1 w-full group">
                                    <input 
                                        type="text" 
                                        value={baseUrl} 
                                        onChange={e => setBaseUrl(e.target.value)}
                                        className={cn("w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2", darkMode ? "bg-zinc-800 border-zinc-700 focus:ring-orange-500" : "bg-white border-gray-300 focus:ring-orange-500")}
                                        placeholder="输入 RSSHub 域名"
                                    />
                                    <button onClick={() => setDropdownOpen(!dropdownOpen)} className="absolute inset-y-0 right-0 px-2 text-gray-400 hover:text-orange-500"><Icons.ChevronDown className="w-4 h-4"/></button>
                                    
                                    {dropdownOpen && (
                                        <div className={cn("absolute top-full left-0 w-full mt-1 border rounded-md shadow-xl z-50 max-h-40 overflow-y-auto", darkMode ? "bg-zinc-800 border-zinc-700" : "bg-white border-gray-200")}>
                                            {savedNodes.map(node => (
                                                <div key={node} className="flex justify-between items-center px-3 py-2 hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer">
                                                    <span onClick={() => { setBaseUrl(node); setDropdownOpen(false); }} className="text-xs truncate flex-1">{node}</span>
                                                    <button onClick={() => setSavedNodes(savedNodes.filter(n => n !== node))} className="text-gray-400 hover:text-red-500"><Icons.Trash className="w-3 h-3"/></button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <button onClick={handleAddNode} className="p-2 rounded bg-orange-100 text-orange-600 hover:bg-orange-200"><Icons.Plus className="w-5 h-5"/></button>
                            </div>

                            <div className="flex overflow-x-auto no-scrollbar gap-2 mb-6 pb-2 border-b border-gray-100 dark:border-zinc-800">
                                {Object.values(GENERATOR_PLATFORMS).map(p => {
                                    const PIcon = Icons[p.icon];
                                    const isActive = platform === p.id;
                                    return (
                                        <button 
                                            key={p.id}
                                            onClick={() => setPlatform(p.id)}
                                            className={cn("flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap", 
                                                isActive 
                                                    ? `bg-${p.colors.main.split('-')[0]}-50 text-${p.colors.main.split('-')[0]}-600 ring-1 ring-${p.colors.main.split('-')[0]}-200` 
                                                    : "bg-gray-50 dark:bg-zinc-800 text-gray-500 hover:bg-gray-100 dark:hover:bg-zinc-700"
                                            )}
                                        >
                                            <PIcon className="w-4 h-4" />
                                            {p.name}
                                        </button>
                                    );
                                })}
                            </div>

                             {/* Auth Warning */}
                            {showAuthWarning && (
                                <div className="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md flex gap-2 text-xs text-yellow-700 dark:text-yellow-400">
                                    <Icons.AlertTriangle className="w-4 h-4 shrink-0 mt-0.5" />
                                    <p>提示：此源通常需要在 RSSHub 部署端配置 <b>Cookie</b> 或 <b>API Key</b> 才能正常抓取（如高清画质/仅粉可见）。</p>
                                </div>
                            )}

                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">1. 输入链接或 ID</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <Icons.Link className={cn("h-5 w-5", uid ? "text-green-500" : "text-gray-400")} />
                                    </div>
                                    <input
                                        type="text"
                                        value={uid}
                                        onChange={handleInputChange}
                                        className={cn("block w-full pl-10 pr-4 py-3 border rounded-md focus:outline-none focus:ring-2 transition-colors", 
                                            darkMode ? "bg-zinc-800 border-zinc-700 focus:ring-orange-500" : "bg-white border-gray-300 focus:ring-orange-500",
                                            uid ? (darkMode ? "bg-green-900/10" : "bg-green-50") : ""
                                        )}
                                        placeholder={currentPlatform.placeholder}
                                    />
                                </div>
                            </div>

                            <div className="mb-8">
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">2. 选择订阅类型</label>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    {currentPlatform.options.map(opt => {
                                        const OptIcon = Icons[opt.icon];
                                        const isSel = selectedType === opt.id;
                                        return (
                                            <div 
                                                key={opt.id}
                                                onClick={() => setSelectedType(opt.id)}
                                                className={cn("cursor-pointer relative rounded-lg border p-3 flex items-start space-x-3 transition-all", 
                                                    isSel 
                                                        ? (darkMode ? "bg-orange-900/20 border-orange-500/50 ring-1 ring-orange-500" : "bg-orange-50 border-orange-200 ring-1 ring-orange-500") 
                                                        : (darkMode ? "bg-zinc-800 border-zinc-700 hover:border-zinc-600" : "bg-white border-gray-200 hover:border-gray-300")
                                                )}
                                            >
                                                <div className={cn("mt-0.5", isSel ? "text-orange-500" : "text-gray-400")}><OptIcon className="w-5 h-5"/></div>
                                                <div className="flex-1">
                                                    <p className={cn("text-sm font-medium", isSel ? (darkMode ? "text-orange-400" : "text-gray-900") : (darkMode ? "text-gray-300" : "text-gray-900"))}>{opt.label}</p>
                                                    <p className="text-xs text-gray-500">{opt.desc}</p>
                                                </div>
                                                {isSel && <Icons.CheckCircle className="w-5 h-5 text-orange-500" />}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className={cn("p-4 rounded-lg border transition-all", resultUrl ? "opacity-100" : "opacity-50 grayscale pointer-events-none", darkMode ? "bg-zinc-950 border-zinc-800" : "bg-gray-50 border-gray-200")}>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">生成结果</label>
                                <div className="flex rounded-md shadow-sm">
                                    <input
                                        type="text"
                                        readOnly
                                        value={resultUrl || '等待输入...'}
                                        className={cn("flex-1 block w-full rounded-l-md sm:text-sm border py-2 pl-3 font-mono focus:outline-none", darkMode ? "bg-zinc-900 border-zinc-700 text-zinc-300" : "bg-white border-gray-300 text-gray-600")}
                                    />
                                    <button
                                        onClick={handleAddToFolo}
                                        className="relative -ml-px inline-flex items-center space-x-2 px-4 py-2 border border-transparent text-sm font-medium rounded-r-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none"
                                    >
                                        <Icons.Plus className="h-4 w-4" />
                                        <span>添加订阅</span>
                                    </button>
                                </div>
                                {resultUrl && (
                                    <div className="mt-2 flex justify-center">
                                        <a href={resultUrl} target="_blank" className="text-xs text-gray-400 hover:text-orange-500 flex items-center gap-1">
                                            <Icons.ExternalLink className="w-3 h-3" /> 在浏览器中预览
                                        </a>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AppContent = () => {
            const getInitialState = (key, defaultVal) => {
                try {
                    const seedScript = document.getElementById('app-data');
                    if (seedScript && seedScript.textContent !== 'null') {
                        const seed = JSON.parse(seedScript.textContent);
                        if (seed && seed[key]) return seed[key];
                    }
                } catch (e) { console.error("Seed Parse Error", e); }

                try {
                    const saved = localStorage.getItem(`folo_${key}`);
                    if (saved) return JSON.parse(saved);
                } catch (e) { console.error("LS Error", e); }

                return defaultVal;
            };

            const [feeds, setFeeds] = useState(() => getInitialState('feeds', INITIAL_FEEDS));
            const [favorites, setFavorites] = useState(() => getInitialState('favorites', []));
            const [rsshubNodes, setRsshubNodes] = useState(() => getInitialState('rsshubNodes', DEFAULT_RSSHUB_NODES));
            
            // --- AI Profiles State Migration Logic ---
            const [aiProfiles, setAiProfiles] = useState(() => {
                const saved = getInitialState('aiProfiles', null);
                if (saved) return saved;
                
                // Migrate from old config if it exists
                const oldConfig = getInitialState('aiConfig', null);
                if (oldConfig && oldConfig.apiKey) {
                    return [{
                        id: 'migrated-default',
                        name: '默认配置 (已迁移)',
                        provider: oldConfig.provider || 'openai',
                        baseUrl: oldConfig.baseUrl,
                        apiKey: oldConfig.apiKey,
                        model: oldConfig.model
                    }, ...DEFAULT_PROFILES];
                }
                return DEFAULT_PROFILES;
            });
            const [activeProfileId, setActiveProfileId] = useState(() => getInitialState('activeProfileId', 'default-deepseek'));
            
            const [articles, setArticles] = useState([]);
            const [selectedArticle, setSelectedArticle] = useState(null);
            const [selectedFeedId, setSelectedFeedId] = useState('ALL');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [loading, setLoading] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);
            const [aiSummary, setAiSummary] = useState(null);
            const [aiReasoning, setAiReasoning] = useState(null); // Separate state for reasoning
            const [newFeedUrl, setNewFeedUrl] = useState('');
            const [darkMode, setDarkMode] = useState(true);
            const [isAdding, setIsAdding] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showBackupModal, setShowBackupModal] = useState(false);
            const [showOPMLModal, setShowOPMLModal] = useState(false);
            const [showGenerator, setShowGenerator] = useState(false);
            const [toasts, setToasts] = useState([]);

            useEffect(() => { localStorage.setItem('folo_feeds', JSON.stringify(feeds)); }, [feeds]);
            useEffect(() => { localStorage.setItem('folo_favorites', JSON.stringify(favorites)); }, [favorites]);
            useEffect(() => { localStorage.setItem('folo_aiProfiles', JSON.stringify(aiProfiles)); }, [aiProfiles]);
            useEffect(() => { localStorage.setItem('folo_activeProfileId', JSON.stringify(activeProfileId)); }, [activeProfileId]);
            useEffect(() => { localStorage.setItem('folo_rsshubNodes', JSON.stringify(rsshubNodes)); }, [rsshubNodes]);

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            const addToast = (msg, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

            const loadArticles = async (feedList) => {
                setLoading(true);
                const list = feedList.length > 0 ? feedList : []; 
                
                if (list.length === 0) {
                    setArticles([]);
                    setLoading(false);
                    return;
                }

                const promises = list.map(async feed => {
                    const items = await fetchRSS(feed.url);
                    return items.map(i => ({ ...i, feedId: feed.id }));
                });
                
                const results = await Promise.all(promises);
                const flat = results.flat();
                
                const uniqueMap = new Map();
                flat.forEach(item => uniqueMap.set(item.id, item));
                const sorted = Array.from(uniqueMap.values()).sort((a, b) => new Date(b.isoDate) - new Date(a.isoDate));
                
                setArticles(sorted);
                setLoading(false);
            };

            useEffect(() => { 
                loadArticles(feeds);
            }, [feeds]);

            const handleImportFeeds = (newFeeds) => {
                const currentUrls = new Set(feeds.map(f => f.url));
                const uniqueNewFeeds = newFeeds.filter(f => !currentUrls.has(f.url));
                if (uniqueNewFeeds.length > 0) {
                    setFeeds([...feeds, ...uniqueNewFeeds]);
                    addToast(`成功导入 ${uniqueNewFeeds.length} 个订阅源`);
                } else {
                    addToast("所有订阅源已存在", "error");
                }
            };

            const handleExportFeeds = () => {
                const opmlContent = generateOPML(feeds);
                const blob = new Blob([opmlContent], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'folo_feeds.opml';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                addToast("OPML 文件已导出");
            };

            const processDownload = (options) => {
                try {
                    const backupData = { 
                        feeds: options.feeds ? feeds : [], 
                        favorites: options.favorites ? favorites : [], 
                        aiProfiles: options.settings ? aiProfiles : DEFAULT_PROFILES, 
                        activeProfileId: options.settings ? activeProfileId : 'default-deepseek',
                        rsshubNodes: options.nodes ? rsshubNodes : DEFAULT_RSSHUB_NODES
                    };
                    let htmlContent = document.documentElement.outerHTML;
                    
                    const scriptTagRegex = new RegExp('<script id="app-data" type="application/json">([\\s\\S]*?)<\\/script>');
                    const closingTag = '<' + '/script>';
                    const newScriptTag = `<script id="app-data" type="application/json">${JSON.stringify(backupData)}${closingTag}`;
                    
                    htmlContent = htmlContent.replace(scriptTagRegex, newScriptTag);

                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `FoloMini_Backup_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    addToast("下载成功！");
                    setShowBackupModal(false);
                } catch (e) {
                    console.error(e);
                    addToast("下载失败", "error");
                }
            };

            const displayedArticles = useMemo(() => {
                if (selectedFeedId === 'FAVORITES') return favorites.sort((a, b) => new Date(b.isoDate) - new Date(a.isoDate));
                if (selectedFeedId === 'ALL') return articles;
                return articles.filter(a => a.feedId === selectedFeedId);
            }, [selectedFeedId, articles, favorites]);

            const toggleFavorite = (e, article) => {
                e.stopPropagation();
                const existing = favorites.find(f => f.id === article.id);
                if (existing) {
                    setFavorites(prev => prev.filter(f => f.id !== article.id));
                    addToast("已取消收藏");
                } else {
                    setFavorites(prev => [...prev, {
                        ...article,
                        savedAt: new Date().toISOString()
                    }]);
                    addToast("已添加收藏");
                }
            };

            const isFavorite = (article) => favorites.some(f => f.id === article.id);

            const addFeed = async (e) => {
                e.preventDefault();
                if (!newFeedUrl) {
                    setShowOPMLModal(true);
                    return;
                }
                setIsAdding(true);
                const items = await fetchRSS(newFeedUrl);
                if (items.length > 0) {
                    const exists = feeds.some(f => f.url === newFeedUrl);
                    if (!exists) {
                        setFeeds(prev => [...prev, {
                            id: Date.now().toString(),
                            url: newFeedUrl, 
                            title: items[0].feedTitle || 'New Feed', 
                            createdAt: new Date().toISOString()
                        }]);
                        setNewFeedUrl('');
                        addToast("订阅成功");
                    } else {
                        addToast("该源已存在", "error");
                    }
                } else {
                    addToast("无法解析该 RSS 地址", "error");
                }
                setIsAdding(false);
            };

            const handleAddGeneratedFeed = (url) => {
                 setNewFeedUrl(url); // Pre-fill
                 // Immediately try to add
                 setIsAdding(true);
                 fetchRSS(url).then(items => {
                     if(items.length > 0) {
                         const exists = feeds.some(f => f.url === url);
                         if(!exists) {
                             setFeeds(prev => [...prev, { id: Date.now().toString(), url: url, title: items[0].feedTitle || 'New Feed', createdAt: new Date().toISOString() }]);
                             setNewFeedUrl('');
                             addToast("订阅成功");
                         } else addToast("该源已存在", "error");
                     } else addToast("无法解析生成的 RSS", "error");
                     setIsAdding(false);
                 });
            };

            const delFeed = (id) => {
                if (confirm('确定删除此订阅源吗?')) {
                    if (selectedFeedId === id) setSelectedFeedId('ALL');
                    setFeeds(prev => prev.filter(f => f.id !== id));
                    addToast("已删除订阅源");
                }
            };

            const saveSettings = (cfg) => {
                setShowSettings(false);
                addToast("设置已保存");
            };

            const getSummary = async () => {
                if (!selectedArticle) return;
                const config = aiProfiles.find(p => p.id === activeProfileId);
                if (!config) {
                    addToast("未找到有效的 AI 配置", "error");
                    return;
                }

                setAiLoading(true);
                setAiSummary("");
                setAiReasoning(null);
                const text = (selectedArticle.content || selectedArticle.description || '').replace(/<[^>]+>/g, '');
                
                await streamSummary(
                    selectedArticle.title + "\n" + text, 
                    config,
                    (reasoning) => setAiReasoning(prev => (prev || "") + reasoning),
                    (content) => setAiSummary(prev => (prev || "") + content),
                    () => setAiLoading(false),
                    (err) => {
                        setAiSummary(prev => (prev || "") + "\n\n[错误: " + err + "]");
                        setAiLoading(false);
                    }
                );
            };

            const getActiveTitle = () => {
                if (selectedFeedId === 'ALL') return '最新文章';
                if (selectedFeedId === 'FAVORITES') return '我的收藏';
                return (feeds.find(f => f.id === selectedFeedId) || INITIAL_FEEDS.find(f => f.id === selectedFeedId))?.title || '频道文章';
            };

            return (
                <div className={cn("flex h-screen w-full overflow-hidden transition-colors duration-300 font-sans selection:bg-orange-200 selection:text-orange-900", darkMode ? "bg-zinc-950 text-zinc-100 selection:bg-orange-900 selection:text-orange-100" : "bg-zinc-50 text-zinc-900")}>
                    <Toast toasts={toasts} removeToast={removeToast} />
                    <SettingsModal 
                        open={showSettings} 
                        onClose={() => setShowSettings(false)} 
                        profiles={aiProfiles}
                        activeProfileId={activeProfileId}
                        onSaveProfiles={setAiProfiles}
                        onSetActiveProfile={setActiveProfileId}
                        darkMode={darkMode} 
                        addToast={addToast} 
                    />
                    <BackupModal 
                        open={showBackupModal} 
                        onClose={() => setShowBackupModal(false)}
                        onConfirm={processDownload}
                        stats={{
                            feedsCount: feeds.length,
                            favoritesCount: favorites.length,
                            profilesCount: aiProfiles.length,
                            nodesCount: rsshubNodes.length
                        }}
                        darkMode={darkMode}
                    />
                    <RSSGeneratorModal 
                        open={showGenerator} 
                        onClose={() => setShowGenerator(false)} 
                        onAddFeed={handleAddGeneratedFeed} 
                        darkMode={darkMode} 
                        addToast={addToast}
                        savedNodes={rsshubNodes}
                        setSavedNodes={setRsshubNodes}
                    />
                    <OPMLModal
                        open={showOPMLModal}
                        onClose={() => setShowOPMLModal(false)}
                        onImport={handleImportFeeds}
                        onExport={handleExportFeeds}
                        darkMode={darkMode}
                    />

                    {/* Sidebar */}
                    <div className={cn("flex flex-col border-r transition-all duration-300 absolute md:relative z-20 h-full shadow-xl md:shadow-none", darkMode ? "border-zinc-800 bg-zinc-950/95" : "border-zinc-200 bg-white/95", sidebarOpen ? "w-64 translate-x-0" : "w-0 -translate-x-full md:w-0 md:translate-x-0 opacity-0 md:opacity-100 overflow-hidden")}>
                        <div className="p-4 flex items-center justify-between border-b border-zinc-800/50 h-14 shrink-0">
                            <div className="flex items-center gap-2 font-bold text-lg tracking-tight"><Icons.Rss className="w-5 h-5 text-orange-600" /><span>Folo Mini <span className="text-[10px] bg-zinc-100 dark:bg-zinc-800 text-zinc-500 px-1 py-0.5 rounded ml-1">Local</span></span></div>
                            <button onClick={() => setSidebarOpen(false)} className="md:hidden"><Icons.X className="w-5 h-5" /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-3 custom-scrollbar">
                            <div className="space-y-1 mb-6">
                                <div 
                                    onClick={() => { setSelectedFeedId('ALL'); if(window.innerWidth < 768) setSidebarOpen(false); }}
                                    className={cn("flex items-center gap-3 px-3 py-2 rounded-lg text-sm cursor-pointer transition-all", selectedFeedId === 'ALL' ? (darkMode ? "bg-zinc-800 text-orange-400" : "bg-orange-50 text-orange-700 font-medium") : "text-zinc-500 hover:bg-zinc-100 dark:hover:bg-zinc-900")}
                                >
                                    <Icons.Layers className="w-4 h-4" />
                                    <span>全部文章</span>
                                </div>
                                <div 
                                    onClick={() => { setSelectedFeedId('FAVORITES'); if(window.innerWidth < 768) setSidebarOpen(false); }}
                                    className={cn("flex items-center gap-3 px-3 py-2 rounded-lg text-sm cursor-pointer transition-all", selectedFeedId === 'FAVORITES' ? (darkMode ? "bg-zinc-800 text-yellow-400" : "bg-yellow-50 text-yellow-700 font-medium") : "text-zinc-500 hover:bg-zinc-100 dark:hover:bg-zinc-900")}
                                >
                                    <Icons.Star className={cn("w-4 h-4", selectedFeedId === 'FAVORITES' ? "fill-current" : "")} />
                                    <span>我的收藏</span>
                                </div>
                            </div>

                            <div className="text-[10px] font-bold text-zinc-500 mb-2 px-2 uppercase tracking-wider flex justify-between items-center">
                                <span>我的订阅</span>
                                <span className="text-zinc-600">{feeds.length}</span>
                            </div>
                            <div className="space-y-0.5">
                                {feeds.map(feed => (
                                    <div 
                                        key={feed.id} 
                                        onClick={() => { setSelectedFeedId(feed.id); if(window.innerWidth < 768) setSidebarOpen(false); }}
                                        className={cn(
                                            "group flex items-center justify-between px-3 py-2 rounded-md text-sm cursor-pointer transition-all",
                                            selectedFeedId === feed.id
                                                ? (darkMode ? "bg-zinc-800 text-white" : "bg-white shadow-sm border border-zinc-200 text-black")
                                                : (darkMode ? "text-zinc-400 hover:bg-zinc-900" : "text-zinc-600 hover:bg-zinc-100")
                                        )}
                                    >
                                        <span className="truncate flex-1">{feed.title}</span>
                                        <button onClick={(e) => { e.stopPropagation(); delFeed(feed.id); }} className="opacity-0 group-hover:opacity-100 text-zinc-400 hover:text-red-500 p-1 transition-opacity"><Icons.Trash className="w-3.5 h-3.5" /></button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="p-3 border-t border-zinc-800/50 flex flex-col gap-2 shrink-0 bg-zinc-50/50 dark:bg-zinc-900/50">
                            <form onSubmit={addFeed} className="flex gap-2">
                                <input type="url" placeholder="输入 RSS 地址..." value={newFeedUrl} onChange={e => setNewFeedUrl(e.target.value)} className={cn("flex-1 px-3 py-2 text-xs rounded-md border outline-none transition-all", darkMode ? "bg-zinc-950 border-zinc-800 focus:border-zinc-700" : "bg-white border-zinc-300 focus:border-zinc-400")} />
                                <button type="button" onClick={() => setShowGenerator(true)} className="p-2 bg-purple-500 hover:bg-purple-600 text-white rounded-md transition-colors" title="RSS 生成器"><Icons.Wand className="w-4 h-4"/></button>
                                <button type="submit" disabled={isAdding} className="p-2 bg-orange-600 hover:bg-orange-700 text-white rounded-md disabled:opacity-50 transition-colors">{isAdding ? <Icons.Loader className="w-4 h-4"/> : <Icons.Plus className="w-4 h-4"/>}</button>
                            </form>
                            <div className="flex gap-2">
                                <button onClick={() => setShowSettings(true)} className={cn("flex-1 flex items-center justify-center gap-2 py-2 text-xs rounded-md border border-dashed transition-colors", darkMode ? "border-zinc-800 hover:bg-zinc-900 text-zinc-500" : "border-zinc-300 hover:bg-white text-zinc-600")}><Icons.Settings className="w-3.5 h-3.5" /> AI</button>
                                <button onClick={() => setShowBackupModal(true)} className={cn("flex-1 flex items-center justify-center gap-2 py-2 text-xs rounded-md border border-dashed transition-colors", darkMode ? "border-zinc-800 hover:bg-zinc-900 text-purple-400" : "border-zinc-300 hover:bg-white text-purple-600")} title="下载当前版本（包含所有数据）"><Icons.Download className="w-3.5 h-3.5" /> 备份</button>
                            </div>
                        </div>
                    </div>

                    {/* Article List */}
                    <div className={cn("flex flex-col w-full md:w-80 lg:w-96 border-r transition-all duration-300 shrink-0", darkMode ? "border-zinc-800 bg-zinc-900" : "border-zinc-200 bg-zinc-50", selectedArticle ? "hidden md:flex" : "flex")}>
                        <div className="h-14 flex items-center justify-between px-4 border-b border-zinc-800/10 shrink-0 bg-white/50 dark:bg-zinc-900/50 backdrop-blur-sm">
                            <div className="flex items-center gap-3 overflow-hidden">
                                <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-1 hover:bg-zinc-700/10 rounded-md transition-colors"><Icons.Menu className="w-5 h-5 text-zinc-500" /></button>
                                <h2 className="font-semibold truncate text-sm">{getActiveTitle()}</h2>
                            </div>
                            <button onClick={() => loadArticles(feeds)} className="p-1.5 rounded-full hover:bg-zinc-500/10 text-zinc-500 transition-colors"><Icons.Refresh className={cn("w-4 h-4", loading && "animate-spin")} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                            {loading && articles.length === 0 ? (
                                <div className="flex flex-col justify-center items-center h-40 gap-2 text-zinc-500 text-xs">
                                    <Icons.Loader className="w-6 h-6 animate-spin"/>
                                    <span>正在获取最新的内容...</span>
                                </div>
                            ) : displayedArticles.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-40 text-zinc-400 text-sm gap-2">
                                    <Icons.Rss className="w-8 h-8 opacity-20"/>
                                    <span>{selectedFeedId === 'FAVORITES' ? '暂无收藏' : '没有找到文章'}</span>
                                </div>
                            ) : (
                                displayedArticles.map((article) => {
                                    const fav = isFavorite(article);
                                    const isActive = selectedArticle?.id === article.id;
                                    return (
                                        <div key={article.id} onClick={() => { setSelectedArticle(article); setAiSummary(null); setAiReasoning(null); }} className={cn("p-4 border-b cursor-pointer transition-all relative group", darkMode ? "border-zinc-800 hover:bg-zinc-800/60" : "border-zinc-200 hover:bg-white", isActive && (darkMode ? "bg-zinc-800/80 border-l-2 border-l-orange-500" : "bg-white shadow-sm border-l-2 border-l-orange-500"))}>
                                            <div className="flex items-center justify-between mb-1.5">
                                                <div className="flex items-center gap-2 overflow-hidden">
                                                    <span className={cn("text-[10px] font-bold px-1.5 py-0.5 rounded uppercase max-w-[120px] truncate", darkMode ? "bg-zinc-800 text-zinc-400" : "bg-zinc-200 text-zinc-600")}>{article.feedTitle}</span>
                                                    <span className="text-[10px] text-zinc-500 shrink-0">{new Date(article.isoDate).toLocaleDateString()}</span>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    {article.mediaUrl && (
                                                        <span className="text-zinc-400" title={article.mediaType?.includes('video') ? "包含视频" : "包含音频"}>
                                                            {article.mediaType?.includes('video') ? <Icons.Film className="w-3.5 h-3.5" /> : <Icons.PlayCircle className="w-3.5 h-3.5" />}
                                                        </span>
                                                    )}
                                                    <button 
                                                        onClick={(e) => toggleFavorite(e, article)}
                                                        className={cn("p-1.5 rounded-full transition-all md:opacity-0 group-hover:opacity-100 focus:opacity-100", fav ? "text-yellow-500 opacity-100" : "text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-yellow-500")}
                                                    >
                                                        <Icons.Star className={cn("w-3.5 h-3.5", fav ? "fill-current" : "")} />
                                                    </button>
                                                </div>
                                            </div>
                                            <h3 className={cn("font-medium text-sm leading-snug line-clamp-2 mb-1.5", darkMode ? "text-zinc-200" : "text-zinc-800")}>{article.title}</h3>
                                            <p className="text-xs text-zinc-500 leading-relaxed line-clamp-2">{(article.description || '').replace(/<[^>]+>/g, '').substring(0, 120)}</p>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>

                    {/* Reader */}
                    <div className={cn("flex-1 flex flex-col h-full absolute inset-0 md:relative z-30 md:z-0 bg-white dark:bg-zinc-950 transition-transform duration-300", !selectedArticle ? "translate-x-full md:translate-x-0" : "translate-x-0")}>
                        {selectedArticle ? (
                            <>
                                <div className={cn("h-14 flex items-center justify-between px-4 border-b shrink-0", darkMode ? "border-zinc-800 bg-zinc-950" : "border-zinc-200 bg-white")}>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => setSelectedArticle(null)} className="md:hidden p-2 -ml-2 text-zinc-500 hover:text-zinc-800 dark:hover:text-zinc-200"><Icons.Left className="w-5 h-5" /></button>
                                        <div className="hidden md:block text-xs text-zinc-400 px-2 py-1 bg-zinc-100 dark:bg-zinc-900 rounded">来源: {selectedArticle.feedTitle}</div>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        <button 
                                            onClick={(e) => toggleFavorite(e, selectedArticle)}
                                            className={cn("p-2 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-900 transition-colors", isFavorite(selectedArticle) ? "text-yellow-500" : "text-zinc-400")}
                                            title="收藏"
                                        >
                                            <Icons.Star className={cn("w-4 h-4", isFavorite(selectedArticle) ? "fill-current" : "")} />
                                        </button>
                                        <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-900 text-zinc-400 transition-colors" title="切换模式">{darkMode ? <Icons.Sun className="w-4 h-4"/> : <Icons.Moon className="w-4 h-4"/>}</button>
                                        <a href={selectedArticle.link} target="_blank" className="p-2 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-900 text-zinc-400 transition-colors" title="原文链接"><Icons.ExternalLink className="w-4 h-4"/></a>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar scroll-smooth">
                                    <div className="max-w-3xl mx-auto p-6 md:p-12">
                                        <h1 className="text-2xl md:text-4xl font-bold mb-6 text-zinc-900 dark:text-zinc-50 leading-tight">
                                            <a 
                                                href={selectedArticle.link} 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                className="hover:text-orange-600 dark:hover:text-orange-400 hover:underline decoration-2 underline-offset-4 transition-colors"
                                                title="点击访问原网页"
                                            >
                                                {selectedArticle.title}
                                            </a>
                                        </h1>
                                        <div className="flex gap-4 text-sm text-zinc-500 mb-8 pb-4 border-b border-zinc-200 dark:border-zinc-800">
                                            <span>{selectedArticle.author || selectedArticle.feedTitle}</span>
                                            <span>&bull;</span>
                                            <span>{new Date(selectedArticle.isoDate).toLocaleString()}</span>
                                        </div>
                                        
                                        {/* Media Player */}
                                        {selectedArticle.mediaUrl && (
                                            <div className="mb-8 p-4 bg-zinc-100 dark:bg-zinc-900 rounded-xl">
                                                {selectedArticle.mediaType?.includes('video') ? (
                                                    <video controls className="w-full rounded-lg aspect-video bg-black" src={selectedArticle.mediaUrl} preload="metadata">
                                                        您的浏览器不支持视频播放。
                                                    </video>
                                                ) : (
                                                    <audio controls className="w-full" src={selectedArticle.mediaUrl} preload="metadata">
                                                        您的浏览器不支持音频播放。
                                                    </audio>
                                                )}
                                                <div className="mt-2 text-xs text-zinc-400 flex items-center justify-end gap-1">
                                                    {selectedArticle.mediaType?.includes('video') ? <Icons.Film className="w-3 h-3"/> : <Icons.PlayCircle className="w-3 h-3"/>}
                                                    <span>{selectedArticle.mediaType?.includes('video') ? '视频附件' : '音频附件'}</span>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* AI Summary Block */}
                                        <div className={cn("mb-10 rounded-xl overflow-hidden border transition-all", darkMode ? "bg-zinc-900/30 border-purple-900/30" : "bg-purple-50/50 border-purple-100")}>
                                            <div className="px-5 py-3 flex justify-between items-center border-b border-zinc-500/10 bg-zinc-50/50 dark:bg-white/5">
                                                <div className="flex items-center gap-2 text-sm font-semibold text-purple-600 dark:text-purple-400"><Icons.Sparkles className="w-4 h-4" /> AI 智能概览</div>
                                                {!aiSummary && !aiReasoning && !aiLoading && <button onClick={getSummary} className="text-xs bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 hover:border-purple-500 text-zinc-600 dark:text-zinc-300 px-3 py-1.5 rounded-full transition-all shadow-sm">点击生成摘要</button>}
                                            </div>
                                            {(aiSummary || aiReasoning || aiLoading) && (
                                                <div className="p-5 text-sm leading-relaxed text-zinc-700 dark:text-zinc-300">
                                                    
                                                    {/* Reasoning Block */}
                                                    {aiReasoning && (
                                                        <details className="mb-4 group">
                                                            <summary className="text-xs text-zinc-400 dark:text-zinc-500 font-medium hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors flex items-center gap-1 select-none">
                                                                <Icons.Brain className="w-3 h-3" />
                                                                <span>深度思考过程</span>
                                                                <Icons.ChevronDown className="w-3 h-3 transition-transform group-open:rotate-180" />
                                                            </summary>
                                                            <div className="mt-2 pl-3 border-l-2 border-zinc-200 dark:border-zinc-800">
                                                                <div className="prose prose-xs dark:prose-invert text-zinc-500 dark:text-zinc-400 max-w-none">
                                                                    <React.Fragment>
                                                                        {aiReasoning.split('\n').map((line, i) => <p key={i} className="my-1">{line}</p>)}
                                                                    </React.Fragment>
                                                                </div>
                                                            </div>
                                                        </details>
                                                    )}

                                                    {aiSummary ? (
                                                        <div className="prose prose-sm dark:prose-invert max-w-none">
                                                            <React.Fragment>
                                                                {aiSummary.split('\n').map((line, i) => <p key={i}>{line}</p>)}
                                                            </React.Fragment>
                                                        </div>
                                                    ) : (
                                                        <div className="flex flex-col gap-2 animate-pulse">
                                                            <div className="h-4 bg-zinc-200 dark:bg-zinc-800 rounded w-3/4"></div>
                                                            <div className="h-4 bg-zinc-200 dark:bg-zinc-800 rounded w-full"></div>
                                                            <div className="h-4 bg-zinc-200 dark:bg-zinc-800 rounded w-2/3"></div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>

                                        <div className={cn("prose max-w-none break-words pb-20", darkMode ? "prose-invert prose-p:text-zinc-300 prose-headings:text-zinc-100 prose-a:text-orange-400 hover:prose-a:text-orange-300 prose-blockquote:border-orange-500" : "prose-zinc prose-a:text-orange-600 hover:prose-a:text-orange-700 prose-blockquote:border-orange-500")} dangerouslySetInnerHTML={{ __html: selectedArticle.content || selectedArticle.description }} />
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full text-zinc-400 select-none">
                                <div className="w-20 h-20 bg-zinc-100 dark:bg-zinc-900 rounded-full flex items-center justify-center mb-6 animate-pulse"><Icons.Rss className="w-10 h-10 opacity-30" /></div>
                                <p className="text-lg font-medium">Folo Mini</p>
                                <p className="text-sm opacity-60 mt-2">选择左侧文章开始阅读</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppContent />);
    </script>
</body>
</html>