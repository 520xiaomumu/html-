<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Group Chat Theater - Ultra Config</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: { 850: '#1f1f22', 950: '#09090b' },
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Icons & Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.5); }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .fade-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; padding: 10px 16px; border-radius: 8px; color: white; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: fadeIn 0.3s ease; max-width: 300px; }
        .toast.error { background-color: #ef4444; }
        .toast.success { background-color: #22c55e; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Defaults ---
        const DEFAULT_MODEL_CONFIGS = [
            {
                id: 'config-1',
                name: 'DeepSeek API',
                provider: 'openai',
                baseUrl: 'https://api.deepseek.com',
                apiKey: '',
                model: 'deepseek-chat'
            },
            {
                id: 'config-2',
                name: 'Google Gemini',
                provider: 'google',
                baseUrl: 'https://generativelanguage.googleapis.com',
                apiKey: '',
                model: 'gemini-1.5-flash'
            }
        ];

        const DEFAULT_SYSTEM_PROMPTS = [
            {
                id: 'prompt-1',
                name: '理中客助手',
                content: '你是一个理智、客观、有逻辑的助手。你的回答通常比较正式，喜欢列出一二三点。你不会轻易发火。'
            },
            {
                id: 'prompt-2',
                name: '暴躁老哥',
                content: '你是一个脾气暴躁、说话直接、喜欢吐槽和抬杠的网友。你看不惯别人装模作样，喜欢用讽刺的语气。你经常使用“笑死”、“得了吧”等口语。'
            },
            {
                id: 'prompt-3',
                name: '吃瓜群众',
                content: '你是一个典型的“吃瓜群众”，性格随和，有点迷糊。你喜欢发颜文字，经常说些有的没的，或者在气氛紧张时打圆场。你不擅长解决复杂问题，但擅长活跃气氛。'
            }
        ];

        const DEFAULT_AGENTS = [
            { id: 'agent-1', name: '理中客', avatarColor: 'bg-blue-500', configId: 'config-1', promptId: 'prompt-1', enabled: true },
            { id: 'agent-2', name: '暴躁老哥', avatarColor: 'bg-red-500', configId: 'config-1', promptId: 'prompt-2', enabled: true },
            { id: 'agent-3', name: '路人甲', avatarColor: 'bg-green-500', configId: 'config-1', promptId: 'prompt-3', enabled: true }
        ];

        const DEFAULT_DIRECTOR_RULE = `你是一个群聊导演。请根据上下文决定下一位发言者。
可选演员:
{agent_descriptions}

规则:
1. 返回JSON: {"next_speaker_id": "ID", "reason": "理由"}
2. 若无需发言返回 null ID。
3. 尽量让对话自然有趣。
4. 如果用户询问，请指派最合适的角色回答。`;

        // --- Icons ---
        const Icon = ({ path, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{path}</svg>
        );
        const Icons = {
            Plus: (p) => <Icon path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} {...p} />,
            Trash: (p) => <Icon path={<><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} {...p} />,
            X: (p) => <Icon path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} {...p} />,
            Settings: (p) => <Icon path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} {...p} />,
            Send: (p) => <Icon path={<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} {...p} />,
            User: (p) => <Icon path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} {...p} />,
            Moon: (p) => <Icon path={<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>} {...p} />,
            Sun: (p) => <Icon path={<><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>} {...p} />,
            Play: (p) => <Icon path={<polygon points="5 3 19 12 5 21 5 3"/>} {...p} />,
            Pause: (p) => <Icon path={<><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></>} {...p} />,
            Users: (p) => <Icon path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} {...p} />,
            Brain: (p) => <Icon path={<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/>} {...p} />,
            Edit: (p) => <Icon path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>} {...p} />,
            CheckCircle: (p) => <Icon path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} {...p} />,
            Activity: (p) => <Icon path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>} {...p} />,
            Loader: (p) => <Icon path={<path d="M21 12a9 9 0 1 1-6.219-8.56"/>} className={`animate-spin ${p.className}`} {...p} />,
            Save: (p) => <Icon path={<><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></>} {...p} />,
            Database: (p) => <Icon path={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} {...p} />,
            Zap: (p) => <Icon path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} {...p} />,
            FileText: (p) => <Icon path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></>} {...p} />,
            Clapperboard: (p) => <Icon path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></>} {...p} />,
            Download: (p) => <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} {...p} />,
            Copy: (p) => <Icon path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} {...p} />,
            AtSign: (p) => <Icon path={<><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 0 1-3 3H7a5 5 0 1 1 4.5-8"/></>} {...p} />,
        };

        const cn = (...classes) => classes.filter(Boolean).join(' ');

        // --- UI Components ---
        const Toast = ({ toasts, removeToast }) => (
            <div className="toast-container">
                {toasts.map(t => (
                    <div key={t.id} className={`toast ${t.type === 'error' ? 'error' : 'success'}`} onClick={() => removeToast(t.id)}>
                        {t.msg}
                    </div>
                ))}
            </div>
        );

        // --- Logic ---
        const callLLM = async (messages, config, onUpdate, onComplete, onError) => {
            if (!config || !config.apiKey) {
                onError("配置无效：缺少 API Key");
                return;
            }
            
            const baseUrl = (config.baseUrl || 'https://api.deepseek.com').replace(/\/+$/, '');
            let url, body, headers;

            try {
                if (config.provider === 'google') {
                    const model = config.model || 'gemini-1.5-flash';
                    url = `${baseUrl}/v1beta/models/${model}:streamGenerateContent?key=${config.apiKey}&alt=sse`;
                    headers = { 'Content-Type': 'application/json' };
                    body = JSON.stringify({ 
                        contents: messages.map(m => ({
                            role: m.role === 'user' ? 'user' : 'model',
                            parts: [{ text: m.content }]
                        })) 
                    });
                } else {
                    // OpenAI Compatible
                    url = `${baseUrl}/chat/completions`;
                    headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` };
                    body = JSON.stringify({
                        model: config.model || 'deepseek-chat',
                        messages: messages,
                        stream: true
                    });
                }

                // Auto-fix /v1 for OpenAI
                let response = await fetch(url, { method: 'POST', headers, body });
                if (response.status === 404 && config.provider !== 'google' && !url.includes('/v1/')) {
                    const v1Url = `${baseUrl}/v1/chat/completions`;
                    const resV1 = await fetch(v1Url, { method: 'POST', headers, body });
                    if (resV1.status !== 404) response = resV1;
                }

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errText.substring(0,100)}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (config.provider === 'google') {
                            if (trimmed.startsWith('data: ')) {
                                try {
                                    const json = JSON.parse(trimmed.substring(6));
                                    const content = json.candidates?.[0]?.content?.parts?.[0]?.text;
                                    if (content) onUpdate(content);
                                } catch (e) {}
                            }
                        } else {
                            if (trimmed.startsWith('data: ') && trimmed !== 'data: [DONE]') {
                                try {
                                    const json = JSON.parse(trimmed.substring(6));
                                    const content = json.choices?.[0]?.delta?.content;
                                    if (content) onUpdate(content);
                                } catch (e) {}
                            }
                        }
                    }
                }
                onComplete();
            } catch (e) {
                onError(e.message);
            }
        };

        const callGoogle = async (apiKey, baseUrl, model, text) => {
            const url = `${baseUrl}/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
            });
            if (!res.ok) throw new Error(`Google API Error: ${res.status}`);
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        };

        const callOpenAI = async (apiKey, baseUrl, model, text) => {
            let cleanBase = (baseUrl || '').replace(/\/+$/, '');
            let url = `${cleanBase}/chat/completions`;
            
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };
            const body = JSON.stringify({
                model: model,
                messages: [{ role: "user", content: text }],
                stream: false,
                max_tokens: 50
            });

            let res = await fetch(url, { method: 'POST', headers, body });
            if (res.status === 404 && !url.includes('/v1/')) {
                url = `${cleanBase}/v1/chat/completions`;
                res = await fetch(url, { method: 'POST', headers, body });
            }

            if (!res.ok) throw new Error(`API Error: ${res.status}`);
            const data = await res.json();
            return data.choices?.[0]?.message?.content;
        };

        // --- Config Modal (Split Resources) ---
        const GlobalConfigModal = ({ open, onClose, configs, setConfigs, prompts, setPrompts, directorConfigId, setDirectorConfigId, directorRule, setDirectorRule, directorMode, setDirectorMode, contextWindowSize, setContextWindowSize, darkMode, addToast }) => {
            const [activeTab, setActiveTab] = useState('models'); // 'models' | 'prompts' | 'director'
            
            // Models State
            const [editingConfigId, setEditingConfigId] = useState(null);
            const [localConfigs, setLocalConfigs] = useState(configs);
            const [availableModels, setAvailableModels] = useState([]);
            const [isChecking, setIsChecking] = useState(false);
            const [isTesting, setIsTesting] = useState(false);

            // Prompts State
            const [editingPromptId, setEditingPromptId] = useState(null);
            const [localPrompts, setLocalPrompts] = useState(prompts);
            
            // Director State
            const [localDirectorRule, setLocalDirectorRule] = useState(directorRule);
            const [localDirectorMode, setLocalDirectorMode] = useState(directorMode);
            const [localContextWindowSize, setLocalContextWindowSize] = useState(contextWindowSize);

            // Rename State
            const [isRenaming, setIsRenaming] = useState(false);
            const [renameValue, setRenameValue] = useState("");

            useEffect(() => {
                if (open) {
                    setLocalConfigs(configs);
                    setLocalPrompts(prompts);
                    setLocalDirectorRule(directorRule);
                    setLocalDirectorMode(directorMode);
                    setLocalContextWindowSize(contextWindowSize);
                    setEditingConfigId(configs[0]?.id || null);
                    setEditingPromptId(prompts[0]?.id || null);
                    setIsRenaming(false);
                }
            }, [open, configs, prompts, directorRule, directorMode, contextWindowSize]);

            if (!open) return null;

            // --- Model Logic ---
            const activeConfig = localConfigs.find(c => c.id === editingConfigId) || localConfigs[0];
            
            const updateConfig = (field, value) => {
                setLocalConfigs(prev => prev.map(c => c.id === editingConfigId ? { ...c, [field]: value } : c));
            };

            const addConfig = () => {
                const newId = `config-${Date.now()}`;
                const newConfig = { id: newId, name: '新配置', provider: 'openai', baseUrl: 'https://api.deepseek.com', apiKey: '', model: 'deepseek-chat' };
                setLocalConfigs([...localConfigs, newConfig]);
                setEditingConfigId(newId);
                setIsRenaming(false);
            };

            const deleteConfig = () => {
                if (localConfigs.length <= 1) return addToast("至少保留一个模型配置", "error");
                if (confirm(`确定删除 ${activeConfig.name}?`)) {
                    const next = localConfigs.filter(c => c.id !== editingConfigId);
                    setLocalConfigs(next);
                    setEditingConfigId(next[0].id);
                    setIsRenaming(false);
                }
            };

            const fetchModels = async () => {
                if (!activeConfig.apiKey) return addToast("请先填写 API Key", "error");
                setIsChecking(true);
                try {
                    const baseUrl = (activeConfig.baseUrl || '').replace(/\/+$/, '');
                    if (activeConfig.provider === 'google') {
                        const res = await fetch(`${baseUrl}/v1beta/models?key=${activeConfig.apiKey}`);
                        if (!res.ok) throw new Error(res.status);
                        const data = await res.json();
                        const ids = data.models?.filter(m => m.supportedGenerationMethods?.includes("generateContent")).map(m => m.name.replace('models/', '')) || [];
                        setAvailableModels(ids);
                        addToast(`获取到 ${ids.length} 个模型`);
                        if (ids.length && !activeConfig.model) updateConfig('model', ids[0]);
                    } else {
                        let res = await fetch(`${baseUrl}/models`, { headers: { 'Authorization': `Bearer ${activeConfig.apiKey}` } });
                        if (res.status === 404 && !baseUrl.includes('/v1')) res = await fetch(`${baseUrl}/v1/models`, { headers: { 'Authorization': `Bearer ${activeConfig.apiKey}` } });
                        if (!res.ok) throw new Error(res.status);
                        const data = await res.json();
                        const ids = (data.data || []).map(m => m.id).sort();
                        setAvailableModels(ids);
                        addToast(`获取到 ${ids.length} 个模型`);
                        if (ids.length && !activeConfig.model) updateConfig('model', ids[0]);
                    }
                } catch (e) {
                    addToast(`获取失败: ${e.message}`, "error");
                } finally {
                    setIsChecking(false);
                }
            };

            const testModel = async () => {
                if (!activeConfig.apiKey || !activeConfig.model) return addToast("请完善配置", "error");
                setIsTesting(true);
                try {
                    const baseUrl = (activeConfig.baseUrl || '').replace(/\/+$/, '');
                    if (activeConfig.provider === 'google') await callGoogle(activeConfig.apiKey, baseUrl, activeConfig.model, "Hi");
                    else await callOpenAI(activeConfig.apiKey, baseUrl, activeConfig.model, "Hi");
                    addToast("测试通过！模型可用");
                } catch (e) {
                    addToast(`测试失败: ${e.message}`, "error");
                } finally {
                    setIsTesting(false);
                }
            };

            // --- Prompt Logic ---
            const activePrompt = localPrompts.find(p => p.id === editingPromptId) || localPrompts[0];
            
            const updatePrompt = (field, value) => {
                setLocalPrompts(prev => prev.map(p => p.id === editingPromptId ? { ...p, [field]: value } : p));
            };

            const addPrompt = () => {
                const newId = `prompt-${Date.now()}`;
                setLocalPrompts([...localPrompts, { id: newId, name: '新剧本', content: '你是一个...' }]);
                setEditingPromptId(newId);
                setIsRenaming(false);
            };

            const deletePrompt = () => {
                if (localPrompts.length <= 1) return addToast("至少保留一个剧本", "error");
                if (confirm(`确定删除 ${activePrompt.name}?`)) {
                    const next = localPrompts.filter(p => p.id !== editingPromptId);
                    setLocalPrompts(next);
                    setEditingPromptId(next[0].id);
                    setIsRenaming(false);
                }
            };

            const handleSaveAll = () => {
                setConfigs(localConfigs);
                setPrompts(localPrompts);
                setDirectorRule(localDirectorRule);
                setDirectorMode(localDirectorMode);
                setContextWindowSize(Number(localContextWindowSize) || 5);
                addToast("所有配置已保存");
                onClose();
            };

            // Renaming Logic
            const startRename = (currentName) => {
                setRenameValue(currentName);
                setIsRenaming(true);
            };

            const finishRenameModel = () => {
                if(renameValue.trim()) updateConfig('name', renameValue.trim());
                setIsRenaming(false);
            };

            const finishRenamePrompt = () => {
                if(renameValue.trim()) updatePrompt('name', renameValue.trim());
                setIsRenaming(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-enter">
                    <div className={cn("w-full max-w-4xl rounded-xl shadow-2xl flex flex-col h-[85vh]", darkMode ? "bg-zinc-900 border border-zinc-800 text-zinc-100" : "bg-white text-zinc-900")}>
                        
                        {/* Header */}
                        <div className="p-4 border-b border-zinc-200 dark:border-zinc-800 flex justify-between items-center shrink-0">
                            <h3 className="text-lg font-bold flex items-center gap-2"><Icons.Database className="w-5 h-5" /> 全局资源配置中心</h3>
                            <button onClick={onClose}><Icons.X className="w-5 h-5" /></button>
                        </div>

                        <div className="flex flex-1 overflow-hidden">
                            {/* Navigation Sidebar */}
                            <div className="w-48 border-r border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-950/50 p-3 space-y-1 shrink-0">
                                <button onClick={() => { setActiveTab('models'); setIsRenaming(false); }} className={cn("w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors", activeTab === 'models' ? "bg-purple-600 text-white" : "hover:bg-zinc-200 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-400")}>
                                    <Icons.Zap className="w-4 h-4"/> AI 模型连接
                                </button>
                                <button onClick={() => { setActiveTab('prompts'); setIsRenaming(false); }} className={cn("w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors", activeTab === 'prompts' ? "bg-purple-600 text-white" : "hover:bg-zinc-200 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-400")}>
                                    <Icons.FileText className="w-4 h-4"/> 人设剧本库
                                </button>
                                <button onClick={() => { setActiveTab('director'); setIsRenaming(false); }} className={cn("w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors", activeTab === 'director' ? "bg-purple-600 text-white" : "hover:bg-zinc-200 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-400")}>
                                    <Icons.Clapperboard className="w-4 h-4"/> 导演 (规则)
                                </button>
                            </div>

                            {/* Main Content Area */}
                            <div className="flex-1 flex overflow-hidden">
                                {activeTab === 'models' && (
                                    <>
                                        {/* Model List */}
                                        <div className="w-56 border-r border-zinc-200 dark:border-zinc-800 overflow-y-auto p-2">
                                            <div className="flex justify-between items-center px-2 mb-2">
                                                <span className="text-xs font-bold text-zinc-500">已存配置</span>
                                                <button onClick={addConfig} className="text-purple-500 hover:bg-purple-100 dark:hover:bg-purple-900/20 p-1 rounded"><Icons.Plus className="w-3 h-3"/></button>
                                            </div>
                                            {localConfigs.map(c => (
                                                <div key={c.id} onClick={() => { setEditingConfigId(c.id); setAvailableModels([]); setIsRenaming(false); }} className={cn("px-3 py-2 rounded text-sm cursor-pointer truncate mb-1 border", editingConfigId === c.id ? "border-purple-500 bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-300" : "border-transparent hover:bg-zinc-100 dark:hover:bg-zinc-800")}>
                                                    {c.name}
                                                </div>
                                            ))}
                                        </div>
                                        {/* Model Editor */}
                                        <div className="flex-1 p-6 overflow-y-auto custom-scrollbar space-y-5">
                                            {/* Renaming Header */}
                                            <div className="flex justify-between items-center group">
                                                <div className="flex-1 flex items-center gap-2">
                                                    {isRenaming ? (
                                                        <div className="flex items-center gap-2 w-full">
                                                            <input 
                                                                value={renameValue} 
                                                                onChange={e => setRenameValue(e.target.value)}
                                                                onBlur={finishRenameModel}
                                                                onKeyDown={e => e.key === 'Enter' && finishRenameModel()}
                                                                autoFocus
                                                                className={cn("text-lg font-bold bg-transparent border-b-2 border-purple-500 outline-none w-full pb-1", darkMode ? "text-white" : "text-zinc-900")} 
                                                            />
                                                            <button onClick={finishRenameModel} className="text-green-500 hover:text-green-600"><Icons.CheckCircle className="w-5 h-5"/></button>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-center gap-2 cursor-pointer hover:opacity-80" onClick={() => startRename(activeConfig.name)}>
                                                            <h2 className="text-lg font-bold truncate">{activeConfig.name}</h2>
                                                            <Icons.Edit className="w-4 h-4 text-zinc-400 opacity-0 group-hover:opacity-100 transition-opacity"/>
                                                        </div>
                                                    )}
                                                </div>
                                                <button onClick={deleteConfig} className="text-red-500 p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded ml-4"><Icons.Trash className="w-4 h-4"/></button>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-medium text-zinc-500 mb-1">服务商</label>
                                                    <select value={activeConfig.provider} onChange={e => updateConfig('provider', e.target.value)} className={cn("w-full px-3 py-2 rounded border text-sm", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")}>
                                                        <option value="openai">OpenAI 兼容 (DeepSeek/GPT)</option>
                                                        <option value="google">Google Gemini</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-zinc-500 mb-1">Base URL</label>
                                                    <input value={activeConfig.baseUrl} onChange={e => updateConfig('baseUrl', e.target.value)} className={cn("w-full px-3 py-2 rounded border text-sm font-mono", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")} />
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-medium text-zinc-500 mb-1">API Key</label>
                                                <input type="password" value={activeConfig.apiKey} onChange={e => updateConfig('apiKey', e.target.value)} className={cn("w-full px-3 py-2 rounded border text-sm font-mono", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")} placeholder="sk-..." />
                                            </div>

                                            <div>
                                                <label className="block text-xs font-medium text-zinc-500 mb-1">模型 ID (Model)</label>
                                                <div className="flex gap-2 items-center">
                                                    <div className="flex-1 relative">
                                                        {availableModels.length > 0 ? (
                                                            <select value={activeConfig.model} onChange={e => updateConfig('model', e.target.value)} className={cn("w-full px-3 py-2 rounded border text-sm font-mono appearance-none", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")}>
                                                                {availableModels.map(m => <option key={m} value={m}>{m}</option>)}
                                                            </select>
                                                        ) : (
                                                            <input value={activeConfig.model} onChange={e => updateConfig('model', e.target.value)} className={cn("w-full px-3 py-2 rounded border text-sm font-mono", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")} placeholder="例如: deepseek-chat" />
                                                        )}
                                                    </div>
                                                    
                                                    {/* Enhanced Fetch/Test Buttons */}
                                                    <button onClick={fetchModels} disabled={isChecking} className={cn("px-3 py-2 rounded text-sm font-medium whitespace-nowrap flex items-center gap-1.5 transition-colors border shadow-sm", isChecking ? "opacity-50" : "", darkMode ? "bg-zinc-800 border-zinc-700 hover:bg-zinc-700 text-zinc-200" : "bg-white border-zinc-200 hover:bg-zinc-50 text-zinc-700")}>
                                                        {isChecking ? <Icons.Loader className="w-4 h-4"/> : <Icons.Activity className="w-4 h-4 text-purple-500"/>} 
                                                        获取列表
                                                    </button>
                                                    <button onClick={testModel} disabled={isTesting} className={cn("px-3 py-2 rounded text-sm font-medium whitespace-nowrap flex items-center gap-1.5 transition-colors border shadow-sm", isTesting ? "opacity-50" : "", darkMode ? "bg-green-900/20 border-green-900/30 text-green-400 hover:bg-green-900/30" : "bg-green-50 border-green-100 text-green-600 hover:bg-green-100")}>
                                                        {isTesting ? <Icons.Loader className="w-4 h-4"/> : <Icons.CheckCircle className="w-4 h-4"/>} 
                                                        连通测试
                                                    </button>
                                                </div>
                                                <p className="text-[10px] text-zinc-500 mt-2 flex items-center gap-1">
                                                    <Icons.Zap className="w-3 h-3"/> 提示：输入 Key 后先点击“获取列表”，若失败请检查 Base URL。
                                                </p>
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'prompts' && (
                                    <>
                                        {/* Prompt List */}
                                        <div className="w-56 border-r border-zinc-200 dark:border-zinc-800 overflow-y-auto p-2">
                                            <div className="flex justify-between items-center px-2 mb-2">
                                                <span className="text-xs font-bold text-zinc-500">剧本库</span>
                                                <button onClick={addPrompt} className="text-purple-500 hover:bg-purple-100 dark:hover:bg-purple-900/20 p-1 rounded"><Icons.Plus className="w-3 h-3"/></button>
                                            </div>
                                            {localPrompts.map(p => (
                                                <div key={p.id} onClick={() => { setEditingPromptId(p.id); setIsRenaming(false); }} className={cn("px-3 py-2 rounded text-sm cursor-pointer truncate mb-1 border", editingPromptId === p.id ? "border-purple-500 bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-300" : "border-transparent hover:bg-zinc-100 dark:hover:bg-zinc-800")}>
                                                    {p.name}
                                                </div>
                                            ))}
                                        </div>
                                        {/* Prompt Editor */}
                                        <div className="flex-1 p-6 overflow-y-auto custom-scrollbar space-y-5">
                                            {/* Renaming Header */}
                                            <div className="flex justify-between items-center group">
                                                <div className="flex-1 flex items-center gap-2">
                                                    {isRenaming ? (
                                                        <div className="flex items-center gap-2 w-full">
                                                            <input 
                                                                value={renameValue} 
                                                                onChange={e => setRenameValue(e.target.value)}
                                                                onBlur={finishRenamePrompt}
                                                                onKeyDown={e => e.key === 'Enter' && finishRenamePrompt()}
                                                                autoFocus
                                                                className={cn("text-lg font-bold bg-transparent border-b-2 border-purple-500 outline-none w-full pb-1", darkMode ? "text-white" : "text-zinc-900")} 
                                                            />
                                                            <button onClick={finishRenamePrompt} className="text-green-500 hover:text-green-600"><Icons.CheckCircle className="w-5 h-5"/></button>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-center gap-2 cursor-pointer hover:opacity-80" onClick={() => startRename(activePrompt.name)}>
                                                            <h2 className="text-lg font-bold truncate">{activePrompt.name}</h2>
                                                            <Icons.Edit className="w-4 h-4 text-zinc-400 opacity-0 group-hover:opacity-100 transition-opacity"/>
                                                        </div>
                                                    )}
                                                </div>
                                                <button onClick={deletePrompt} className="text-red-500 p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded ml-4"><Icons.Trash className="w-4 h-4"/></button>
                                            </div>
                                            <div className="flex-1 flex flex-col h-full pb-10">
                                                <label className="block text-xs font-medium text-zinc-500 mb-1">系统提示词 (System Prompt)</label>
                                                <textarea 
                                                    value={activePrompt.content}
                                                    onChange={e => updatePrompt('content', e.target.value)}
                                                    className={cn("flex-1 w-full p-4 rounded border text-sm resize-none leading-relaxed font-mono", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")}
                                                    placeholder="你是一个..."
                                                />
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'director' && (
                                    <div className="flex-1 p-6 overflow-y-auto custom-scrollbar flex flex-col h-full">
                                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Icons.Clapperboard className="w-5 h-5"/> 导演 (调度规则)</h2>
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="block text-xs font-medium text-zinc-500 mb-1">导演模式</label>
                                                <select value={localDirectorMode} onChange={e => setLocalDirectorMode(e.target.value)} className={cn("w-full px-3 py-2 rounded border text-sm", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")}>
                                                    <option value="ai">AI 导演 (自动调度)</option>
                                                    <option value="default">默认模式 (@点名)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-zinc-500 mb-1">上下文窗口大小</label>
                                                <input type="number" min="1" max="100" value={localContextWindowSize} onChange={e => setLocalContextWindowSize(e.target.value)} className={cn("w-full px-3 py-2 rounded border text-sm", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")} />
                                            </div>
                                        </div>
                                        <div className="bg-zinc-100 dark:bg-zinc-800/50 p-4 rounded-lg mb-4 text-sm text-zinc-600 dark:text-zinc-400">
                                            <p className="mb-2 font-bold">说明：</p>
                                            <p>这是决定“谁下一个说话”的核心指令。你可以修改规则来控制聊天的节奏。</p>
                                            <ul className="list-disc list-inside mt-2 space-y-1 text-xs opacity-80">
                                                <li>系统会自动将 <span className="font-mono text-purple-500">{`{agent_descriptions}`}</span> 替换为当前启用的演员列表。</li>
                                                <li>你可以添加规则，例如：“如果用户在提问，必须让‘理中客’回答”。</li>
                                                <li>你可以增加冲突，例如：“鼓励演员互相反驳对方的观点”。</li>
                                            </ul>
                                        </div>
                                        <div className="flex-1 pb-10 flex flex-col">
                                            <label className="block text-xs font-medium text-zinc-500 mb-1">调度指令 (Director Prompt)</label>
                                            <textarea 
                                                value={localDirectorRule}
                                                onChange={e => setLocalDirectorRule(e.target.value)}
                                                className={cn("flex-1 w-full p-4 rounded border text-sm resize-none leading-relaxed font-mono", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")}
                                            />
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer: Director & Save */}
                        <div className="p-4 border-t border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-950/50 flex justify-between items-center shrink-0">
                            <div className="flex items-center gap-3">
                                <span className="text-xs text-zinc-500">导演 (调度员) 使用配置:</span>
                                <select 
                                    value={directorConfigId}
                                    onChange={e => setDirectorConfigId(e.target.value)}
                                    className={cn("text-xs px-2 py-1.5 rounded border max-w-[200px]", darkMode ? "bg-zinc-900 border-zinc-700" : "bg-white border-zinc-300")}
                                >
                                    {localConfigs.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-sm text-zinc-500 hover:text-zinc-700">取消</button>
                                <button onClick={handleSaveAll} className="px-4 py-2 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2 shadow-lg shadow-purple-500/20"><Icons.Save className="w-4 h-4"/> 保存所有更改</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Agent Modal (Decoupled Selection + Model Override) ---
        const AgentModal = ({ open, onClose, agent, configs, prompts, onSave, onDelete, isNew, darkMode }) => {
            const [localAgent, setLocalAgent] = useState({ name: '', avatarColor: 'bg-gray-500', configId: '', promptId: '', model: '' });
            
            // Testing State
            const [availableModels, setAvailableModels] = useState([]);
            const [isChecking, setIsChecking] = useState(false);
            const [isTesting, setIsTesting] = useState(false);
            const [testResult, setTestResult] = useState(null);

            useEffect(() => {
                if (open) {
                    if (agent) {
                        setLocalAgent({ ...agent, model: agent.model || '' });
                    } else if (isNew) {
                        setLocalAgent({ 
                            id: `agent-${Date.now()}`, 
                            name: '新演员', 
                            avatarColor: 'bg-purple-500', 
                            configId: configs[0]?.id,
                            promptId: prompts[0]?.id,
                            model: '',
                            enabled: true 
                        });
                    }
                    setAvailableModels([]);
                    setTestResult(null);
                }
            }, [open, agent, isNew, configs, prompts]);

            if (!open) return null;
            const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-zinc-500'];

            const activeConfig = configs.find(c => c.id === localAgent.configId);

            const fetchModels = async () => {
                if (!activeConfig || !activeConfig.apiKey) {
                    setTestResult({ type: 'error', msg: "当前配置缺少 API Key" });
                    return;
                }
                setIsChecking(true);
                try {
                    const baseUrl = (activeConfig.baseUrl || '').replace(/\/+$/, '');
                    if (activeConfig.provider === 'google') {
                        const res = await fetch(`${baseUrl}/v1beta/models?key=${activeConfig.apiKey}`);
                        if (!res.ok) throw new Error(res.status);
                        const data = await res.json();
                        const ids = data.models?.filter(m => m.supportedGenerationMethods?.includes("generateContent")).map(m => m.name.replace('models/', '')) || [];
                        setAvailableModels(ids);
                        setTestResult({ type: 'success', msg: `获取到 ${ids.length} 个模型` });
                    } else {
                        let res = await fetch(`${baseUrl}/models`, { headers: { 'Authorization': `Bearer ${activeConfig.apiKey}` } });
                        if (res.status === 404 && !baseUrl.includes('/v1')) res = await fetch(`${baseUrl}/v1/models`, { headers: { 'Authorization': `Bearer ${activeConfig.apiKey}` } });
                        if (!res.ok) throw new Error(res.status);
                        const data = await res.json();
                        const ids = (data.data || []).map(m => m.id).sort();
                        setAvailableModels(ids);
                        setTestResult({ type: 'success', msg: `获取到 ${ids.length} 个模型` });
                    }
                } catch (e) {
                    setTestResult({ type: 'error', msg: `获取失败: ${e.message}` });
                } finally {
                    setIsChecking(false);
                }
            };

            const testModel = async () => {
                const modelToTest = localAgent.model || activeConfig?.model;
                if (!activeConfig?.apiKey || !modelToTest) {
                    setTestResult({ type: 'error', msg: "缺少配置或模型 ID" });
                    return;
                }
                setIsTesting(true);
                try {
                    const baseUrl = (activeConfig.baseUrl || '').replace(/\/+$/, '');
                    if (activeConfig.provider === 'google') await callGoogle(activeConfig.apiKey, baseUrl, modelToTest, "Hi");
                    else await callOpenAI(activeConfig.apiKey, baseUrl, modelToTest, "Hi");
                    setTestResult({ type: 'success', msg: `测试通过：${modelToTest}` });
                } catch (e) {
                    setTestResult({ type: 'error', msg: `测试失败: ${e.message}` });
                } finally {
                    setIsTesting(false);
                }
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-enter">
                    <div className={cn("w-full max-w-sm rounded-xl shadow-2xl p-6", darkMode ? "bg-zinc-900 border border-zinc-800 text-zinc-100" : "bg-white text-zinc-900")}>
                        <h2 className="text-lg font-bold mb-4 flex justify-between items-center">
                            <span>{isNew ? '添加演员' : '编辑演员'}</span>
                            {!isNew && <button onClick={() => onDelete(localAgent.id)} className="text-red-500"><Icons.Trash className="w-4 h-4"/></button>}
                        </h2>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-medium text-zinc-500 mb-1">显示名称</label>
                                <input value={localAgent.name} onChange={e => setLocalAgent({...localAgent, name: e.target.value})} className={cn("w-full px-3 py-2 rounded border text-sm", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")} />
                            </div>
                            
                            {/* Decoupled Selection */}
                            <div className="grid grid-cols-1 gap-4 p-3 rounded-lg border border-dashed border-zinc-300 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-900/50">
                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 mb-1 uppercase">大脑 (AI 模型配置)</label>
                                    <select value={localAgent.configId} onChange={e => setLocalAgent({...localAgent, configId: e.target.value})} className={cn("w-full px-2 py-1.5 rounded border text-sm", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")}>
                                        {configs.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                    </select>
                                </div>

                                {/* Model Override Section */}
                                <div>
                                    <label className="block text-xs font-medium text-zinc-500 mb-1 flex justify-between">
                                        <span>模型微调 (可选)</span>
                                        <span className="text-[10px] opacity-70">默认: {activeConfig?.model || '未知'}</span>
                                    </label>
                                    <div className="flex gap-1 mb-1">
                                        <div className="flex-1 relative">
                                            {availableModels.length > 0 ? (
                                                <select 
                                                    value={localAgent.model} 
                                                    onChange={e => setLocalAgent({...localAgent, model: e.target.value})} 
                                                    className={cn("w-full px-2 py-1.5 rounded border text-sm appearance-none", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")}
                                                >
                                                    <option value="">跟随全局 ({activeConfig?.model})</option>
                                                    {availableModels.map(m => <option key={m} value={m}>{m}</option>)}
                                                </select>
                                            ) : (
                                                <input 
                                                    value={localAgent.model} 
                                                    onChange={e => setLocalAgent({...localAgent, model: e.target.value})} 
                                                    placeholder="留空使用全局默认值" 
                                                    className={cn("w-full px-2 py-1.5 rounded border text-xs", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")} 
                                                />
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex gap-2 justify-end">
                                        <button onClick={fetchModels} disabled={isChecking} className="text-[10px] text-purple-500 hover:underline flex items-center gap-1">
                                            {isChecking ? <Icons.Loader className="w-3 h-3"/> : <Icons.Activity className="w-3 h-3"/>} 获取列表
                                        </button>
                                        <button onClick={testModel} disabled={isTesting} className="text-[10px] text-green-500 hover:underline flex items-center gap-1">
                                            {isTesting ? <Icons.Loader className="w-3 h-3"/> : <Icons.CheckCircle className="w-3 h-3"/>} 连通测试
                                        </button>
                                    </div>
                                    {testResult && (
                                        <div className={cn("text-[10px] mt-1 text-right", testResult.type === 'error' ? "text-red-500" : "text-green-500")}>
                                            {testResult.msg}
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-zinc-500 mb-1 uppercase">灵魂 (人设剧本)</label>
                                    <select value={localAgent.promptId} onChange={e => setLocalAgent({...localAgent, promptId: e.target.value})} className={cn("w-full px-2 py-1.5 rounded border text-sm", darkMode ? "bg-zinc-950 border-zinc-700" : "bg-white border-zinc-200")}>
                                        {prompts.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-medium text-zinc-500 mb-1">头像颜色</label>
                                <div className="flex gap-2 flex-wrap">
                                    {colors.map(c => (
                                        <button key={c} onClick={() => setLocalAgent({...localAgent, avatarColor: c})} className={cn("w-6 h-6 rounded-full transition-transform hover:scale-110", c, localAgent.avatarColor === c ? "ring-2 ring-offset-2 ring-white" : "")} />
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="mt-6 flex justify-end gap-2">
                            <button onClick={onClose} className="px-3 py-2 text-sm text-zinc-500">取消</button>
                            <button onClick={() => { onSave(localAgent); onClose(); }} className="px-3 py-2 text-sm bg-purple-600 text-white rounded">保存</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [darkMode, setDarkMode] = useState(true);
            const [configs, setConfigs] = useState(() => JSON.parse(localStorage.getItem('theater_configs')) || DEFAULT_MODEL_CONFIGS);
            const [prompts, setPrompts] = useState(() => JSON.parse(localStorage.getItem('theater_prompts')) || DEFAULT_SYSTEM_PROMPTS);
            const [agents, setAgents] = useState(() => JSON.parse(localStorage.getItem('theater_agents_v2')) || DEFAULT_AGENTS);
            const [directorConfigId, setDirectorConfigId] = useState(() => localStorage.getItem('theater_director_config_id') || configs[0]?.id);
            const [directorRule, setDirectorRule] = useState(() => localStorage.getItem('theater_director_rule') || DEFAULT_DIRECTOR_RULE);
            const [directorMode, setDirectorMode] = useState(() => localStorage.getItem('theater_director_mode') || 'default');
            const [contextWindowSize, setContextWindowSize] = useState(() => Number(localStorage.getItem('theater_context_window')) || 12);
            
            const [messages, setMessages] = useState([]);
            const [smallGroupMessages, setSmallGroupMessages] = useState([]);
            const [input, setInput] = useState('');
            const [smallGroupInput, setSmallGroupInput] = useState('');
            const [isAutoPlay, setIsAutoPlay] = useState(false);
            const [directorStatus, setDirectorStatus] = useState(null);
            const [activeSpeakerId, setActiveSpeakerId] = useState(null);
            const [smallGroupMembers, setSmallGroupMembers] = useState(() => JSON.parse(localStorage.getItem('theater_small_group_members')) || []);
            
            const [showConfig, setShowConfig] = useState(false);
            const [showAgentModal, setShowAgentModal] = useState(false);
            const [editingAgentId, setEditingAgentId] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [smallGroupVisible, setSmallGroupVisible] = useState(true);
            const [smallGroupWidth, setSmallGroupWidth] = useState(() => Number(localStorage.getItem('theater_small_group_width')) || 320);
            const [isDragging, setIsDragging] = useState(false);
            const messagesEndRef = useRef(null);
            const smallGroupEndRef = useRef(null);
            const autoPlayRef = useRef(isAutoPlay);
            const autoPlayTimeoutRef = useRef(null);
            const messagesRef = useRef(messages);
            const smallGroupMessagesRef = useRef(smallGroupMessages);
            const speakingLockRef = useRef(false);

            useEffect(() => {
                localStorage.setItem('theater_configs', JSON.stringify(configs));
                localStorage.setItem('theater_prompts', JSON.stringify(prompts));
                localStorage.setItem('theater_agents_v2', JSON.stringify(agents));
                localStorage.setItem('theater_director_config_id', directorConfigId);
                localStorage.setItem('theater_director_rule', directorRule);
                localStorage.setItem('theater_director_mode', directorMode);
                localStorage.setItem('theater_context_window', String(contextWindowSize));
                localStorage.setItem('theater_small_group_members', JSON.stringify(smallGroupMembers));
                localStorage.setItem('theater_small_group_width', String(smallGroupWidth));
            }, [configs, prompts, agents, directorConfigId, directorRule, directorMode, contextWindowSize, smallGroupMembers, smallGroupWidth]);

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            useEffect(() => {
                messagesRef.current = messages;
            }, [messages]);

            useEffect(() => {
                smallGroupMessagesRef.current = smallGroupMessages;
            }, [smallGroupMessages]);

            useEffect(() => {
                if (!isDragging) return;
                const handleMove = (event) => {
                    const next = Math.min(420, Math.max(240, window.innerWidth - event.clientX));
                    setSmallGroupWidth(next);
                };
                const handleUp = () => setIsDragging(false);
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleUp);
                return () => {
                    window.removeEventListener('mousemove', handleMove);
                    window.removeEventListener('mouseup', handleUp);
                };
            }, [isDragging]);

            useEffect(() => {
                autoPlayRef.current = isAutoPlay;
                if (!isAutoPlay && autoPlayTimeoutRef.current) {
                    clearTimeout(autoPlayTimeoutRef.current);
                    autoPlayTimeoutRef.current = null;
                }
            }, [isAutoPlay]);

            useEffect(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages, directorStatus, activeSpeakerId]);
            useEffect(() => smallGroupEndRef.current?.scrollIntoView({ behavior: 'smooth' }), [smallGroupMessages, activeSpeakerId]);

            const addToast = (msg, type) => {
                const id = Date.now();
                setToasts(p => [...p, { id, msg, type }]);
                setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000);
            };

            const Markdown = ({ content }) => {
                const html = useMemo(() => marked.parse(content || ''), [content]);
                return <div className="prose prose-sm dark:prose-invert max-w-none break-words" dangerouslySetInnerHTML={{ __html: html }} />;
            };

            const getEnabledAgents = () => agents.filter(a => a.enabled);
            const getSmallGroupAgents = () => agents.filter(a => a.enabled && smallGroupMembers.includes(a.id));
            const formatTime = (timestamp) => new Date(timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

            const copyToClipboard = async (text) => {
                if (!text) return;
                try {
                    await navigator.clipboard.writeText(text);
                    addToast('已复制到剪贴板', 'success');
                } catch (e) {
                    addToast('复制失败，请检查浏览器权限', 'error');
                }
            };

            const clearChat = (scope) => {
                if (scope === 'all') {
                    if (!confirm('确定清空大群和小群聊天记录？')) return;
                    setMessages([]);
                    setSmallGroupMessages([]);
                    return;
                }
                const label = scope === 'small' ? '小群' : '大群';
                if (!confirm(`确定清空${label}聊天记录？`)) return;
                if (scope === 'small') setSmallGroupMessages([]);
                else setMessages([]);
            };

            const exportChat = (format, scope = 'all') => {
                const mainHistory = messagesRef.current;
                const smallHistory = smallGroupMessagesRef.current;
                const exportList = scope === 'all'
                    ? mergeHistories(mainHistory, smallHistory)
                    : (scope === 'small' ? smallHistory : mainHistory);

                if (exportList.length === 0) {
                    addToast('没有可导出的内容', 'error');
                    return;
                }

                const now = new Date();
                const safeTime = now.toISOString().replace(/[:.]/g, '-');
                const fileBase = `chat-export-${scope}-${safeTime}`;

                let content = '';
                let mime = 'text/plain';
                let ext = 'txt';

                if (format === 'json') {
                    content = JSON.stringify(exportList, null, 2);
                    mime = 'application/json';
                    ext = 'json';
                } else if (format === 'md') {
                    ext = 'md';
                    mime = 'text/markdown';
                    content = exportList.map(m => {
                        const roomTag = m.room === 'small' ? '[小群]' : '[大群]';
                        const name = m.role === 'user' ? '你' : (m.senderName || '未知');
                        const time = m.time ? ` ${m.time}` : '';
                        return `- ${roomTag} ${name}${time}: ${m.content}`;
                    }).join('\n');
                } else {
                    ext = 'txt';
                    mime = 'text/plain';
                    content = exportList.map(m => {
                        const roomTag = m.room === 'small' ? '[小群]' : '[大群]';
                        const name = m.role === 'user' ? '你' : (m.senderName || '未知');
                        const time = m.time ? ` ${m.time}` : '';
                        return `${roomTag} ${name}${time}: ${m.content}`;
                    }).join('\n');
                }

                const blob = new Blob([content], { type: `${mime};charset=utf-8` });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileBase}.${ext}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const getNextAgentByOrder = (enabledAgents, history) => {
                if (enabledAgents.length === 0) return null;
                const lastAgentMsg = [...history].reverse().find(m => m.role === 'assistant' && m.senderId);
                if (!lastAgentMsg) return enabledAgents[0];
                const lastIdx = enabledAgents.findIndex(a => a.id === lastAgentMsg.senderId);
                if (lastIdx === -1) return enabledAgents[0];
                return enabledAgents[(lastIdx + 1) % enabledAgents.length];
            };

            const findMentionedAgent = (text, enabledAgents) => {
                if (!text) return null;
                const normalized = text.trim();
                return enabledAgents.find(a => normalized.includes(`@${a.name}`));
            };

            const hasMentionAll = (text) => {
                if (!text) return false;
                return text.includes('@所有人') || text.toLowerCase().includes('@all');
            };

            const mergeHistories = (mainHistory, smallHistory) => {
                const merged = [...mainHistory, ...smallHistory].map(m => ({ ...m }));
                return merged.sort((a, b) => (a.id || 0) - (b.id || 0));
            };

            const formatContextMessages = (history, tag) => history.map(m => ({
                role: m.role === 'user' ? 'user' : 'assistant',
                content: `${tag}${m.senderName ? m.senderName + ': ' : ''}${m.content}`
            }));

            const getCombinedContextMessages = () => {
                const mainHistory = messagesRef.current;
                const smallHistory = smallGroupMessagesRef.current;
                const combined = mergeHistories(mainHistory, smallHistory).slice(-contextWindowSize);
                return combined.map(m => ({
                    role: m.role === 'user' ? 'user' : 'assistant',
                    content: `${m.room === 'small' ? '[小群] ' : '[大群] '}${m.senderName ? m.senderName + ': ' : ''}${m.content}`
                }));
            };

            const triggerAgentSequence = async (agentList, history, reason, room) => {
                let currentHistory = [...history];
                for (const agent of agentList) {
                    if (speakingLockRef.current) return;
                    const responseText = await triggerAgentResponse(agent, currentHistory, reason, room);
                    currentHistory = [...currentHistory, { id: Date.now(), role: 'assistant', senderId: agent.id, senderName: agent.name, content: responseText, room, time: formatTime(Date.now()) }];
                }
            };

            const parseDirectorDecision = (rawText) => {
                if (!rawText) return null;
                const trimmed = rawText.trim();
                const tryParse = (candidate) => {
                    try { return JSON.parse(candidate); } catch (e) { return null; }
                };
                if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                    const parsed = tryParse(trimmed);
                    if (parsed) return parsed;
                }
                const codeBlockMatch = trimmed.match(/```json\s*([\s\S]*?)\s*```/i);
                if (codeBlockMatch) {
                    const parsed = tryParse(codeBlockMatch[1]);
                    if (parsed) return parsed;
                }
                const jsonMatch = trimmed.match(/\{[\s\S]*\}/);
                if (jsonMatch) return tryParse(jsonMatch[0]);
                return null;
            };

            // --- Logic ---
            const runDirectorCycle = async (history) => {
                if (activeSpeakerId || speakingLockRef.current) return;

                // Director only needs INTELLIGENCE (Config), prompt is internal
                const directorConfig = configs.find(c => c.id === directorConfigId);
                const enabledAgents = getEnabledAgents();
                if (enabledAgents.length === 0) return;

                if (directorMode === 'default') {
                    const lastUserMsg = [...history].reverse().find(m => m.role === 'user');
                    if (hasMentionAll(lastUserMsg?.content)) {
                        await triggerAgentSequence(enabledAgents, history, '被@所有人点名', 'main');
                        return;
                    }
                    const mentionedAgent = findMentionedAgent(lastUserMsg?.content, enabledAgents);
                    if (mentionedAgent) {
                        triggerAgentResponse(mentionedAgent, history, '被@点名', 'main');
                        return;
                    }

                    if (autoPlayRef.current) {
                        const roomHistory = messagesRef.current;
                        const nextAgent = getNextAgentByOrder(enabledAgents, roomHistory);
                        if (nextAgent) triggerAgentResponse(nextAgent, roomHistory, '顺序互怼', 'main');
                    }
                    return;
                }

                if (!directorConfig?.apiKey) {
                    addToast("导演配置无效或缺少Key", "error");
                    setIsAutoPlay(false);
                    return;
                }

                setDirectorStatus('thinking');

                const agentDescriptions = enabledAgents.map(a => {
                    const prompt = prompts.find(p => p.id === a.promptId);
                    return `- ID: ${a.id}, 名字: ${a.name}, 人设: ${prompt ? prompt.content.substring(0, 100) : '未知'}`;
                }).join('\n');

                const finalDirectorPrompt = directorRule.replace('{agent_descriptions}', agentDescriptions);

                const contextMsgs = getCombinedContextMessages();

                try {
                    let fullResponse = "";
                    await callLLM(
                        [{ role: "system", content: finalDirectorPrompt }, ...contextMsgs],
                        directorConfig,
                        (chunk) => fullResponse += chunk,
                        () => {
                            setDirectorStatus(null);
                            const decision = parseDirectorDecision(fullResponse);
                            if (decision?.next_speaker_id) {
                                const agent = agents.find(a => a.id === decision.next_speaker_id && a.enabled);
                                if (agent) triggerAgentResponse(agent, history, decision.reason || '导演调度', 'main');
                                return;
                            }
                            if (autoPlayRef.current) {
                                const fallbackAgent = getNextAgentByOrder(enabledAgents, history);
                                if (fallbackAgent) {
                                    addToast("导演解析失败，改用顺序模式", "error");
                                    triggerAgentResponse(fallbackAgent, history, '解析失败回退', 'main');
                                }
                            } else {
                                setIsAutoPlay(false);
                            }
                        },
                        (err) => { addToast(`导演出错: ${err}`, 'error'); setDirectorStatus(null); }
                    );
                } catch (e) { setDirectorStatus(null); }

            };

            const runSmallGroupCycle = async (history) => {
                if (activeSpeakerId || speakingLockRef.current) return;
                const enabledAgents = getSmallGroupAgents();
                if (enabledAgents.length === 0) return;

                if (directorMode === 'default') {
                    const lastUserMsg = [...history].reverse().find(m => m.role === 'user');
                    if (hasMentionAll(lastUserMsg?.content)) {
                        await triggerAgentSequence(enabledAgents, history, '被@所有人点名', 'small');
                        return;
                    }
                    const mentionedAgent = findMentionedAgent(lastUserMsg?.content, enabledAgents);
                    if (mentionedAgent) {
                        triggerAgentResponse(mentionedAgent, history, '被@点名', 'small');
                        return;
                    }
                    if (autoPlayRef.current) {
                        const roomHistory = smallGroupMessagesRef.current;
                        const nextAgent = getNextAgentByOrder(enabledAgents, roomHistory);
                        if (nextAgent) triggerAgentResponse(nextAgent, roomHistory, '顺序互怼', 'small');
                    }
                    return;
                }

                const directorConfig = configs.find(c => c.id === directorConfigId);
                if (!directorConfig?.apiKey) {
                    addToast("导演配置无效或缺少Key", "error");
                    setIsAutoPlay(false);
                    return;
                }

                setDirectorStatus('thinking');
                const agentDescriptions = enabledAgents.map(a => {
                    const prompt = prompts.find(p => p.id === a.promptId);
                    return `- ID: ${a.id}, 名字: ${a.name}, 人设: ${prompt ? prompt.content.substring(0, 100) : '未知'}`;
                }).join('\n');

                const finalDirectorPrompt = directorRule.replace('{agent_descriptions}', agentDescriptions);
                const contextMsgs = getCombinedContextMessages();

                try {
                    let fullResponse = "";
                    await callLLM(
                        [{ role: "system", content: finalDirectorPrompt }, ...contextMsgs],
                        directorConfig,
                        (chunk) => fullResponse += chunk,
                        () => {
                            setDirectorStatus(null);
                            const decision = parseDirectorDecision(fullResponse);
                            if (decision?.next_speaker_id) {
                                const agent = enabledAgents.find(a => a.id === decision.next_speaker_id);
                                if (agent) triggerAgentResponse(agent, history, decision.reason || '导演调度', 'small');
                                return;
                            }
                            if (autoPlayRef.current) {
                                const fallbackAgent = getNextAgentByOrder(enabledAgents, history);
                                if (fallbackAgent) {
                                    addToast("导演解析失败，改用顺序模式", "error");
                                    triggerAgentResponse(fallbackAgent, history, '解析失败回退', 'small');
                                }
                            } else {
                                setIsAutoPlay(false);
                            }
                        },
                        (err) => { addToast(`导演出错: ${err}`, 'error'); setDirectorStatus(null); }
                    );
                } catch (e) { setDirectorStatus(null); }
            };

            const triggerAgentResponse = async (agent, history, reason, room = 'main') => {
                const config = configs.find(c => c.id === agent.configId);
                const prompt = prompts.find(p => p.id === agent.promptId);

                if (!config || !prompt) return addToast(`${agent.name} 配置不完整`, 'error');

                if (speakingLockRef.current) return '';
                speakingLockRef.current = true;
                setActiveSpeakerId(agent.id);

                const shouldShareContext = smallGroupMembers.includes(agent.id);
                const contextBase = shouldShareContext ? mergeHistories(messagesRef.current, smallGroupMessagesRef.current) : history;
                const contextMessages = contextBase.slice(-contextWindowSize).map(m => ({
                    role: m.role === 'user' ? 'user' : (m.senderId === agent.id ? 'assistant' : 'user'),
                    content: `${m.room === 'small' ? '[小群] ' : '[大群] '}${m.senderId && m.senderId !== agent.id ? `[${m.senderName}]: ${m.content}` : m.content}`
                }));

                const systemMsg = { role: 'system', content: `${prompt.content}\n\n(当前情境: ${reason || '轮到你发言'})` };

                // Override model if agent has specific model set
                const effectiveConfig = {
                    ...config,
                    model: agent.model || config.model
                };

                const newMsgId = Date.now();
                const setRoomMessages = room === 'small' ? setSmallGroupMessages : setMessages;
                setRoomMessages(prev => [...prev, { id: newMsgId, role: 'assistant', senderId: agent.id, senderName: agent.name, avatarColor: agent.avatarColor, content: '', isThinking: true, room, time: formatTime(Date.now()) }]);

                let responseText = "";
                await callLLM(
                    [systemMsg, ...contextMessages],
                    effectiveConfig,
                    (chunk) => {
                        responseText += chunk;
                        setRoomMessages(prev => prev.map(m => m.id === newMsgId ? { ...m, content: responseText, isThinking: false } : m));
                    },
                    () => {
                        setActiveSpeakerId(null);
                        speakingLockRef.current = false;
                        if (autoPlayRef.current) {
                            autoPlayTimeoutRef.current = setTimeout(() => {
                                if (autoPlayRef.current) {
                                    const nextHistory = [...history, { role: 'assistant', senderId: agent.id, senderName: agent.name, content: responseText, room, time: formatTime(Date.now()) }];
                                    if (room === 'small') runSmallGroupCycle(nextHistory);
                                    else runDirectorCycle(nextHistory);
                                }
                            }, 2000);
                        }
                    },
                    (err) => { setActiveSpeakerId(null); speakingLockRef.current = false; addToast(`发言失败: ${err}`, 'error'); }
                );
                return responseText;
            };

            const handleUserSend = () => {
                if (!input.trim()) return;
                const newMsg = { id: Date.now(), role: 'user', content: input, room: 'main', time: formatTime(Date.now()) };

                const newHistory = [...messages, newMsg];
                setMessages(newHistory);
                setInput('');
                setTimeout(() => runDirectorCycle(newHistory), 500);
            };

            const handleSmallGroupSend = () => {
                if (!smallGroupInput.trim()) return;
                const newMsg = { id: Date.now(), role: 'user', content: smallGroupInput, room: 'small', time: formatTime(Date.now()) };

                const newHistory = [...smallGroupMessages, newMsg];
                setSmallGroupMessages(newHistory);
                setSmallGroupInput('');
                setTimeout(() => runSmallGroupCycle(newHistory), 500);
            };

            const quickAt = (name, room) => {
                const token = `@${name} `;
                if (room === 'small') setSmallGroupInput(prev => (prev || '') + token);
                else setInput(prev => (prev || '') + token);
            };

            const toggleSmallGroupMember = (agentId) => {
                setSmallGroupMembers(prev => prev.includes(agentId) ? prev.filter(id => id !== agentId) : [...prev, agentId]);
            };

            const handleSaveAgent = (updated) => {
                setAgents(prev => {
                    const exists = prev.find(a => a.id === updated.id);
                    if (exists) return prev.map(a => a.id === updated.id ? updated : a);
                    return [...prev, updated];
                });
            };

            const handleDeleteAgent = (id) => {
                setAgents(prev => prev.filter(a => a.id !== id));
                setShowAgentModal(false);
            };

            return (
                <div className={cn("flex h-screen w-full overflow-hidden transition-colors duration-300", darkMode ? "bg-zinc-950 text-zinc-100" : "bg-zinc-50 text-zinc-900")}>
                    <Toast toasts={toasts} removeToast={(id) => setToasts(p => p.filter(t => t.id !== id))} />
                    
                    <GlobalConfigModal 
                        open={showConfig} 
                        onClose={() => setShowConfig(false)}
                        configs={configs} setConfigs={setConfigs}
                        prompts={prompts} setPrompts={setPrompts}
                        directorConfigId={directorConfigId} setDirectorConfigId={setDirectorConfigId}
                        directorRule={directorRule} setDirectorRule={setDirectorRule}
                        directorMode={directorMode} setDirectorMode={setDirectorMode}
                        contextWindowSize={contextWindowSize} setContextWindowSize={setContextWindowSize}
                        darkMode={darkMode} addToast={addToast}
                    />

                    <AgentModal 
                        open={showAgentModal}
                        onClose={() => setShowAgentModal(false)}
                        agent={editingAgentId ? agents.find(a => a.id === editingAgentId) : null}
                        isNew={!editingAgentId}
                        configs={configs} prompts={prompts}
                        onSave={handleSaveAgent} onDelete={handleDeleteAgent}
                        darkMode={darkMode}
                    />

                    {/* Sidebar */}
                    <div className="w-64 border-r border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900 flex flex-col shrink-0">
                        <div className="p-4 border-b border-zinc-200 dark:border-zinc-800 flex justify-between items-center">
                            <h1 className="font-bold flex items-center gap-2"><Icons.Users className="w-5 h-5 text-purple-600"/> 演员名单</h1>
                            <button onClick={() => setDarkMode(!darkMode)} className="text-zinc-500 hover:text-zinc-300">
                                {darkMode ? <Icons.Sun className="w-5 h-5"/> : <Icons.Moon className="w-5 h-5"/>}
                            </button>
                        </div>
                        <div className="p-2 overflow-y-auto flex-1 space-y-2">
                            {agents.map(agent => {
                                const cfg = configs.find(c => c.id === agent.configId);
                                const pmt = prompts.find(p => p.id === agent.promptId);
                                const inSmallGroup = smallGroupMembers.includes(agent.id);
                                return (
                                    <div key={agent.id} className={cn("group p-3 rounded-lg flex items-center gap-3 border transition-all relative", agent.enabled ? (darkMode ? "bg-zinc-800 border-zinc-700" : "bg-white border-purple-200 shadow-sm") : "opacity-50 border-transparent")}>
                                        <div onClick={() => setAgents(prev => prev.map(a => a.id === agent.id ? {...a, enabled: !a.enabled} : a))} className="cursor-pointer flex items-center gap-3 flex-1">
                                            <div className={cn("w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shrink-0", agent.avatarColor)}>{agent.name[0]}</div>
                                            <div className="min-w-0">
                                                <div className="font-medium text-sm truncate">{agent.name}</div>
                                                <div className="text-xs text-zinc-500 truncate flex items-center gap-1">
                                                    <span className="max-w-[60px] truncate">{cfg?.name}</span> • <span className="max-w-[60px] truncate">{pmt?.name}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="absolute right-2 flex items-center gap-1 opacity-0 group-hover:opacity-100">
                                            <button onClick={() => toggleSmallGroupMember(agent.id)} className={cn("p-1.5 rounded", inSmallGroup ? "text-green-500" : "text-zinc-400 hover:text-zinc-500")} title={inSmallGroup ? "移出小群" : "拉入小群"}><Icons.Users className="w-4 h-4"/></button>
                                            <button onClick={() => { setEditingAgentId(agent.id); setShowAgentModal(true); }} className="p-1.5 hover:bg-black/10 rounded"><Icons.Edit className="w-4 h-4 text-zinc-400"/></button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="p-4 border-t border-zinc-200 dark:border-zinc-800">
                            <button onClick={() => { setEditingAgentId(null); setShowAgentModal(true); }} className="w-full py-2 bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 text-zinc-600 dark:text-zinc-300"><Icons.Plus className="w-4 h-4"/> 添加演员</button>
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 flex flex-col relative">
                        <div className="h-14 border-b border-zinc-200 dark:border-zinc-800 bg-white/80 dark:bg-zinc-950/80 backdrop-blur flex items-center justify-between px-6 z-10">
                            <div className="flex items-center gap-4">
                                <div className="font-bold">群聊剧场 <span className="text-xs font-normal text-zinc-500 ml-2">Ultra Config</span></div>
                                {directorStatus === 'thinking' && <div className="flex items-center gap-2 text-xs text-purple-500 animate-pulse"><Icons.Brain className="w-4 h-4"/> 导演调度中...</div>}
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => exportChat('md', 'all')} className="px-3 py-1.5 rounded-full text-xs font-bold border border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200 flex items-center gap-1" title="导出为 Markdown">
                                    <Icons.Download className="w-3.5 h-3.5"/> 导出
                                </button>
                                <button onClick={() => clearChat('all')} className="px-3 py-1.5 rounded-full text-xs font-bold border border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200" title="清空大群与小群">
                                    清空
                                </button>
                                <button onClick={() => setIsAutoPlay(prev => !prev)} className={cn("flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all border", isAutoPlay ? "bg-green-500/10 text-green-600 border-green-500/20" : "bg-zinc-100 text-zinc-500 border-transparent dark:bg-zinc-800 dark:text-zinc-400")}>
                                    {isAutoPlay ? <><Icons.Pause className="w-3 h-3"/> 自动互怼中</> : <><Icons.Play className="w-3 h-3"/> 开启自动互怼</>}
                                </button>
                                <button onClick={() => setSmallGroupVisible(prev => !prev)} className="px-3 py-1.5 rounded-full text-xs font-bold border border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200">
                                    {smallGroupVisible ? '收起小群' : '展开小群'}
                                </button>
                                <button onClick={() => setShowConfig(true)} className="p-2 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200" title="全局资源配置"><Icons.Settings className="w-5 h-5"/></button>
                            </div>
                        </div>

                        <div className="flex-1 flex gap-4 p-4 bg-zinc-50 dark:bg-zinc-950/50 min-h-0">
                            <div className="flex flex-1 flex-col min-h-0">
                                <div className="flex-1 overflow-y-auto space-y-6 pr-1 min-h-0">
                                    {messages.length === 0 && (
                                        <div className="h-full flex flex-col items-center justify-center opacity-30 select-none">
                                            <Icons.Users className="w-20 h-20 mb-4 text-zinc-400"/>
                                            <p>请先在右上角配置资源</p>
                                        </div>
                                    )}
                                    {messages.map((msg) => {
                                        const isUser = msg.role === 'user';
                                        return (
                                            <div key={msg.id} className={cn("flex gap-4 max-w-3xl group", isUser ? "ml-auto flex-row-reverse" : "")}> 
                                                <div className={cn("w-10 h-10 rounded-full flex items-center justify-center text-white shrink-0 shadow-lg mt-1", isUser ? "bg-zinc-800 dark:bg-zinc-700" : (msg.avatarColor || "bg-gray-500"))}>
                                                    {isUser ? <Icons.User className="w-5 h-5"/> : msg.senderName?.[0]}
                                                </div>
                                                <div className={cn("flex flex-col max-w-[80%]", isUser ? "items-end" : "items-start")}> 
                                                    <div className="flex items-center gap-2 mb-1 px-1">
                                                        <span className="text-xs font-bold text-zinc-500">{isUser ? "你" : msg.senderName}</span>
                                                        {msg.time && <span className="text-[10px] text-zinc-400">{msg.time}</span>}
                                                        <button onClick={() => copyToClipboard(msg.content)} className="ml-1 p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity text-zinc-400 hover:text-zinc-600" title="复制消息">
                                                            <Icons.Copy className="w-3.5 h-3.5"/>
                                                        </button>
                                                    </div>
                                                    <div className={cn("rounded-2xl px-5 py-3 shadow-sm text-sm leading-relaxed", isUser ? "bg-zinc-800 text-white rounded-tr-none" : "bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-tl-none dark:text-zinc-200")}> 
                                                        {msg.isThinking ? <div className="flex gap-1 py-1 h-5 items-center"><div className="w-1.5 h-1.5 bg-current rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-current rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-current rounded-full typing-dot"></div></div> : <Markdown content={msg.content} />}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    <div ref={messagesEndRef} />
                                </div>
                                <div className="mt-4 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-3">
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        <button onClick={() => quickAt('所有人', 'main')} className="px-2 py-1 text-xs rounded-full border border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200 flex items-center gap-1">
                                            <Icons.AtSign className="w-3 h-3"/> @所有人
                                        </button>
                                        {getEnabledAgents().map(a => (
                                            <button key={a.id} onClick={() => quickAt(a.name, 'main')} className="px-2 py-1 text-xs rounded-full border border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200">
                                                @{a.name}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex gap-3">
                                        <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleUserSend()} placeholder={isAutoPlay ? "插嘴..." : "说点什么..."} className="flex-1 bg-zinc-100 dark:bg-zinc-900 border-none rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-purple-500/50 dark:text-white transition-all" disabled={activeSpeakerId !== null && !isAutoPlay} />
                                        <button onClick={handleUserSend} disabled={!input.trim() || activeSpeakerId !== null} className="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg shadow-purple-500/20"><Icons.Send className="w-5 h-5"/></button>
                                    </div>
                                </div>
                            </div>

                            {smallGroupVisible && (
                                <>
                                    <div onMouseDown={() => setIsDragging(true)} className="hidden xl:block w-1.5 cursor-col-resize rounded-full bg-zinc-200/80 dark:bg-zinc-800/80" />
                                    <div className="flex flex-col min-h-0 border border-zinc-200 dark:border-zinc-800 rounded-2xl bg-white/70 dark:bg-zinc-900/70" style={{ width: smallGroupWidth }}>
                                        <div className="px-4 py-3 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
                                            <div className="font-bold text-sm">私密小群</div>
                                            <div className="text-xs text-zinc-500">成员 {getSmallGroupAgents().length}</div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-3 space-y-4 min-h-0">
                                            {smallGroupMessages.length === 0 && (
                                                <div className="h-full flex flex-col items-center justify-center opacity-40 select-none text-xs text-zinc-500">
                                                    <p>这里是小群聊天</p>
                                                    <p>@某位演员 或 @所有人</p>
                                                </div>
                                            )}
                                            {smallGroupMessages.map((msg) => {
                                                const isUser = msg.role === 'user';
                                                return (
                                                    <div key={msg.id} className={cn("flex gap-3 group", isUser ? "ml-auto flex-row-reverse" : "")}> 
                                                        <div className={cn("w-8 h-8 rounded-full flex items-center justify-center text-white shrink-0 shadow", isUser ? "bg-zinc-800 dark:bg-zinc-700" : (msg.avatarColor || "bg-gray-500"))}>
                                                            {isUser ? <Icons.User className="w-4 h-4"/> : msg.senderName?.[0]}
                                                        </div>
                                                        <div className={cn("flex flex-col max-w-[75%]", isUser ? "items-end" : "items-start")}> 
                                                            <div className="flex items-center gap-2 mb-1 px-1">
                                                                <span className="text-[10px] font-bold text-zinc-500">{isUser ? "你" : msg.senderName}</span>
                                                                <button onClick={() => copyToClipboard(msg.content)} className="ml-1 p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity text-zinc-400 hover:text-zinc-600" title="复制消息">
                                                                    <Icons.Copy className="w-3 h-3"/>
                                                                </button>
                                                            </div>
                                                            <div className={cn("rounded-2xl px-4 py-2 shadow-sm text-xs leading-relaxed", isUser ? "bg-zinc-800 text-white rounded-tr-none" : "bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-tl-none dark:text-zinc-200")}> 
                                                                {msg.isThinking ? <div className="flex gap-1 py-1 h-4 items-center"><div className="w-1 h-1 bg-current rounded-full typing-dot"></div><div className="w-1 h-1 bg-current rounded-full typing-dot"></div><div className="w-1 h-1 bg-current rounded-full typing-dot"></div></div> : <Markdown content={msg.content} />}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            <div ref={smallGroupEndRef} />
                                        </div>
                                        <div className="p-3 border-t border-zinc-200 dark:border-zinc-800">
                                            <div className="flex flex-wrap gap-2 mb-2">
                                                <button onClick={() => quickAt('所有人', 'small')} className="px-2 py-1 text-[10px] rounded-full border border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200 flex items-center gap-1">
                                                    <Icons.AtSign className="w-3 h-3"/> @所有人
                                                </button>
                                                {getSmallGroupAgents().map(a => (
                                                    <button key={a.id} onClick={() => quickAt(a.name, 'small')} className="px-2 py-1 text-[10px] rounded-full border border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200">
                                                        @{a.name}
                                                    </button>
                                                ))}
                                                <button onClick={() => exportChat('md', 'small')} className="ml-auto px-2 py-1 text-[10px] rounded-full border border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200 flex items-center gap-1" title="导出小群">
                                                    <Icons.Download className="w-3 h-3"/> 导出
                                                </button>
                                                <button onClick={() => clearChat('small')} className="px-2 py-1 text-[10px] rounded-full border border-zinc-200 dark:border-zinc-700 text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200" title="清空小群">
                                                    清空
                                                </button>
                                            </div>
                                            <div className="flex gap-2">
                                                <input value={smallGroupInput} onChange={e => setSmallGroupInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSmallGroupSend()} placeholder="小群发言..." className="flex-1 bg-zinc-100 dark:bg-zinc-900 border-none rounded-xl px-3 py-2 text-xs outline-none focus:ring-2 focus:ring-purple-500/50 dark:text-white transition-all" disabled={activeSpeakerId !== null && !isAutoPlay} />
                                                <button onClick={handleSmallGroupSend} disabled={!smallGroupInput.trim() || activeSpeakerId !== null} className="bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-colors"><Icons.Send className="w-4 h-4"/></button>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>