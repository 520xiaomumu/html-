<!DOCTYPE html>
<!-- 
  ğŸŒ å‘Šè¯‰æµè§ˆå™¨ï¼šæˆ‘ä»¬è¦å¼€å§‹ç”¨ HTML è¿™ç§è¯­è¨€æ¥å†™ç½‘é¡µå•¦ï¼
  HTML å°±åƒæ˜¯æˆ¿å­çš„éª¨æ¶ã€‚
-->
<html lang="zh"> <!-- è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡ -->
<head>
    <meta charset="UTF-8"> <!-- ğŸ”¤ å‘Šè¯‰æµè§ˆå™¨ä¸è¦ä¹±ç ï¼Œè¦ç”¨é€šç”¨çš„å­—ç¬¦é›† -->
    <!-- ğŸ“± ä¸‹é¢è¿™è¡Œæ˜¯è®©æ¸¸æˆåœ¨æ‰‹æœºå±å¹•ä¸Šä¹Ÿèƒ½è‡ªåŠ¨ç¼©æ”¾ï¼Œçœ‹æ¸…æ¥š -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è´ªåƒè›‡ - ä¸­æ–‡æ³¨é‡Šç‰ˆ</title>
    
    <!-- ğŸ¨ å¼•å…¥ p5.js è¿™ä¸ªå·¥å…·åº“ã€‚
         è¿™å°±å¥½æ¯”æˆ‘ä»¬ä¸ç”¨è‡ªå·±é€ ç”»ç¬”å’Œé¢œæ–™ï¼Œç›´æ¥å€Ÿç”¨è¿™ä¸€å¥—å¥½ç”¨çš„å·¥å…·æ¥ç”»ç”»ã€‚ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    
    <!-- ğŸ’… <style> é‡Œé¢å†™çš„æ˜¯ CSSï¼Œå°±åƒæ˜¯ç»™æˆ¿å­æè£…ä¿®ã€‚
         å†³å®šäº†èƒŒæ™¯æ˜¯ä»€ä¹ˆé¢œè‰²ï¼Œå­—æœ‰å¤šå¤§ã€‚ -->
    <style>
        body {
            margin: 0;          /* ä¸è¦ç•™ç™½è¾¹ */
            padding: 0;         /* ä¸è¦ç•™å†…è¡¬ */
            background-color: #111; /* â¬›ï¸ èƒŒæ™¯è®¾ä¸ºæ·±é»‘è‰² */
            color: #eee;        /* â¬œï¸ æ–‡å­—è®¾ä¸ºç°ç™½è‰² */
            font-family: 'Segoe UI', monospace; /* å­—ä½“æ ·å¼ */
            overflow: hidden;   /* å¦‚æœå†…å®¹å¤ªå¤šï¼Œè—èµ·æ¥ä¸è¦å‡ºç°æ»šåŠ¨æ¡ */
            display: flex;      /* ğŸ“¦ è®©å†…å®¹åƒç§¯æœ¨ä¸€æ ·æ’åˆ— */
            justify-content: center; /* â†”ï¸ æ°´å¹³å±…ä¸­ */
            align-items: center;     /* â†•ï¸ å‚ç›´å±…ä¸­ */
            height: 100vh;      /* å æ»¡æ•´ä¸ªå±å¹•çš„é«˜åº¦ */
        }
        #canvas-container {
            position: relative; /* ğŸ“ è¿™æ˜¯ä¸€ä¸ªå®šä½åŸºå‡†ç‚¹ */
            box-shadow: 0 0 40px rgba(0,0,0,0.8); /* ç»™æ¸¸æˆæ¡†åŠ ä¸ªå¸…æ°”çš„é˜´å½± */
            border: 2px solid #333; /* åŠ ä¸ªæ·±ç°è‰²çš„è¾¹æ¡† */
        }
        /* ğŸ® ä¸‹é¢æ˜¯æ¸¸æˆå·¦ä¸Šè§’é‚£ä¸ªä¿¡æ¯æ¡†çš„æ ·å¼ */
        #ui-layer {
            position: absolute; /* ç»å¯¹å®šä½ï¼Œæ‚¬æµ®åœ¨ç”»å¸ƒä¸Šé¢ */
            top: 15px;          /* è·ç¦»é¡¶éƒ¨ 15åƒç´  */
            left: 15px;         /* è·ç¦»å·¦è¾¹ 15åƒç´  */
            background: rgba(0, 0, 0, 0.85); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            padding: 15px 20px; /* é‡Œé¢çš„å­—ç¦»è¾¹æ¡†è¿œä¸€ç‚¹ */
            border-radius: 8px; /*æŠŠè§’ç£¨åœ†ä¸€ç‚¹ */
            pointer-events: none; /* é¼ æ ‡ç‚¹ä¸ä¸­å®ƒï¼Œç›´æ¥ç©¿é€åˆ°æ¸¸æˆé‡Œ */
            border-left: 4px solid #4CAF50; /* å·¦è¾¹åŠ æ¡ç»¿çº¿è£…é¥° */
            backdrop-filter: blur(4px); /*ä»¥æ­¤èƒŒæ™¯åšä¸€ç‚¹æ¨¡ç³Šæ•ˆæœ */
        }
        h1 { margin: 0 0 10px 0; font-size: 22px; color: #4CAF50; letter-spacing: 1px; text-transform: uppercase; }
        p { margin: 5px 0; font-size: 16px; color: #ddd; }
        .status-ok { color: #4CAF50; font-weight: bold; } /* âœ… çŠ¶æ€æ­£å¸¸ï¼šç»¿è‰² */
        .status-warn { color: #FFC107; font-weight: bold; } /* âš ï¸ çŠ¶æ€è­¦å‘Šï¼šé»„è‰² */
        .status-dead { color: #F44336; font-weight: bold; } /* â˜ ï¸ æŒ‚äº†ï¼šçº¢è‰² */
        .keys { font-size: 12px; color: #777; margin-top: 12px; padding-top: 8px; border-top: 1px solid #333;}
    </style>
</head>
<body>

    <!-- ğŸ–¼ï¸ è¿™é‡Œæ˜¯æ¸¸æˆæ˜¾ç¤ºçš„å®¹å™¨ -->
    <div id="canvas-container">
        <div id="ui-layer">
            <h1>ğŸ¤– AI æ™ºèƒ½è´ªåƒè›‡ v2.0</h1>
            <p>åˆ†æ•°: <span id="score">0</span></p>
            <p>çŠ¶æ€: <span id="status" class="status-ok">è¿è¡Œä¸­</span></p>
            <p class="keys">[R] é‡æ¥ | [P] æš‚åœ</p>
        </div>
    </div>

    <!-- ğŸ§  <script> é‡Œé¢æ˜¯ JavaScriptï¼Œè¿™é‡Œæ˜¯æ¸¸æˆçš„å¤§è„‘å’Œé€»è¾‘ï¼ -->
    <script>
        // --- âš™ï¸ é…ç½®åŒº (å°±åƒæ¸¸æˆè®¾ç½®) ---
        const COLS = 20; // ğŸ åœ°å›¾æ¨ªç€åˆ‡æˆ20æ ¼
        const ROWS = 20; // ğŸ åœ°å›¾ç«–ç€åˆ‡æˆ20æ ¼
        const FPS = 20;  // â±ï¸ æ¸¸æˆé€Ÿåº¦ï¼šæ¯ç§’åˆ·æ–°20æ¬¡ (å¸§ç‡)
        const OBSTACLE_COUNT = 8; // ğŸ§± å¢™å£éšœç¢ç‰©çš„æ•°é‡

        // --- ğŸ“¦ å…¨å±€å˜é‡ (å¤§å®¶çš„å…¬å…±èƒŒåŒ…ï¼Œè°éƒ½èƒ½ç”¨é‡Œé¢çš„ä¸œè¥¿) ---
        let cellW, cellH; // ğŸ“ æ¯ä¸€å°æ ¼å­çš„å®½åº¦å’Œé«˜åº¦
        let snake;        // ğŸ æˆ‘ä»¬çš„ä¸»è§’ï¼šè›‡
        let food;         // ğŸ é£Ÿç‰©
        let walls = [];   // ğŸ§± æ‰€æœ‰çš„å¢™éƒ½åœ¨è¿™ä¸ªåˆ—è¡¨é‡Œ
        let grid = [];    // ğŸ—ºï¸ æ•´ä¸ªåœ°å›¾ç½‘æ ¼æ•°æ®
        let path = [];    // ğŸ“ è›‡è„‘å­é‡Œçš„å¯¼èˆªè·¯çº¿ (GPSè·¯å¾„)
        let isPaused = false;   // â¸ï¸ æ˜¯å¦æš‚åœäº†ï¼Ÿ
        let isGameOver = false; // ğŸ’€ æ¸¸æˆç»“æŸäº†å—ï¼Ÿ
        let score = 0;          // ğŸ’¯ å¾—åˆ†
        
        let scoreEl, statusEl;  // ç”¨æ¥æ§åˆ¶ç½‘é¡µä¸Šæ–‡å­—æ˜¾ç¤ºçš„å˜é‡

        // ğŸ¬ SETUP å‡½æ•°ï¼šæ¸¸æˆå¯åŠ¨æ—¶åªè¿è¡Œä¸€æ¬¡ï¼Œç›¸å½“äºâ€œå‡†å¤‡å·¥ä½œâ€
        function setup() {
            // åˆ›å»ºç”»å¸ƒ
            let size = min(windowWidth, windowHeight) * 0.95; // ç®—ä¸€ä¸‹å±å¹•å¤§å°ï¼Œå–95%é˜²æ­¢å¤ªæ»¡
            let canvas = createCanvas(size, size); // ğŸ¨ åˆ›å»ºç”»æ¿
            canvas.parent('canvas-container');     // æŠŠç”»æ¿æŒ‚åˆ°ç½‘é¡µçš„æ¡†æ¡†é‡Œ
            frameRate(FPS); // è®¾å®šé€Ÿåº¦
            
            // æ‰¾åˆ°ç½‘é¡µä¸Šæ˜¾ç¤ºåˆ†æ•°å’ŒçŠ¶æ€çš„åœ°æ–¹
            scoreEl = document.getElementById('score');
            statusEl = document.getElementById('status');

            // â–¶ï¸ å¼€å§‹æ¸¸æˆï¼
            resetGame();
        }

        // ğŸ“ å½“ä½ æ”¹å˜æµè§ˆå™¨çª—å£å¤§å°æ—¶ï¼Œè‡ªåŠ¨è°ƒæ•´æ¸¸æˆå¤§å°
        function windowResized() {
            let size = min(windowWidth, windowHeight) * 0.95;
            resizeCanvas(size, size);
            cellW = width / COLS;  // é‡æ–°è®¡ç®—æ ¼å­å®½åº¦
            cellH = height / ROWS; // é‡æ–°è®¡ç®—æ ¼å­é«˜åº¦
        }

        // ğŸ”„ é‡ç½®æ¸¸æˆï¼šæŠŠä¸€åˆ‡å½’é›¶
        function resetGame() {
            cellW = width / COLS;
            cellH = height / ROWS;
            score = 0;
            isGameOver = false;
            isPaused = false;
            path = [];
            if(scoreEl) scoreEl.innerText = score; // æ›´æ–°ç½‘é¡µä¸Šçš„åˆ†æ•°ä¸º0
            updateStatus("å¯»æ‰¾é£Ÿç‰©ä¸­...", "status-ok");

            // ğŸ—ï¸ åˆå§‹åŒ–ç½‘æ ¼åœ°å›¾ (æŠŠåœ°å›¾åˆ‡æˆä¸€ä¸ªä¸ªå°æ–¹å—å¯¹è±¡)
            grid = new Array(COLS);
            for (let i = 0; i < COLS; i++) {
                grid[i] = new Array(ROWS);
                for (let j = 0; j < ROWS; j++) {
                    grid[i][j] = new Node(i, j); // æ¯ä¸ªæ ¼å­éƒ½æ˜¯ä¸€ä¸ªâ€œèŠ‚ç‚¹â€
                }
            }
            // ğŸ¤ è®©æ¯ä¸ªæ ¼å­éƒ½è®¤è¯†å®ƒçš„é‚»å±… (ä¸ºäº†å¯»è·¯ç®—æ³•çŸ¥é“å“ªå„¿é€šå“ªå„¿ä¸é€š)
            for (let i = 0; i < COLS; i++) {
                for (let j = 0; j < ROWS; j++) {
                    grid[i][j].addNeighbors(grid);
                }
            }

            snake = new Snake(); // ğŸ£ å­µåŒ–ä¸€æ¡æ–°è›‡
            generateWalls();     // ğŸ§± é€ å‡ å µå¢™
            spawnFoodSmart();    // ğŸ èªæ˜åœ°ç”Ÿæˆé£Ÿç‰© (ä¸ç”Ÿåœ¨å¢™é‡Œ)
            calculatePath();     // ğŸ—ºï¸ å¼€å¯ç¬¬ä¸€æ¬¡å¯¼èˆª
        }

        // ğŸ¬ DRAW å‡½æ•°ï¼šè¿™æ˜¯æ¸¸æˆçš„å¿ƒè„ï¼Œæ¯ç§’é’Ÿè¿è¡Œ 20 æ¬¡
        function draw() {
            background(25); // ğŸ§¹ æ¯ä¸€å¸§å…ˆç”¨æ·±ç°è‰²æŠŠå±å¹•æ¶‚æ»¡ (æ“¦é»‘æ¿)

            // å¦‚æœæ¸¸æˆç»“æŸäº†ï¼Œç”»å®Œç”»é¢å°±åœä¸‹ï¼Œä¸ç»§ç»­è·‘é€»è¾‘äº†
            if (isGameOver) {
                drawGameElements(); // ç”»è›‡ã€å¢™ã€é£Ÿç‰©
                drawOverlay("GAME OVER", "æŒ‰ 'R' é”®é‡æ–°å¼€å§‹"); // æ˜¾ç¤ºç»“æŸæ–‡å­—
                return;
            }

            // å¦‚æœæš‚åœäº†
            if (isPaused) {
                drawGameElements();
                drawOverlay("PAUSED", "æŒ‰ 'P' é”®ç»§ç»­");
                return;
            }

            // --- æ ¸å¿ƒå¾ªç¯é€»è¾‘ (è›‡çš„å¤§è„‘åœ¨æ€è€ƒ) ---
            
            // 1. ğŸ—ºï¸ è§„åˆ’è·¯å¾„ï¼šçœ‹çœ‹æ€ä¹ˆèµ°èƒ½åƒåˆ°è‹¹æœ
            calculatePath(); 
            
            // 2. ğŸ§­ å†³å®šä¸‹ä¸€æ­¥ï¼šæ ¹æ®å¯¼èˆªæˆ–è€…å®‰å…¨ç­–ç•¥è¿ˆå‡ºè„š
            let nextMove = getNextMove();

            if (nextMove) {
                // å‘Šè¯‰è›‡ï¼šå¾€è¿™è¾¹è½¬ï¼
                snake.setDir(nextMove.x, nextMove.y);
            }

            // 3. ğŸƒ æ›´æ–°ç‰©ç†ä½ç½®ï¼šè›‡çœŸçš„åŠ¨èµ·æ¥äº†
            snake.update();

            // 4. ğŸ’¥ ç¢°æ’æ£€æµ‹ï¼šå¤´æ˜¯ä¸æ˜¯æ’å¢™äº†ï¼Ÿ
            if (snake.checkCollision(walls)) {
                gameOver();
            }

            // 5. ğŸ½ï¸ åƒé¥­æ£€æµ‹ï¼šæ˜¯ä¸æ˜¯åƒåˆ°è‹¹æœäº†ï¼Ÿ
            if (snake.eat(food)) {
                snake.grow(); // èº«ä½“å˜é•¿
                score++;      // åˆ†æ•°åŠ 1
                scoreEl.innerText = score; // ç½‘é¡µæ˜¾ç¤ºæ›´æ–°
                spawnFoodSmart(); // ç”Ÿæˆä¸‹ä¸€ä¸ªè‹¹æœ
            }

            // 6. ğŸ¨ æ¸²æŸ“ï¼šæŠŠæ‰€æœ‰ç®—å¥½çš„ä¸œè¥¿ç”»å‡ºæ¥
            drawGameElements();
        }

        // ğŸ–Œï¸ ä¸“é—¨è´Ÿè´£â€œç”»ç”»â€çš„å‡½æ•°
        function drawGameElements() {
            drawGrid();  // ç”»ç½‘æ ¼çº¿
            drawWalls(); // ç”»å¢™
            drawPath();  // ç”»é‚£æ¡é»„è‰²çš„å¯¼èˆªçº¿ (è®©ä½ çœ‹åˆ°AIåœ¨æƒ³ä»€ä¹ˆ)
            drawFood();  // ç”»è‹¹æœ
            snake.show(); // ç”»è›‡
        }

        // ğŸ–Œï¸ ç”»è¦†ç›–å±‚ (æ¯”å¦‚ Game Over æ—¶çš„é»‘æ¡†)
        function drawOverlay(title, subtitle) {
            fill(0, 0, 0, 180); // åŠé€æ˜é»‘
            rect(0, 0, width, height); // ç›–ä½å…¨å±
            fill(255); // ç™½è‰²å­—
            noStroke();
            textAlign(CENTER, CENTER); // æ–‡å­—å±…ä¸­
            textSize(width/12); // å¤§æ ‡é¢˜å­—å·
            text(title, width/2, height/2 - 20);
            textSize(width/28); // å‰¯æ ‡é¢˜å­—å·
            fill(200); // æµ…ç°è‰²
            text(subtitle, width/2, height/2 + 40);
        }

        // âŒ¨ï¸ é”®ç›˜ç›‘å¬ï¼šå½“ç©å®¶æŒ‰ä¸‹é”®ç›˜æ—¶è§¦å‘
        function keyPressed() {
            if (key === 'r' || key === 'R') resetGame(); // æŒ‰Ré‡å¼€
            if (key === 'p' || key === 'P') isPaused = !isPaused; // æŒ‰Pæš‚åœ
        }

        // --- ğŸ å®ä½“ç±»ï¼šå®šä¹‰è›‡æ˜¯ä»€ä¹ˆ ---

        class Snake {
            constructor() {
                this.body = [];
                // ğŸ“ è›‡å‡ºç”Ÿåœ¨åœ°å›¾æ­£ä¸­é—´
                let startX = floor(COLS / 2);
                let startY = floor(ROWS / 2);
                this.body[0] = createVector(startX, startY); // è›‡å¤´ä½ç½®
                this.xDir = 0; // Xè½´ç§»åŠ¨æ–¹å‘ (ä¸åŠ¨)
                this.yDir = 0; // Yè½´ç§»åŠ¨æ–¹å‘ (ä¸åŠ¨)
                this.growCount = 0; // è¿˜è¦é•¿å‡ èŠ‚èº«ä½“ï¼Ÿ
            }

            // ğŸ§­ è®¾ç½®æ–¹å‘
            setDir(x, y) {
                // ğŸ›¡ï¸ é˜²è‡ªæ€ä¿æŠ¤ï¼š
                // å¦‚æœè›‡æ­£åœ¨å¾€å³èµ°ï¼Œä¸èƒ½çªç„¶è®©å®ƒå¾€å·¦èµ° (ä¸ç„¶å°±å¤´æ’è„–å­è‡ªæ€äº†)
                if (this.body.length > 1) {
                    if (x === -this.xDir && y === -this.yDir) {
                        return; // å¿½ç•¥è¿™ä¸ªé”™è¯¯çš„å‘½ä»¤
                    }
                }
                this.xDir = x;
                this.yDir = y;
            }

            // ğŸƒ è›‡ç§»åŠ¨çš„æ ¸å¿ƒé€»è¾‘
            update() {
                // å¦‚æœæ–¹å‘æ˜¯0 (è¿˜æ²¡å¼€å§‹åŠ¨)ï¼Œå°±ä¸åŠ¨
                if (this.xDir === 0 && this.yDir === 0) return;

                // å¤åˆ¶ç°åœ¨çš„å¤´ï¼Œä½œä¸ºæ–°å¤´çš„åŸºç¡€
                let head = this.body[this.body.length - 1].copy();
                
                // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼š
                // å¦‚æœè¦é•¿å¤§ï¼Œå°±ä¸åˆ å°¾å·´ï¼Œç›´æ¥åŠ ä¸ªå¤´ (èº«ä½“å°±å˜é•¿äº†)
                // å¦‚æœä¸é•¿å¤§ï¼Œå°±åˆ æ‰å°¾å·´ï¼ŒåŠ ä¸ªå¤´ (èº«ä½“çœ‹èµ·æ¥å°±åœ¨ç§»åŠ¨)
                if (this.growCount > 0) {
                    this.growCount--; // æ¶ˆè€—ä¸€æ¬¡ç”Ÿé•¿æœºä¼š
                } else {
                    this.body.shift(); // âœ‚ï¸ åˆ æ‰å°¾å·´çš„ç¬¬ä¸€ä¸ªæ ¼å­
                }

                // æ–°å¤´çš„ä½ç½® = è€å¤´çš„ä½ç½® + æ–¹å‘
                head.x += this.xDir;
                head.y += this.yDir;
                this.body.push(head); // ğŸ“Œ æŠŠæ–°å¤´åŠ ä¸Šå»
            }

            grow() {
                this.growCount++; // è®°å½•ä¸€ä¸‹ï¼šæˆ‘è¦é•¿å¤§ï¼
            }

            // ğŸ½ï¸ æ£€æŸ¥æœ‰æ²¡æœ‰åƒåˆ°ä¸œè¥¿
            eat(pos) {
                let head = this.body[this.body.length - 1];
                // å¦‚æœå¤´çš„åæ ‡ ç­‰äº é£Ÿç‰©çš„åæ ‡
                return (head.x === pos.x && head.y === pos.y);
            }

            // ğŸ’¥ æ£€æŸ¥æœ‰æ²¡æœ‰æ’è½¦
            checkCollision(walls) {
                let head = this.body[this.body.length - 1];
                
                // 1. æ’è¾¹ç•Œäº†å—ï¼Ÿ(å‡ºç•Œäº†)
                if (head.x >= COLS || head.x < 0 || head.y >= ROWS || head.y < 0) return true;

                // 2. æ’è‡ªå·±äº†å—ï¼Ÿ(å’¬åˆ°èº«ä½“äº†)
                // éå†èº«ä½“é™¤äº†å¤´ä»¥å¤–çš„æ¯ä¸€èŠ‚
                for (let i = 0; i < this.body.length - 1; i++) {
                    if (this.body[i].x === head.x && this.body[i].y === head.y) return true;
                }

                // 3. æ’å¢™äº†å—ï¼Ÿ(æ’åˆ°éšœç¢ç‰©)
                for (let wall of walls) {
                    if (head.x === wall.x && head.y === wall.y) return true;
                }
                return false; // å•¥éƒ½æ²¡æ’ï¼Œå¹³å®‰æ— äº‹
            }

            // ğŸ¨ æŠŠè›‡ç”»å‡ºæ¥
            show() {
                noStroke();
                for (let i = 0; i < this.body.length; i++) {
                    // i æ˜¯å½“å‰çš„ç¬¬å‡ èŠ‚èº«ä½“
                    
                    // å¦‚æœæ˜¯æœ€åä¸€æ®µ (ä¹Ÿå°±æ˜¯å¤´)
                    if (i === this.body.length - 1) {
                        fill(76, 175, 80); // ğŸŸ¢ å¤´æ˜¯äº®ç»¿è‰²çš„
                    } else {
                        // ğŸŒˆ èº«ä½“åšä¸ªæ¸å˜è‰²ï¼Œçœ‹èµ·æ¥é«˜çº§ä¸€ç‚¹
                        let c = map(i, 0, this.body.length, 100, 200);
                        fill(50, c, 50);
                    }
                    
                    // ç®—ä¸€ä¸‹è¿™èŠ‚èº«ä½“åœ¨ç”»å¸ƒä¸Šçš„åƒç´ ä½ç½®
                    let x = this.body[i].x * cellW;
                    let y = this.body[i].y * cellH;
                    
                    // ç”»ä¸ªæ–¹å— (ç¨å¾®å°ä¸€ç‚¹ç‚¹ï¼Œç•™å‡ºç¼éš™å¥½çœ‹)
                    rect(x + 1, y + 1, cellW - 2, cellH - 2, 4);
                    
                    // ğŸ‘€ å¦‚æœæ˜¯å¤´ï¼Œç»™å®ƒç”»ä¸¤ä¸ªå°çœ¼ç›
                    if (i === this.body.length - 1) {
                        fill(0); // é»‘è‰²çœ¼ç›
                        // æ ¹æ®æ–¹å‘å†³å®šçœ¼ç›ç”»åœ¨å“ªè¾¹ (ç»†èŠ‚!)
                        if (this.xDir === 1) { // å‘å³çœ‹
                            rect(x + cellW*0.6, y + cellH*0.2, 4, 4);
                            rect(x + cellW*0.6, y + cellH*0.6, 4, 4);
                        } else if (this.xDir === -1) { // å‘å·¦çœ‹
                            rect(x + cellW*0.2, y + cellH*0.2, 4, 4);
                            rect(x + cellW*0.2, y + cellH*0.6, 4, 4);
                        } else if (this.yDir === -1) { // å‘ä¸Šçœ‹
                            rect(x + cellW*0.2, y + cellH*0.2, 4, 4);
                            rect(x + cellW*0.6, y + cellH*0.2, 4, 4);
                        } else { // å‘ä¸‹çœ‹
                            rect(x + cellW*0.2, y + cellH*0.6, 4, 4);
                            rect(x + cellW*0.6, y + cellH*0.6, 4, 4);
                        }
                    }
                }
            }
            
            // ğŸ” è¾…åŠ©åŠŸèƒ½ï¼šæ£€æŸ¥æŸä¸ªåæ ‡æ˜¯ä¸æ˜¯åœ¨è›‡èº«ä¸Š
            contains(x, y) {
                for (let part of this.body) {
                    if (part.x === x && part.y === y) return true;
                }
                return false;
            }
        }

        // --- ğŸŒ åœ°å›¾ç”ŸæˆåŒº ---

        // ğŸ§  èªæ˜çš„ç”Ÿæˆé£Ÿç‰©ï¼šä¸ä»…è¦éšæœºï¼Œè¿˜ä¸èƒ½ç”Ÿæˆåœ¨æ­»èƒ¡åŒé‡Œ
        function spawnFoodSmart() {
            let attempts = 0; // å°è¯•æ¬¡æ•°
            let valid = false; // æ˜¯å¦æˆåŠŸ
            
            // å°è¯•æœ€å¤š100æ¬¡æ‰¾ä¸ªå¥½ä½ç½®
            while(attempts < 100) {
                let rX = floor(random(COLS));
                let rY = floor(random(ROWS));
                
                // 1. å¿…é¡»æ˜¯ç©ºåœ° (ä¸æ˜¯å¢™ï¼Œä¹Ÿä¸æ˜¯è›‡èº«ä½“)
                if (!isWall(rX, rY) && !snake.contains(rX, rY)) {
                    // 2. å¿…é¡»æ˜¯èƒ½èµ°åˆ°çš„ (ç”¨A*ç®—æ³•å¿«é€Ÿæ£€æŸ¥ä¸€ä¸‹ï¼Œé˜²æ­¢é£Ÿç‰©ç”Ÿåœ¨å°é—­çš„å¢™é‡Œ)
                    let head = snake.body[snake.body.length-1];
                    // è¿™é‡Œ 'true' è¡¨ç¤ºä¸¥æ ¼æ£€æŸ¥å¢™å£
                    if (findPath(head, createVector(rX, rY), true)) {
                        food = createVector(rX, rY);
                        valid = true;
                        break; // æ‰¾åˆ°äº†ï¼Œé€€å‡ºå¾ªç¯
                    }
                }
                attempts++;
            }
            
            // ğŸš‘ ç´§æ€¥é¢„æ¡ˆï¼šå¦‚æœåœ°å›¾å¤ªæŒ¤äº†ï¼Œå®åœ¨æ‰¾ä¸åˆ°å®Œç¾ä½ç½®
            // å°±éšä¾¿æ‰¾ä¸ªç©ºåœ°ï¼Œä¸æ£€æŸ¥èƒ½ä¸èƒ½èµ°åˆ°äº† (é˜²æ­¢æ¸¸æˆå¡æ­»)
            if (!valid) {
                for(let i=0; i<50; i++) {
                    let rX = floor(random(COLS));
                    let rY = floor(random(ROWS));
                    if (!isWall(rX, rY) && !snake.contains(rX, rY)) {
                        food = createVector(rX, rY);
                        break;
                    }
                }
            }
        }

        // ğŸ§± éšæœºé€ å¢™
        function generateWalls() {
            walls = [];
            let head = snake.body[0];
            for (let i = 0; i < OBSTACLE_COUNT; i++) {
                let x = floor(random(COLS));
                let y = floor(random(ROWS));
                
                // ğŸ›¡ï¸ ä¿æŠ¤åŒºï¼šåˆ«ç›´æ¥æŠŠå¢™ç›–åœ¨è›‡å¤´è„¸ä¸Šï¼Œç»™å®ƒç•™ç‚¹èµ·æ­¥ç©ºé—´
                if (dist(x, y, head.x, head.y) > 4) {
                    walls.push(createVector(x, y));
                }
            }
        }
        
        // ğŸ” æ£€æŸ¥æŸä¸ªç‚¹æ˜¯ä¸æ˜¯å¢™
        function isWall(x, y) {
            return walls.some(w => w.x === x && w.y === y);
        }

        // --- ğŸ—ºï¸ å¯»è·¯ç®—æ³•åŒº (è¿™æ˜¯æ•´ä¸ªAIæœ€éš¾ä¹Ÿæœ€æ ¸å¿ƒçš„éƒ¨åˆ†) ---
        // æˆ‘ä»¬ç”¨çš„æ˜¯ A* ç®—æ³• (A-Star)ï¼Œå®ƒæ˜¯æ¸¸æˆé‡Œæœ€å¸¸ç”¨çš„æ‰¾è·¯æ–¹æ³•

        function calculatePath() {
            let head = snake.body[snake.body.length - 1];
            // å‘¼å« findPath å‡½æ•°å»æ‰¾è·¯
            let result = findPath(head, food);
            
            if (result) {
                path = result; // æ‰¾åˆ°è·¯äº†ï¼å­˜èµ·æ¥
                updateStatus("å‘ç°è·¯å¾„", "status-ok");
            } else {
                path = []; // æ²¡è·¯äº†...
                updateStatus("æ±‚ç”Ÿæ¨¡å¼", "status-warn");
                // è¿™é‡Œä¸æ…Œï¼Œåé¢ä¼šæœ‰ getSafeMove å…œåº•
            }
        }

        // A* å¯»è·¯æ ¸å¿ƒå‡½æ•°
        // startPos: èµ·ç‚¹, endPos: ç»ˆç‚¹, strict: æ˜¯å¦ä¸¥æ ¼æ¨¡å¼
        function findPath(startPos, endPos, strict = false) {
            // ğŸ§¹ å…ˆæŠŠåœ°å›¾æ•°æ®é‡ç½®ä¸€ä¸‹ï¼Œæ¸…ç©ºä¹‹å‰çš„è®¡ç®—
            for (let i = 0; i < COLS; i++) {
                for (let j = 0; j < ROWS; j++) {
                    grid[i][j].reset();
                    // æ ‡è®°å“ªé‡Œæ˜¯å¢™
                    if (isWall(i, j)) grid[i][j].wall = true;
                }
            }

            // ğŸ æŠŠè›‡çš„èº«ä½“ä¹Ÿå½“æˆå¢™ (é™¤éè›‡å°¾å·´å³å°†ç§»èµ°)
            for (let i = 0; i < snake.body.length; i++) {
                let part = snake.body[i];
                
                // è¿™æ˜¯ä¸€ä¸ªå¾ˆèªæ˜çš„åˆ¤æ–­ï¼š
                // è›‡å°¾å·´ (i===0) ä¸‹ä¸€æ­¥ä¼šç§»èµ°ï¼Œæ‰€ä»¥å…¶å®æ˜¯å¯ä»¥èµ°çš„ï¼
                // é™¤éï¼šè›‡æ­£åœ¨å˜é•¿(å°¾å·´ä¸åŠ¨)ï¼Œæˆ–è€…è¿™æ˜¯è„–å­(é˜²å›å¤´)
                let isTail = (i === 0);
                let isNeck = (snake.body.length > 1 && i === snake.body.length - 2);

                if (isTail && snake.growCount === 0 && !strict && !isNeck) {
                    continue; // å°¾å·´ä¸æ˜¯å¢™ï¼Œå¯ä»¥èµ°
                }

                if (grid[part.x] && grid[part.x][part.y]) {
                    grid[part.x][part.y].wall = true; // æŠŠèº«ä½“æ ‡è®°ä¸ºå¢™
                }
            }

            let start = grid[startPos.x][startPos.y];
            let end = grid[endPos.x][endPos.y];

            // ç¡®ä¿èµ·ç‚¹å’Œç»ˆç‚¹æœ¬èº«ä¸æ˜¯å¢™ (ä¸ç„¶æ²¡æ³•å¯»è·¯)
            if (start) start.wall = false;
            if (end) end.wall = false;

            // openSet: å¾…æ£€æŸ¥çš„æ ¼å­ (æ’é˜Ÿåˆ—è¡¨)
            let openSet = [start];
            // closedSet: å·²ç»æ£€æŸ¥è¿‡çš„æ ¼å­ (é˜²æ­¢èµ°å›å¤´è·¯)
            let closedSet = [];

            // ğŸ”„ åªè¦è¿˜æœ‰æ ¼å­æ²¡æ£€æŸ¥å®Œ
            while (openSet.length > 0) {
                // 1. åœ¨å¾…æ£€æŸ¥åˆ—è¡¨ä¸­ï¼Œæ‰¾å‡ºâ€œè¯„åˆ†â€æœ€å¥½çš„æ ¼å­ (ç¦»ç»ˆç‚¹æœ€è¿‘çš„)
                let winner = 0;
                for (let i = 0; i < openSet.length; i++) {
                    if (openSet[i].f < openSet[winner].f) winner = i;
                }
                let current = openSet[winner];

                // ğŸ å¦‚æœè¿™ä¸ªæ ¼å­å°±æ˜¯ç»ˆç‚¹
                if (current === end) {
                    // ğŸ‰ æ‰¾åˆ°è·¯äº†ï¼
                    // ç°åœ¨æˆ‘ä»¬è¦å€’ç€å¾€å›æ¨ï¼ŒæŠŠè·¯ç»è®°å½•ä¸‹æ¥
                    let tempPath = [];
                    let temp = current;
                    tempPath.push(temp);
                    while (temp.previous) {
                        tempPath.push(temp.previous);
                        temp = temp.previous;
                    }
                    return tempPath; // è¿”å›å®Œæ•´çš„è·¯å¾„
                }

                // æŠŠå½“å‰æ ¼å­ç§»å‡ºâ€œå¾…æ£€æŸ¥â€ï¼Œæ”¾å…¥â€œå·²æ£€æŸ¥â€
                openSet.splice(winner, 1);
                closedSet.push(current);

                // ğŸ” çœ‹çœ‹å½“å‰æ ¼å­çš„é‚»å±…ä»¬ (ä¸Šä¸‹å·¦å³)
                for (let neighbor of current.neighbors) {
                    // å¦‚æœé‚»å±…æ²¡è¢«æ£€æŸ¥è¿‡ï¼Œè€Œä¸”ä¸æ˜¯å¢™
                    if (!closedSet.includes(neighbor) && !neighbor.wall) {
                        let tempG = current.g + 1; // èµ°åˆ°é‚»å±…è¿™é‡Œéœ€è¦å¤šèŠ±1æ­¥
                        
                        let newPath = false;
                        if (openSet.includes(neighbor)) {
                            // å¦‚æœé‚»å±…å·²ç»åœ¨æ’é˜Ÿäº†ï¼Œçœ‹çœ‹æˆ‘æ˜¯ä¸æ˜¯ä¸€æ¡æ›´è¿‘çš„è·¯ï¼Ÿ
                            if (tempG < neighbor.g) {
                                neighbor.g = tempG;
                                newPath = true;
                            }
                        } else {
                            // å¦‚æœé‚»å±…æ²¡æ’é˜Ÿï¼ŒæŠŠå®ƒåŠ è¿›å»
                            neighbor.g = tempG;
                            newPath = true;
                            openSet.push(neighbor);
                        }

                        // ğŸ“Š å¦‚æœè¿™æ˜¯ä¸€æ¡å¥½è·¯ï¼Œè®¡ç®—è¯„åˆ†
                        if (newPath) {
                            // Hå€¼ï¼šä¼°ç®—é‚»å±…åˆ°ç»ˆç‚¹çš„è·ç¦» (æ›¼å“ˆé¡¿è·ç¦»ï¼šæ¨ªåæ ‡å·®+çºµåæ ‡å·®)
                            neighbor.h = abs(neighbor.i - end.i) + abs(neighbor.j - end.j);
                            // Få€¼ï¼šG(å·²èµ°æ­¥æ•°) + H(é¢„ä¼°å‰©ä½™æ­¥æ•°) = æ€»è¯„åˆ†
                            neighbor.f = neighbor.g + neighbor.h;
                            // è®°ä¸‹æ¥ï¼šæˆ‘æ˜¯ä» current èµ°åˆ° neighbor çš„
                            neighbor.previous = current;
                        }
                    }
                }
            }
            return null; // ğŸš« æ‰¾éäº†æ‰€æœ‰æ ¼å­éƒ½æ²¡è·¯
        }

        // ğŸ¤– AI å†³ç­–å‡½æ•°ï¼šä¸‹ä¸€æ­¥æ€ä¹ˆèµ°ï¼Ÿ
        function getNextMove() {
            let head = snake.body[snake.body.length - 1];

            // æ–¹æ¡ˆ A: å¦‚æœæœ‰ GPS è·¯å¾„ï¼Œè·Ÿç€è·¯å¾„èµ°
            if (path.length > 1) {
                // è·¯å¾„æ˜¯å€’ç€å­˜çš„ [ç»ˆç‚¹, ..., ä¸‹ä¸€æ­¥, èµ·ç‚¹]
                // æ‰€ä»¥ path.length - 2 å°±æ˜¯æˆ‘ä»¬è¦èµ°çš„ä¸‹ä¸€æ­¥
                let nextNode = path[path.length - 2];
                return { x: nextNode.i - head.x, y: nextNode.j - head.y };
            }

            // æ–¹æ¡ˆ B: å¦‚æœæ²¡è·¯äº† (å¯èƒ½è¢«è‡ªå·±å›´ä½äº†)ï¼Œå¯åŠ¨ä¿å‘½æ¨¡å¼
            // å°½é‡æ‰¾ä¸ªä¸æ­»çš„åœ°æ–¹èµ°ä¸€æ­¥ï¼Œå“ªæ€•ç¦»é£Ÿç‰©è¿œä¸€ç‚¹
            return getSafeMove(head);
        }

        // ğŸš‘ ä¿å‘½ç§»åŠ¨é€»è¾‘
        function getSafeMove(head) {
            // ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘
            let moves = [
                {x:0, y:-1}, {x:0, y:1}, {x:-1, y:0}, {x:1, y:0}
            ];

            // è¿‡æ»¤å‡ºåˆæ³•çš„ç§»åŠ¨ (ä¸å‡ºç•Œã€ä¸æ’å¢™ã€ä¸æ’èº«ä½“)
            let validMoves = moves.filter(m => {
                let nx = head.x + m.x;
                let ny = head.y + m.y;
                
                // æ£€æŸ¥è¾¹ç•Œ
                if (nx < 0 || nx >= COLS || ny < 0 || ny >= ROWS) return false;
                // æ£€æŸ¥å¢™
                if (isWall(nx, ny)) return false;
                // æ£€æŸ¥èº«ä½“
                for(let i = 0; i < snake.body.length; i++) {
                    let part = snake.body[i];
                    // å¦‚æœæ˜¯å°¾å·´ä¸”ä¸ç”Ÿé•¿ï¼Œå°¾å·´ä¼šç©ºå‡ºæ¥ï¼Œç®—å®‰å…¨çš„
                    if (i === 0 && snake.growCount === 0) continue;
                    if (part.x === nx && part.y === ny) return false;
                }
                return true;
            });

            // å¦‚æœæ­»è·¯ä¸€æ¡ï¼Œé‚£ä¹Ÿæ²¡åŠæ³•äº†
            if (validMoves.length === 0) return null;

            // ğŸ§  å¯å‘å¼é€ƒè·‘ï¼š
            // åœ¨æ‰€æœ‰èƒ½èµ°çš„æ–¹å‘é‡Œï¼Œé€‰ä¸€ä¸ªç¦»è›‡å°¾å·´æœ€è¿œçš„ï¼
            // ä¸ºä»€ä¹ˆè¦ç¦»å°¾å·´è¿œï¼Ÿå› ä¸ºè·Ÿç€å°¾å·´èµ°é€šå¸¸èƒ½ç»•åœˆåœˆï¼Œä¸å®¹æ˜“æ­»
            let tail = snake.body[0];
            validMoves.sort((a, b) => {
                let posA = {x: head.x + a.x, y: head.y + a.y};
                let posB = {x: head.x + b.x, y: head.y + b.y};
                
                // ç®—å‡ºè·ç¦»
                let distA = dist(posA.x, posA.y, tail.x, tail.y);
                let distB = dist(posB.x, posB.y, tail.x, tail.y);
                
                // é™åºæ’åˆ— (å¤§çš„åœ¨å‰)
                return distB - distA;
            });

            return validMoves[0]; // è¿”å›æœ€å¥½çš„é‚£ä¸€æ­¥
        }

        // --- ğŸ–Œï¸ ç»˜å›¾è¾…åŠ©å‡½æ•° (çº¯è‹¦åŠ›æ´») ---

        // ç”»æ ¼å­çº¿
        function drawGrid() {
            stroke(40); // ç°è‰²çº¿æ¡
            strokeWeight(1); // ç»†çº¿
            for (let x = 0; x <= width; x += cellW) line(x, 0, x, height); // ç«–çº¿
            for (let y = 0; y <= height; y += cellH) line(0, y, width, y); // æ¨ªçº¿
        }

        // ç”»å¢™å£
        function drawWalls() {
            fill(80); // æ·±ç°è‰²
            stroke(30);
            strokeWeight(2);
            for (let wall of walls) {
                rect(wall.x * cellW, wall.y * cellH, cellW, cellH, 2);
                // ç”»ä¸ªXåšè£…é¥°
                line(wall.x*cellW, wall.y*cellH, (wall.x+1)*cellW, (wall.y+1)*cellH);
            }
        }

        // ç”»é£Ÿç‰© (ä¸€ä¸ªè·³åŠ¨çš„ç²‰è‰²çƒ)
        function drawFood() {
            fill(255, 64, 129); // ç²‰è‰²
            noStroke();
            let cx = food.x * cellW + cellW/2; // ç®—åœ†å¿ƒX
            let cy = food.y * cellH + cellH/2; // ç®—åœ†å¿ƒY
            let r = cellW * 0.7; // åŠå¾„
            // è®©å®ƒåƒå¿ƒè·³ä¸€æ ·å¿½å¤§å¿½å°
            let pulse = sin(frameCount * 0.2) * 4;
            ellipse(cx, cy, r + pulse);
        }

        // ç”» AI çš„æ€è€ƒè·¯å¾„ (é»„è‰²çš„ç»†çº¿)
        function drawPath() {
            if (!path.length) return;
            noFill();
            stroke(255, 235, 59, 100); // é»„è‰²ï¼Œå¸¦ç‚¹é€æ˜
            strokeWeight(cellW * 0.15);
            beginShape(); // å¼€å§‹è¿çº¿
            let head = snake.body[snake.body.length - 1];
            vertex(head.x * cellW + cellW/2, head.y * cellH + cellH/2);
            // æŠŠè·¯å¾„ç‚¹ä¸€ä¸ªä¸ªè¿èµ·æ¥
            for (let i = path.length - 2; i >= 0; i--) {
                vertex(path[i].i * cellW + cellW/2, path[i].j * cellH + cellH/2);
            }
            endShape(); // ç»“æŸè¿çº¿
        }

        function gameOver() {
            isGameOver = true;
            updateStatus("æ¸¸æˆç»“æŸ", "status-dead");
        }

        function updateStatus(msg, cls) {
            if(statusEl) {
                statusEl.innerText = msg;
                statusEl.className = cls;
            }
        }

        // --- ğŸ§± Node ç±»ï¼šåœ°å›¾ä¸Šçš„æ¯ä¸€ä¸ªæ ¼å­ ---
        // ä¸ºäº†å¯»è·¯ç®—æ³•ï¼Œæ¯ä¸ªæ ¼å­éœ€è¦è®°å½•ä¸€äº›ä¿¡æ¯

        class Node {
            constructor(i, j) {
                this.i = i; // æ ¼å­çš„Xåæ ‡
                this.j = j; // æ ¼å­çš„Yåæ ‡
                this.f = 0; // æ€»è¯„åˆ†
                this.g = 0; // èµ°åˆ°è¿™é‡ŒèŠ±äº†å¤šå°‘æ­¥
                this.h = 0; // é¢„ä¼°è¿˜è¦å¤šå°‘æ­¥
                this.neighbors = []; // æˆ‘çš„é‚»å±…æ˜¯è°
                this.previous = undefined; // æˆ‘æ˜¯ä»å“ªä¸ªæ ¼å­èµ°è¿‡æ¥çš„
                this.wall = false; // æˆ‘æ˜¯ä¸æ˜¯å¢™
            }
            // é‡ç½®æ ¼å­çš„æ•°æ® (ä¸ºäº†ä¸‹ä¸€æ¬¡å¯»è·¯)
            reset() {
                this.f = this.g = this.h = 0;
                this.previous = undefined;
                this.wall = false;
            }
            // æ‰¾é‚»å±… (åˆ¤æ–­ä¸Šä¸‹å·¦å³æœ‰æ²¡æœ‰å‡ºç•Œ)
            addNeighbors(grid) {
                let i = this.i, j = this.j;
                if (i < COLS - 1) this.neighbors.push(grid[i + 1][j]); // å³
                if (i > 0)        this.neighbors.push(grid[i - 1][j]); // å·¦
                if (j < ROWS - 1) this.neighbors.push(grid[i][j + 1]); // ä¸‹
                if (j > 0)        this.neighbors.push(grid[i][j - 1]); // ä¸Š
            }
        }

    </script>
</body>
</html>